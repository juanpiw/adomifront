<div class="pc-card" [class.pc-card--success]="data.successHighlight">
  <p class="pc-kicker" [class.pc-kicker--paid]="data.successHighlight || data.verification_code">
    {{ (data.successHighlight || data.verification_code)
      ? 'CITA PAGADA'
      : (data.paymentPreference === 'cash' ? 'CITA CONFIRMADA (PAGO EN EFECTIVO)' : 'TU PRÓXIMA CITA (CONFIRMADA)') }}
  </p>
  <div class="pc-row">
    <div class="pc-col">
      <p class="pc-title">{{ data.titulo }}</p>
      <div class="pc-meta">
        <span class="pc-meta-item">
          <svg class="pc-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          {{ data.fecha }}
        </span>
        <span class="pc-meta-item">
          <svg class="pc-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          {{ data.hora }}
        </span>
        <span *ngIf="data.precio !== undefined && data.precio !== null" class="pc-meta-item">
          <svg class="pc-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/></svg>
          ${{ data.precio | number:'1.0-0' }}
        </span>
      </div>
    </div>
    <div class="pc-count">
      <p class="pc-days">{{ data.diasRestantes }}</p>
      <p class="pc-days-label">días restantes</p>
    </div>
  </div>
  <!-- Advertencia de límite de efectivo -->
  <div *ngIf="data.mostrarPagar && data.precio && data.precio > (data.cashCap ?? 150000)" class="pc-cash-limit-warning">
    <div class="pc-cash-limit-warning__icon">💳</div>
    <div class="pc-cash-limit-warning__content">
      <div class="pc-cash-limit-warning__title">Solo pago con tarjeta</div>
      <div class="pc-cash-limit-warning__text">Por el momento no podemos procesar pagos en efectivo de {{ data.cashCapLabel || ('$' + ((data.cashCap ?? 150000) | number:'1.0-0')) }} o más. Este servicio debe pagarse con tarjeta.</div>
    </div>
  </div>

  <div class="pc-actions">
    <button class="pc-btn primary" (click)="onContactarClick()" [disabled]="data.mostrarPagar" title="{{ data.mostrarPagar ? 'Disponible luego del pago' : '' }}">Contactar</button>
    <button class="pc-btn secondary" (click)="onReprogramarClick()">Reprogramar</button>
    <button class="pc-btn danger" (click)="onCancelarClick()">Cancelar Cita</button>
    <button *ngIf="data.mostrarPagar" class="pc-btn primary" (click)="onPagarClick()">Pagar</button>
    <span *ngIf="data.mostrarPagar && data.paymentPreference" class="pc-pref-pill" [class.pc-pref-pill--cash]="data.paymentPreference==='cash'" [class.pc-pref-pill--card]="data.paymentPreference==='card'">
      {{ data.paymentPreference==='cash' ? 'Efectivo por defecto' : 'Tarjeta por defecto' }}
    </span>
    <button *ngIf="!data.mostrarPagar && data.verification_code && !data.refundRequested && data.paymentPreference!=='cash'" class="pc-btn" (click)="onRefundClick()">Pedir devolución</button>
    <span *ngIf="data.refundRequested" style="color:#0e7490; font-weight:600; margin-left:8px;">Solicitud en proceso</span>
  </div>

  <!-- Recordatorio de pago en efectivo -->
  <div *ngIf="data.paymentPreference==='cash'" class="pc-reminder">
    <div class="pc-reminder__icon">⚠️</div>
    <div>
      <div class="pc-reminder__title">Recordatorio de Pago</div>
      <div class="pc-reminder__text">El pago de esta cita se realiza en efectivo, directamente al profesional al finalizar el servicio.</div>
    </div>
  </div>

  <!-- Código de verificación (tarjeta o efectivo). En efectivo se muestra desde la selección. -->
  <div *ngIf="data.verification_code" style="margin-top:12px;">
    <div *ngIf="data.paymentPreference==='cash'" style="font-size:13px;color:#6b7280;margin-bottom:6px;">
      Importante: paga en efectivo al finalizar y <strong>entrega este código</strong> al profesional.
    </div>
    <ui-verificacion-code-card [code]="data.verification_code"></ui-verificacion-code-card>
  </div>

  <!-- Área de devolución -->
  <div *ngIf="showRefundArea" style="margin-top:12px;">
    <div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:12px;">
      <div style="font-weight:600;margin-bottom:8px;">Solicitar devolución</div>
      <textarea [(ngModel)]="refundReason" rows="3" placeholder="Describe el motivo de la devolución (mínimo 10 caracteres)" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="pc-btn primary" (click)="submitRefund()">Enviar solicitud</button>
        <button class="pc-btn" (click)="showRefundArea=false">Cancelar</button>
      </div>
    </div>
  </div>
</div>







