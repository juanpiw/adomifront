<div class="pc-card" [class.pc-card--success]="data.successHighlight">
  <p class="pc-kicker" [class.pc-kicker--paid]="data.successHighlight || data.verification_code">
    {{ (data.successHighlight || data.verification_code)
      ? 'CITA PAGADA'
      : (data.clientConfirmed
        ? 'SERVICIO CONFIRMADO (PAGO PENDIENTE)'
        : (data.paymentPreference === 'cash' ? 'CITA CONFIRMADA (PAGO EN EFECTIVO)' : 'TU PR√ìXIMA CITA (CONFIRMADA)')) }}
  </p>
  <div class="pc-row">
    <div class="pc-col">
      <p class="pc-title">{{ data.titulo }}</p>
      <div class="pc-meta">
        <span class="pc-meta-item">
          <svg class="pc-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          {{ data.fecha }}
        </span>
        <span class="pc-meta-item">
          <svg class="pc-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          {{ data.hora }}
        </span>
        <span *ngIf="data.precio !== undefined && data.precio !== null" class="pc-meta-item">
          <svg class="pc-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/></svg>
          ${{ data.precio | number:'1.0-0' }}
        </span>
      </div>
    </div>
    <div class="pc-count">
      <p class="pc-days">{{ data.diasRestantes }}</p>
      <p class="pc-days-label">d√≠as restantes</p>
    </div>
  </div>

  <div *ngIf="data.paymentStatusLabel" class="pc-status-pill">
    {{ data.paymentStatusLabel }}
  </div>

  <p *ngIf="data.allowReprogram === false && data.reprogramDisabledReason" class="pc-hint">
    {{ data.reprogramDisabledReason }}
  </p>
  <p *ngIf="!data.successHighlight && !data.verification_code && !data.clientConfirmed" class="pc-hint pc-hint--info">
    Confirma que el servicio se realiz√≥ para habilitar el pago.
  </p>
  <p *ngIf="!data.successHighlight && !data.verification_code && data.clientConfirmed && data.mostrarPagar" class="pc-hint pc-hint--info">
    Servicio confirmado. Selecciona c√≥mo pagar√°s para completar el cobro.
  </p>
  <!-- Advertencia de l√≠mite de efectivo -->
  <div *ngIf="data.mostrarPagar && data.precio && data.precio > (data.cashCap ?? 150000)" class="pc-cash-limit-warning">
    <div class="pc-cash-limit-warning__icon">üí≥</div>
    <div class="pc-cash-limit-warning__content">
      <div class="pc-cash-limit-warning__title">Solo pago con tarjeta</div>
      <div class="pc-cash-limit-warning__text">Por el momento no podemos procesar pagos en efectivo de {{ data.cashCapLabel || ('$' + ((data.cashCap ?? 150000) | number:'1.0-0')) }} o m√°s. Este servicio debe pagarse con tarjeta.</div>
    </div>
  </div>

  <!-- M√©todo de pago -->
  <div *ngIf="data.mostrarPagar" class="pc-pay-box">
    <div class="pc-pay-box__alert">
      <div class="pc-pay-box__icon">‚ö†Ô∏è</div>
      <div>
        <div class="pc-pay-box__title">Pago pendiente de confirmaci√≥n</div>
        <div class="pc-pay-box__text">Selecciona c√≥mo pagar√°s este servicio para confirmar tu asistencia.</div>
      </div>
    </div>

    <div class="pc-pay-options">
      <button
        class="pc-pay-card"
        [class.pc-pay-card--active]="selectedMethod === 'card'"
        (click)="onSelectMethod('card')">
        <div class="pc-pay-card__badge" *ngIf="selectedMethod === 'card'">
          <span class="dot"></span>
        </div>
        <div class="pc-pay-card__icon pc-pay-card__icon--card">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
        </div>
        <div>
          <div class="pc-pay-card__title">Webpay / Tarjeta</div>
          <div class="pc-pay-card__text">Pago seguro inmediato</div>
        </div>
      </button>

      <button
        class="pc-pay-card"
        [class.pc-pay-card--active]="selectedMethod === 'cash'"
        (click)="onSelectMethod('cash')">
        <div class="pc-pay-card__badge" *ngIf="selectedMethod === 'cash'">
          <span class="dot"></span>
        </div>
        <div class="pc-pay-card__icon pc-pay-card__icon--cash">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
        </div>
        <div>
          <div class="pc-pay-card__title">Efectivo</div>
          <div class="pc-pay-card__text">Pagas directo al profesional</div>
        </div>
      </button>
    </div>

    <div class="pc-actions pc-actions--split">
      <button class="pc-btn primary ghost" (click)="onContactarClick()">
        Contactar
      </button>
    <button *ngIf="!isPaid" class="pc-btn secondary ghost" (click)="onReprogramarClick()" [disabled]="data.allowReprogram === false" [title]="data.allowReprogram === false ? (data.reprogramDisabledReason || 'Solo puedes reprogramar antes de confirmar el servicio') : ''">
        Reprogramar
      </button>
      <button *ngIf="!isPaid" class="pc-btn danger ghost" (click)="onCancelarClick()">Cancelar Cita</button>
      <div class="pc-confirm-hint">
        <div class="pc-confirm-hint__title">Confirma solo cuando el servicio ya se realiz√≥</div>
        <div class="pc-confirm-hint__text">Al confirmar indicas que recibiste el servicio y est√°s conforme.</div>
      </div>
      <button class="pc-btn primary pay-cta" (click)="onPrimaryAction()">
        {{ primaryCtaLabel }}
      </button>
    </div>
  </div>

  <!-- Acciones cuando no hay pago pendiente -->
  <div class="pc-actions" *ngIf="!data.mostrarPagar">
    <button class="pc-btn primary" (click)="onContactarClick()">Contactar</button>
    <button *ngIf="!isPaid" class="pc-btn secondary" (click)="onReprogramarClick()" [disabled]="data.allowReprogram === false" [title]="data.allowReprogram === false ? (data.reprogramDisabledReason || 'Disponible cuando la cita est√© pagada') : ''">
      Reprogramar
    </button>
    <button *ngIf="!isPaid" class="pc-btn danger" (click)="onCancelarClick()">Cancelar Cita</button>
    <button *ngIf="data.canConfirmService" class="pc-btn primary" (click)="onFinalizarClick()">
      Confirmar servicio
    </button>
    <button *ngIf="data.canReport" class="pc-btn danger" (click)="onReportarClick()">
      Reportar problema
    </button>
    <button *ngIf="!data.mostrarPagar && data.verification_code && !data.refundRequested && data.paymentPreference!=='cash'" class="pc-btn" (click)="onRefundClick()">Pedir devoluci√≥n</button>
    <span *ngIf="data.refundRequested" style="color:#0e7490; font-weight:600; margin-left:8px;">Solicitud en proceso</span>
  </div>

  <!-- Recordatorio de pago en efectivo -->
  <div *ngIf="data.paymentPreference==='cash'" class="pc-reminder">
    <div class="pc-reminder__icon">‚ö†Ô∏è</div>
    <div>
      <div class="pc-reminder__title">Recordatorio de Pago</div>
      <div class="pc-reminder__text">El pago de esta cita se realiza en efectivo, directamente al profesional al finalizar el servicio.</div>
    </div>
  </div>

  <!-- C√≥digo de verificaci√≥n (tarjeta o efectivo). En efectivo se muestra desde la selecci√≥n. -->
  <div *ngIf="data.verification_code" style="margin-top:12px;">
    <div *ngIf="data.paymentPreference==='cash'" style="font-size:13px;color:#6b7280;margin-bottom:6px;">
      Importante: paga en efectivo al finalizar y <strong>entrega este c√≥digo</strong> al profesional.
    </div>
    <ui-verificacion-code-card [code]="data.verification_code"></ui-verificacion-code-card>
  </div>

  <!-- √Årea de devoluci√≥n -->
  <div *ngIf="showRefundArea" style="margin-top:12px;">
    <div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:12px;">
      <div style="font-weight:600;margin-bottom:8px;">Solicitar devoluci√≥n</div>
      <textarea [(ngModel)]="refundReason" rows="3" placeholder="Describe el motivo de la devoluci√≥n (m√≠nimo 10 caracteres)" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="pc-btn primary" (click)="submitRefund()">Enviar solicitud</button>
        <button class="pc-btn" (click)="showRefundArea=false">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: bloquear confirmaci√≥n/pago antes de la fecha/hora -->
<div class="pc-too-early-backdrop" *ngIf="tooEarlyModalOpen">
  <div class="pc-too-early-backdrop__overlay" (click)="closeTooEarlyModal()"></div>
  <div class="pc-too-early-modal" role="dialog" aria-modal="true" aria-labelledby="pcTooEarlyTitle">
    <header class="pc-too-early-modal__header">
      <h4 id="pcTooEarlyTitle">{{ tooEarlyModalTitle }}</h4>
      <button type="button" class="pc-too-early-modal__close" (click)="closeTooEarlyModal()" aria-label="Cerrar">‚úï</button>
    </header>
    <section class="pc-too-early-modal__body">
      <p class="pc-too-early-modal__text">{{ tooEarlyModalMessage }}</p>
    </section>
    <footer class="pc-too-early-modal__footer">
      <button type="button" class="pc-btn primary" (click)="closeTooEarlyModal()">Entendido</button>
    </footer>
  </div>
</div>







