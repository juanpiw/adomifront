<div class="quotes-form" *ngIf="quote">
  <section class="quotes-form__request">
    <div class="quotes-form__request-card">
      <ui-client-request-panel
        [quote]="quote"
        [enableChat]="false"
        (chat)="chat.emit()"
      ></ui-client-request-panel>

      <div class="quotes-form__mini-grid">
        <div class="quotes-form__mini-card">
          <span>Servicio</span>
          <strong>{{ quote.serviceName }}</strong>
        </div>
        <div class="quotes-form__mini-card">
          <span>Solicitado</span>
          <strong>{{ quote.requestedAt | date : 'dd MMM yyyy' : undefined : 'es-CL' }}</strong>
        </div>
        <div class="quotes-form__mini-card" *ngIf="requestedTimeLabel">
          <span>Hora solicitada</span>
          <strong>{{ requestedTimeLabel }}</strong>
        </div>
        <div class="quotes-form__mini-card" *ngIf="quote.amount || quote.proposal?.amount">
          <span>Último monto</span>
          <strong>
            {{
              (quote.amount ?? quote.proposal?.amount)
                | currency: (quote.currency || quote.proposal?.currency || 'CLP'):'symbol-narrow':'1.0-0':'es-CL'
            }}
          </strong>
        </div>
      </div>

      <div class="quotes-form__accepted-banner" *ngIf="canManageAppointment">
        <div class="quotes-form__accepted-info">
          <strong>Cotización aceptada</strong>
          <p>Agenda la cita para coordinar fecha y dejarla como confirmada en tu calendario.</p>
        </div>
        <button type="button" class="btn btn-manage" (click)="manageAppointment.emit(quote)">
          Gestionar cita
        </button>
      </div>
    </div>
  </section>

  <section class="quotes-form__section quotes-form__proposal">
    <header class="quotes-form__section-header">
      <h3>Tu propuesta</h3>
      <p>Completa los detalles que recibirá el cliente antes de aceptar la cotización.</p>
    </header>

    <form [formGroup]="form" class="quotes-form__form" (ngSubmit)="onSubmit()">
      <div class="quotes-form__field-group">
        <label for="amount">Monto total (CLP)</label>
        <div class="quotes-form__currency-input">
          <span>$</span>
          <input
            id="amount"
            type="text"
            formControlName="amount"
            min="1000"
            placeholder="2.500.000"
            [value]="formattedAmount"
            (input)="onAmountInput($event)"
            inputmode="numeric"
          />
        </div>
        <small *ngIf="form.controls.amount.invalid && form.controls.amount.touched" class="quotes-form__error">
          Ingresa un monto válido mayor a $1.000
        </small>
      </div>

      <div class="quotes-form__field-group">
        <label for="validity">Validez de la oferta</label>
        <select id="validity" formControlName="validity">
          <option *ngFor="let option of validityOptions" [value]="option">{{ option }}</option>
        </select>
      </div>

      <div class="quotes-form__field-group quotes-form__field-group--full">
        <label for="details">
          Detalle (qué incluye la cotización)
          <span>Esto será visible para el cliente</span>
        </label>
        <textarea
          id="details"
          rows="8"
          formControlName="details"
          placeholder="- Materiales incluidos…&#10;- Garantías ofrecidas…&#10;- Consideraciones importantes…"
        ></textarea>
        <small *ngIf="form.controls.details.invalid && form.controls.details.touched" class="quotes-form__error">
          Describe la propuesta con al menos 20 caracteres.
        </small>
      </div>

      <div class="quotes-form__attachments quotes-form__field-group--full">
        <span class="quotes-form__attachments-label">Adjuntar archivos (opcional)</span>
        <ui-dropzone-card
          label="Sube PDF, JPG o PNG"
          description="Arrastra tus documentos o haz clic para seleccionarlos"
          (filesDropped)="onFilesDropped($event)"
        ></ui-dropzone-card>
        <div class="quotes-form__attachments-list" *ngIf="attachmentPreviews.length; else noAttachments">
          <div
            class="quotes-form__attachment-pill"
            *ngFor="let attachment of attachmentPreviews; trackBy: trackAttachment"
            [class.quotes-form__attachment-pill--uploading]="attachment.status === 'uploading'"
          >
            <div class="quotes-form__attachment-icon">
              <ui-icon
                [name]="attachment.status === 'uploading' ? 'cloud-upload' : 'file-text'"
                [size]="16"
              ></ui-icon>
            </div>
            <div class="quotes-form__attachment-info">
              <span class="quotes-form__attachment-name">{{ attachment.name }}</span>
              <small class="quotes-form__attachment-meta">
                {{ formatFileSize(attachment.size) }}
                <span *ngIf="attachment.status === 'uploading'">• Subiendo…</span>
              </small>
            </div>
          </div>
        </div>
        <ng-template #noAttachments>
          <p class="quotes-form__attachments-empty">Aún no adjuntas archivos.</p>
        </ng-template>
      </div>

      <footer class="quotes-form__actions">
        <button type="button" class="btn btn-secondary" (click)="onSaveDraft()" [disabled]="loading">
          <ui-icon name="inbox" [size]="18"></ui-icon>
          Guardar borrador
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="loading">
          <ui-icon name="paper-plane" [size]="18"></ui-icon>
          Enviar cotización
        </button>
      </footer>
    </form>
  </section>
</div>


