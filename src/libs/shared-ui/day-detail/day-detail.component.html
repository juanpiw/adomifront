<aside class="day-detail">
  <div class="day-detail__header">
    <span class="day-detail__day">{{ selectedDayNumber }}</span>
    <div class="day-detail__meta">
      <p class="day-detail__pro">{{ professionalName }}</p>
      <p class="day-detail__date">{{ selectedDateFormatted }}</p>
      <p class="day-detail__slug">{{ selectedDateSlug }}</p>
    </div>
  </div>

  <div class="day-detail__banner" *ngIf="quoteFocusBanner">
    <div>
      <strong>{{ quoteFocusBanner.serviceName || 'Cita desde cotizaci√≥n' }}</strong>
      <p class="day-detail__banner-meta">
        {{ quoteFocusBanner.clientName || 'Cliente' }}
        <span *ngIf="quoteFocusBanner.time">‚Ä¢ {{ quoteFocusBanner.time }}</span>
      </p>
      <p *ngIf="quoteFocusBanner.message" class="day-detail__banner-message">
        ‚Äú{{ quoteFocusBanner.message }}‚Äù
      </p>
    </div>
    <button type="button" class="day-detail__banner-close" (click)="dismissQuoteFocus()" aria-label="Cerrar recordatorio">
      ‚úï
    </button>
  </div>

  <div class="day-detail__list">
    <!-- Estado vac√≠o -->
    <div *ngIf="!hasAppointments && !loading" class="day-detail__empty">
      <span class="day-detail__emoji">üìÖ</span>
      <p class="day-detail__empty-text">Seleccione un d√≠a para ver sus citas.</p>
    </div>

    <!-- Estado de carga -->
    <div *ngIf="loading" class="day-detail__loading">
      <div class="day-detail__loading-spinner"></div>
      <p class="day-detail__loading-text">Cargando citas...</p>
    </div>

    <!-- Lista de citas -->
    <div *ngIf="hasAppointments && !loading" class="day-detail__appointments">
      <div 
        *ngFor="let appointment of sortedAppointments; trackBy: trackByAppointmentId"
        class="day-detail__appointment"
        [class.day-detail__appointment--cancelled]="appointment.status === 'cancelled'"
        [class.day-detail__appointment--highlight]="isHighlighted(appointment)"
        (click)="onAppointmentClick(appointment)">
        
        <div class="day-detail__appointment-header">
          <div class="day-detail__appointment-time">
            <span class="day-detail__appointment-icon">{{ getTypeIcon(appointment.type) }}</span>
            <span class="day-detail__appointment-time-text">{{ appointment.time }}</span>
          </div>
          <div 
            class="day-detail__appointment-status"
            [style.background-color]="getStatusColor(appointment.status)">
            {{ getStatusText(appointment.status) }}
          </div>
        </div>

        <div class="day-detail__appointment-content">
          <h4 class="day-detail__appointment-title">{{ appointment.title }}</h4>
          <button type="button" class="day-detail__appointment-client" (click)="onClientClick($event, appointment)">
            <span
              class="day-detail__client-avatar"
              [class.day-detail__client-avatar--placeholder]="!appointment.clientAvatarUrl"
              [class.day-detail__client-avatar--fallback]="!appointment.clientAvatarUrl"
            >
              <img
                loading="lazy"
                [src]="appointment.clientAvatarUrl || fallbackAvatar"
                [alt]="appointment.clientName || 'Cliente'"
                (error)="onClientAvatarError($event, appointment)"
              />
              <span class="day-detail__client-initials">
                {{ getClientInitials(appointment.clientName) }}
              </span>
            </span>
            <span class="day-detail__client-name">{{ appointment.clientName }}</span>
          </button>
          <p *ngIf="appointment.locationLabel" class="day-detail__appointment-location">
            <span class="day-detail__appointment-location-icon">üìç</span>
            <span class="day-detail__appointment-location-text">{{ appointment.locationLabel }}</span>
          </p>
          <p *ngIf="!appointment.locationLabel" class="day-detail__appointment-location day-detail__appointment-location--empty">
            <span class="day-detail__appointment-location-icon">üìç</span>
            <span class="day-detail__appointment-location-text">Direcci√≥n no registrada</span>
          </p>
          <p *ngIf="appointment.clientPhone" class="day-detail__appointment-phone">
            üìû {{ appointment.clientPhone }}
          </p>
          <p class="day-detail__appointment-duration">
            ‚è±Ô∏è {{ appointment.duration }} minutos
          </p>
          <p *ngIf="appointment.notes" class="day-detail__appointment-notes">
            {{ appointment.notes }}
          </p>
          <div *ngIf="appointment.canReviewClient" class="day-detail__review-action">
            <button type="button"
                    class="day-detail__action-btn day-detail__action-btn--secondary"
                    (click)="onClientReviewClick($event, appointment)">
              Calificar cliente
            </button>
          </div>
          <div *ngIf="appointment.status === 'cancelled'" class="day-detail__cancelled-message">
            Cancelada {{ appointment.cancelledBy === 'client' ? 'por el cliente' : (appointment.cancelledBy === 'provider' ? 'por ti' : 'autom√°ticamente') }}
            <span *ngIf="appointment.cancellationReason"> ‚Ä¢ {{ appointment.cancellationReason }}</span>
          </div>
          <div *ngIf="appointment.status === 'expired'" class="day-detail__cancelled-message">
            Expirada autom√°ticamente por falta de confirmaci√≥n en 24 horas.
          </div>
          <div *ngIf="appointment.paymentMethod==='cash'" class="day-detail__payment-chip">Pago en efectivo</div>
          <div *ngIf="appointment.status === 'confirmed'" class="day-detail__appointment-status" 
               [style.background-color]="getStatusColor('confirmed')"
               style="margin-top:6px;">
            {{ getStatusText('confirmed') }}
          </div>
          <div *ngIf="appointment.status === 'confirmed'" class="day-detail__appointment-status" 
               [style.background-color]="getPaymentStatusColor(appointment.paymentStatus)"
               style="margin-top:4px;">
            {{ getPaymentStatusText(appointment.paymentStatus) }}
          </div>

          <div *ngIf="appointment.closureState === 'pending_close'" class="day-detail__closure">
            <div class="day-detail__closure-badge">Pendiente de cierre mutuo</div>
            <p class="day-detail__closure-text">
              Resuelve antes de {{ appointment.closureDueAt ? (appointment.closureDueAt | date:'dd/MM HH:mm') : '24h' }}.
            </p>
            <div *ngIf="appointment.closureProviderAction === 'none'" class="day-detail__closure-actions">
              <button class="day-detail__closure-btn day-detail__closure-btn--primary" (click)="onVerifyClosure($event, appointment)">Ingresar c√≥digo</button>
              <button class="day-detail__closure-btn" (click)="onClosureAction($event, appointment, 'no_show')">Cliente no asisti√≥</button>
              <button class="day-detail__closure-btn" (click)="onClosureAction($event, appointment, 'issue')">Reportar problema</button>
            </div>
            <p *ngIf="appointment.closureProviderAction !== 'none'" class="day-detail__closure-note">
              Registraste: {{ getClosureProviderActionLabel(appointment.closureProviderAction) }}.
            </p>
          </div>

          <div class="day-detail__appointment-actions" *ngIf="appointment.status !== 'cancelled' && appointment.status !== 'expired'">
            <button *ngIf="appointment.status === 'scheduled'" class="day-detail__action-btn day-detail__action-btn--confirm" (click)="onConfirmClick($event, appointment)">Confirmar</button>
            <button class="day-detail__action-btn day-detail__action-btn--delete" (click)="onDeleteClick($event, appointment)">Cancelar</button>
          </div>

          <!-- Evidencia: geolocalizaci√≥n del proveedor (check-in/out, sin tracking continuo) -->
          <div
            class="day-detail__geo"
            *ngIf="appointment.type === 'appointment' && appointment.status === 'confirmed'">
            <app-provider-location-checkin-button
              [appointmentId]="+appointment.id"
              [destinationLabel]="appointment.locationLabel"
              eventType="arrive"
              label="Llegu√©">
            </app-provider-location-checkin-button>
            <app-provider-location-checkin-button
              [appointmentId]="+appointment.id"
              [destinationLabel]="appointment.locationLabel"
              eventType="finish"
              label="Termin√©">
            </app-provider-location-checkin-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bot√≥n para nueva cita -->
    <div *ngIf="selectedDate && !loading" class="day-detail__actions">
      <button 
        class="day-detail__new-appointment"
        (click)="onNewAppointment()">
        üîí Bloquear Espacio
      </button>
    </div>
  </div>
</aside>

<!-- Modal para Bloquear Espacio -->
<app-modal-agendar-cita
  [isOpen]="isModalOpen"
  [selectedDate]="selectedDate || undefined"
  [mode]="modalMode"
  [presetData]="modalPresetData"
  [services]="services"
  (close)="onCloseModal()"
  (citaCreated)="onCitaCreated($event)"
  (espacioBloqueado)="onEspacioBloqueado($event)">
</app-modal-agendar-cita>
