<div *ngIf="isOpen" class="modal-backdrop" (click)="onBackdropClick($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <div class="modal-header__icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 8v4"/>
          <path d="M12 16h.01"/>
          <path d="M8 12h.01"/>
          <path d="M16 12h.01"/>
        </svg>
      </div>
      <h2 class="modal-title">Verificar Servicio Completado</h2>
    </div>
    
    <!-- Body -->
    <div class="modal-body">
      <!-- Información de la cita -->
      <div class="appointment-info" *ngIf="appointment">
        <div class="appointment-info__row">
          <span class="appointment-info__label">Cliente:</span>
          <span class="appointment-info__value">{{ appointment.client_name || 'No especificado' }}</span>
        </div>
        <div class="appointment-info__row">
          <span class="appointment-info__label">Servicio:</span>
          <span class="appointment-info__value">{{ appointment.service_name || 'No especificado' }}</span>
        </div>
        <div class="appointment-info__row">
          <span class="appointment-info__label">Monto:</span>
          <span class="appointment-info__value">${{ appointment.amount || appointment.price || 0 | number:'1.0-0' }}</span>
        </div>
        <div class="appointment-info__row">
          <span class="appointment-info__label">Fecha:</span>
          <span class="appointment-info__value">{{ formattedDate }}</span>
        </div>
        <div class="appointment-info__row">
          <span class="appointment-info__label">Hora:</span>
          <span class="appointment-info__value">{{ (appointment.start_time || '').slice(0,5) }}</span>
        </div>
      </div>
      
      <!-- Instrucciones -->
      <p class="instructions">
        Pide al cliente su código de verificación de 4 dígitos:
      </p>
      
      <!-- Inputs de código -->
      <div class="code-inputs">
        <input 
          #codeInput
          *ngFor="let digit of codeDigits; let i = index; trackBy: trackByIndex"
          type="text" 
          maxlength="1"
          inputmode="numeric"
          pattern="\d"
          [value]="digit"
          (input)="onCodeInput(i, $event)"
          (keydown)="onKeyDown(i, $event)"
          (paste)="onPaste($event)"
          (focus)="onFocus(i, $event)"
          [disabled]="verifying"
          class="code-input"
          [class.code-input--filled]="digit"
          [class.code-input--disabled]="verifying"
          autocomplete="one-time-code"
          aria-label="Dígito {{ i + 1 }} del código"
        />
      </div>
      
      <!-- Mensaje de intentos restantes -->
      <p class="attempts-warning" *ngIf="remainingAttempts < 3">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="attempts-warning__icon">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        Intentos restantes: {{ remainingAttempts }}/3
      </p>
      
      <!-- Mensaje de error -->
      <div class="error-message" *ngIf="errorMessage && !verifying">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="error-message__icon">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
        <p>{{ errorMessage }}</p>
      </div>
      
      <!-- Información adicional -->
      <div class="info-box">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="info-box__icon">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 16v-4"></path>
          <path d="M12 8h.01"></path>
        </svg>
        <p *ngIf="appointment?.payment_method==='cash'" class="info-box__text">
          Si el código es correcto, el servicio se marcará como completado y deberás depositar la comisión a la plataforma según los plazos indicados.
        </p>
        <p *ngIf="appointment?.payment_method!=='cash'" class="info-box__text">
          Si el código es correcto, el servicio se marcará como completado y recibirás el pago en 1-3 días hábiles.
        </p>
        <ul *ngIf="appointment?.payment_method==='cash'" class="info-box__list">
          <li><strong>T+1h</strong>: se activa cierre mutuo para pagos en efectivo.</li>
          <li><strong>T+12h</strong>: recordatorio automático si sigue pendiente.</li>
          <li><strong>T+25h</strong>: auto-resolución según la matriz de acciones.</li>
        </ul>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="modal-footer">
      <button 
        type="button"
        class="modal-btn modal-btn--secondary" 
        (click)="onCancel()"
        [disabled]="verifying">
        Cancelar
      </button>
      <button 
        type="button"
        class="modal-btn modal-btn--primary" 
        (click)="onVerify()"
        [disabled]="!isCodeComplete() || verifying">
        <svg *ngIf="!verifying" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="modal-btn__icon">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <svg *ngIf="verifying" class="modal-btn__spinner" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/>
          <path d="M12 2a10 10 0 0110 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round"/>
        </svg>
        <span *ngIf="!verifying">Verificar</span>
        <span *ngIf="verifying">Verificando...</span>
      </button>
    </div>
  </div>
</div>

