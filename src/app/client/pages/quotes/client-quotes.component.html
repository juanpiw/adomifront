<section class="client-quotes-page">
  <ui-quotes-header
    title="Mis Cotizaciones"
    subtitle="Consulta el estado de tus solicitudes y revisa las propuestas enviadas por los profesionales."
  ></ui-quotes-header>

  <ui-quotes-tabs
    [tabs]="tabs()"
    [activeTabId]="activeTab()"
    (tabChange)="onTabChange($event)"
  ></ui-quotes-tabs>

  <div *ngIf="error() as errorMsg" class="client-quotes-page__error" role="alert">
    {{ errorMsg }}
  </div>

  <div class="client-quotes-page__layout">
    <ui-quotes-grid
      class="client-quotes-page__grid"
      [quotes]="quotes()"
      [emptyTitle]="'Sin cotizaciones todavía'"
      [emptyDescription]="'Cuando solicites una cotización aparecerá aquí para hacer seguimiento.'"
      [enableChat]="false"
      (action)="onQuoteAction($event)"
    ></ui-quotes-grid>

    <aside class="client-quotes-page__detail" aria-live="polite">
      <ng-container *ngIf="selectedQuote() as quote; else detailPlaceholder">
        <div class="detail-card">
          <div class="detail-card__provider">
            <img
              class="detail-card__avatar"
              [src]="quote.provider?.avatarUrl || providerPlaceholder(quote.provider?.name)"
              [alt]="quote.provider?.name || 'Profesional Adomi'"
            />
            <div>
              <h3>{{ quote.provider?.name || 'Profesional Adomi' }}</h3>
              <p *ngIf="safeDate(quote.provider?.memberSince) as memberSinceDate">
                En Adomi desde {{ memberSinceDate | date : 'MMMM yyyy' : undefined : 'es-CL' }}
              </p>
            </div>
          </div>

          <p class="detail-card__service">
            Servicio: <strong>{{ quote.serviceName }}</strong>
          </p>

          <div class="detail-card__message" *ngIf="quote.message">
            “{{ quote.message }}”
          </div>

          <div class="detail-card__proposal" *ngIf="hasProposalAmount(quote) || getProposalValidUntil(quote)">
            <div>
              <span>Monto propuesto</span>
              <strong *ngIf="hasProposalAmount(quote); else pendingAmount">
                {{ getProposalAmount(quote) | currency: getProposalCurrency(quote):'symbol-narrow':'1.0-0':'es-CL' }}
              </strong>
              <ng-template #pendingAmount>
                <em class="detail-card__muted">El profesional aún no envía un monto.</em>
              </ng-template>
            </div>
            <div *ngIf="safeDate(getProposalValidUntil(quote)) as validUntilDate">
              <span>Válida hasta</span>
              <strong>{{ validUntilDate | date : 'dd MMM yyyy' : undefined : 'es-CL' }}</strong>
            </div>
          </div>

          <div class="detail-card__proposal-details" *ngIf="quote.proposal?.details">
            <h4>Detalle de la propuesta</h4>
            <p>{{ quote.proposal?.details }}</p>
          </div>

          <div class="detail-card__items" *ngIf="quote.items?.length">
            <h4>Conceptos incluidos</h4>
            <div class="detail-card__items-list">
              <div class="detail-card__item" *ngFor="let item of quote.items">
                <div>
                  <strong>{{ item.title || 'Concepto' }}</strong>
                  <p *ngIf="item.description">{{ item.description }}</p>
                </div>
                <div class="detail-card__item-meta">
                  <span *ngIf="item.quantity">x{{ item.quantity }}</span>
                  <strong *ngIf="item.totalPrice">
                    {{ item.totalPrice | currency: getProposalCurrency(quote):'symbol-narrow':'1.0-0':'es-CL' }}
                  </strong>
                </div>
              </div>
            </div>
          </div>

          <div class="detail-card__attachments" *ngIf="quote.attachments?.length">
            <h4>Archivos adjuntos</h4>
            <ul>
              <li *ngFor="let attachment of quote.attachments">
                <a [href]="attachment.url || '#'" target="_blank" rel="noopener">
                  {{ attachment.name || 'Archivo adjunto' }}
                </a>
                <span *ngIf="formatFileSize(attachment.size)">· {{ formatFileSize(attachment.size) }}</span>
              </li>
            </ul>
          </div>

          <div class="detail-card__actions">
            <button type="button" class="detail-card__btn detail-card__btn--primary" [disabled]="!quote.proposal?.amount">
              Aceptar y continuar
            </button>
          </div>
        </div>
      </ng-container>

      <ng-template #detailPlaceholder>
        <div class="detail-placeholder">
          <h3>Selecciona una cotización</h3>
          <p>Elige una solicitud para ver la propuesta del profesional y sus próximos pasos.</p>
        </div>
      </ng-template>
    </aside>
  </div>
</section>

