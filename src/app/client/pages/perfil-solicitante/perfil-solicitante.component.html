<div class="perfil-container">
  <div class="perfil-wrapper">
    <header class="perfil-header">
      <h1 class="perfil-title">Perfil del Cliente</h1>
      <p class="perfil-subtitle">
        Información visible solo para ti como proveedor. Úsala para preparar el servicio y registrar futuras evaluaciones.
      </p>
    </header>

    <div class="perfil-card">
      <ng-container *ngIf="loading">
        <div class="perfil-loading">
          <div class="perfil-loading__spinner"></div>
          <p>Cargando información del cliente...</p>
        </div>
      </ng-container>

      <ng-container *ngIf="!loading && error">
        <div class="perfil-error">
          <h2 class="perfil-error__title">No se pudo cargar el perfil</h2>
          <p class="perfil-error__message">{{ error }}</p>
        </div>
      </ng-container>

      <ng-container *ngIf="!loading && !error && profile">
        <div class="perfil-hero">
          <div class="perfil-avatar-container">
            <div class="perfil-avatar">
              <ng-container *ngIf="profilePhotoUrl; else avatarFallback">
                <img [src]="profilePhotoUrl" [alt]="clientName" class="perfil-avatar-img" loading="lazy">
              </ng-container>
              <ng-template #avatarFallback>
                <span class="perfil-avatar-placeholder">{{ getInitials(clientName) }}</span>
              </ng-template>
            </div>
          </div>
          <div class="perfil-info">
            <h2 class="perfil-name">{{ clientName }}</h2>
            <p class="perfil-member-since">{{ memberSinceLabel }}</p>
            <div class="perfil-verification-badge" [attr.data-state]="verificationStatusVariant">
              <span>{{ verificationStatusLabel }}</span>
            </div>
            <div class="perfil-rating" *ngIf="hasReviews; else noReviewsBadge">
              <div class="perfil-rating__score">{{ ratingAverage | number:'1.1-2' }}</div>
              <div class="perfil-rating__stars">
                <span *ngFor="let star of [1,2,3,4,5]" [class.filled]="star <= Math.round(ratingAverage)">
                  ★
                </span>
              </div>
              <div class="perfil-rating__count">
                {{ ratingCount }} reseña{{ ratingCount === 1 ? '' : 's' }}
              </div>
            </div>
            <ng-template #noReviewsBadge>
              <div class="perfil-rating perfil-rating--empty">
                <span class="perfil-rating__count">Sin reseñas de proveedores aún</span>
              </div>
            </ng-template>
          </div>
        </div>

        <hr class="perfil-divider">

        <section class="perfil-section">
          <h3 class="perfil-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" class="perfil-section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            Datos personales y contacto
          </h3>
          <div class="perfil-form-grid perfil-form-grid--readonly">
            <div class="perfil-field">
              <label class="perfil-label">Nombre completo</label>
              <div class="perfil-field-value">{{ profile.full_name || 'Dato no registrado' }}</div>
            </div>
            <div class="perfil-field">
              <label class="perfil-label">Email (privado)</label>
              <div class="perfil-field-value">{{ profile.email || 'Dato no registrado' }}</div>
            </div>
            <div class="perfil-field">
              <label class="perfil-label">Teléfono de contacto</label>
              <div class="perfil-field-value">{{ profile.phone || 'Dato no registrado' }}</div>
              <p class="perfil-field-help perfil-field-help--readonly">
                Visible solo para profesionales con citas confirmadas.
              </p>
            </div>
          </div>
        </section>

        <section class="perfil-section">
          <h3 class="perfil-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" class="perfil-section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Ubicación principal
          </h3>
          <div class="perfil-form-grid perfil-form-grid--readonly">
            <div class="perfil-field">
              <label class="perfil-label">Región</label>
              <div class="perfil-field-value">{{ profile.region || 'Dato no registrado' }}</div>
            </div>
            <div class="perfil-field">
              <label class="perfil-label">Comuna</label>
              <div class="perfil-field-value">{{ profile.commune || 'Dato no registrado' }}</div>
            </div>
            <div class="perfil-field perfil-field--full">
              <label class="perfil-label">Dirección principal</label>
              <div class="perfil-field-value">{{ profile.address || 'Dato no registrado' }}</div>
              <p class="perfil-field-help perfil-field-help--readonly">
                Usa esta referencia para planificar la visita. Confirma con el cliente si necesitas más detalles.
              </p>
            </div>
          </div>
        </section>

        <section class="perfil-section" *ngIf="showNotes">
          <h3 class="perfil-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" class="perfil-section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Notas permanentes
          </h3>
          <div class="perfil-notes">{{ profile.notes }}</div>
        </section>

        <section class="perfil-section perfil-reviews">
          <div class="perfil-section-header">
            <h3 class="perfil-section-title">
              <svg xmlns="http://www.w3.org/2000/svg" class="perfil-section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 11c0 1.105.895 2 2 2s2-.895 2-2-.895-2-2-2-2 .895-2 2zm-9 9c0-4.418 3.582-8 8-8h2c4.418 0 8 3.582 8 8v1H3v-1z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 6a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              Evaluaciones de proveedores
            </h3>
            <button type="button"
                    class="perfil-review-button"
                    (click)="openReviewModalForAppointment()"
                    [disabled]="reviewableAppointments.length === 0">
              Calificar cliente
            </button>
          </div>
          <p class="perfil-section-description">
            Registra experiencias posteriores a una cita completada para ayudar al equipo y a otros profesionales.
          </p>

          <div class="perfil-reviewable" *ngIf="reviewableAppointments.length > 0">
            <h4 class="perfil-reviewable__title">Citas pendientes de calificar</h4>
            <ul class="perfil-reviewable__list">
              <li class="perfil-reviewable__item" *ngFor="let appointment of reviewableAppointments">
                <div class="perfil-reviewable__details">
                  {{ formatReviewableAppointment(appointment) }}
                </div>
                <button type="button"
                        class="perfil-reviewable__action"
                        (click)="openReviewModalForAppointment(appointment.id)">
                  Calificar
                </button>
              </li>
            </ul>
          </div>
          <div class="perfil-reviewable perfil-reviewable--empty" *ngIf="!reviewableLoading && reviewableAppointments.length === 0">
            <p>No tienes citas completadas pendientes de calificar.</p>
            <p class="perfil-reviewable__hint">Las reseñas solo se habilitan una vez que la cita está marcada como completada.</p>
          </div>
          <div class="perfil-reviewable perfil-reviewable--loading" *ngIf="reviewableLoading">
            <div class="perfil-loading">
              <div class="perfil-loading__spinner perfil-loading__spinner--mini"></div>
              <p>Cargando citas disponibles...</p>
            </div>
          </div>

          <div class="perfil-reviews-list" *ngIf="hasReviews; else perfilNoReviews">
            <div class="perfil-reviews-loading" *ngIf="reviewLoading">
              <div class="perfil-loading__spinner perfil-loading__spinner--mini"></div>
            </div>
            <app-reviews *ngIf="!reviewLoading" [data]="reviewsData"></app-reviews>
          </div>
          <ng-template #perfilNoReviews>
            <p class="perfil-empty-state">
              Aún no registras reseñas para este cliente. Califica después de completar una cita.
            </p>
          </ng-template>
        </section>
      </ng-container>
    </div>
  </div>
</div>

<app-review-modal
  #clientReviewModal
  [isOpen]="reviewModalOpen"
  [workerName]="clientName"
  [subjectName]="clientName"
  [serviceName]="selectedReviewServiceName"
  [appointmentId]="reviewModalAppointmentId ? reviewModalAppointmentId.toString() : ''"
  [title]="'Califica al cliente'"
  [questionPrefix]="'¿Cómo fue la experiencia con'"
  [questionSuffix]="'?'"
  [submitLabel]="'Guardar reseña'"
  [submittingLabel]="'Guardando...'"
  [commentPlaceholder]="'Comparte detalles para el equipo (opcional)...'"
  [successTitle]="'¡Reseña registrada!'"
  [successMessage]="'Gracias por dejar comentarios sobre este cliente.'"
  [successButtonLabel]="'Cerrar'"
  (close)="onReviewModalClose()"
  (reviewSubmitted)="onReviewModalSubmit($event)"
></app-review-modal>

