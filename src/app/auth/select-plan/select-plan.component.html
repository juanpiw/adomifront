<div class="plan-selection-container">
  <div class="account-switch-banner" *ngIf="accountSwitchInProgress">
    <div class="banner-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.73-.626 1.18-.734l.54-1.636c.26-1.004-.322-2.016-1.34-2.28zM11.42 15.17L5.877 21m6.46-6.46l-1.127-1.127a4.5 4.5 0 00-6.364-6.364l-1.127 1.127" />
      </svg>
    </div>
    <div>
      <h4>Estás convirtiendo tu cuenta en proveedor</h4>
      <p>Completa tu plan para habilitar el dashboard profesional y empezar a recibir clientes.</p>
    </div>
  </div>

  <div class="header">
    <h1>Elige tu plan</h1>
    <p>Selecciona el plan que mejor se adapte a tus necesidades</p>

    <div class="billing-toggle-container">
      <span class="billing-label" [class.active]="!isAnnualBilling">Mensual</span>
      <button
        type="button"
        class="toggle-switch"
        role="switch"
        [attr.aria-checked]="isAnnualBilling"
        (click)="toggleBilling()"
      >
        <span class="toggle-slider"></span>
      </button>
      <span class="billing-label" [class.active]="isAnnualBilling">Anual</span>
      <span class="savings-pill">AHORRA 17%</span>
    </div>
  </div>

  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Cargando planes...</p>
  </div>

  <div *ngIf="error" class="error">
    <p>{{ error }}</p>
    <button class="btn-primary" (click)="loadPlans()">Reintentar</button>
  </div>

  <div *ngIf="!loading && !error" class="plans-grid">
    <div class="plan-card plan-card--founder" [class.plan-card--selected]="isPromoActive()">
      <div class="plan-card__badge">¡LIMITADO!</div>
      <div class="plan-card__header">
        <div>
          <h3>Fundador</h3>
          <p>Acceso exclusivo “Pioneros”</p>
        </div>
        <span class="plan-card__tag">Acceso exclusivo</span>
      </div>
      <div class="plan-card__price">
        <span class="plan-card__price-value">{{ formatPrice(0) }}</span>
        <span class="plan-card__price-interval">/ 3 meses</span>
      </div>
      <p class="plan-card__description">
        Lanzamiento preferente con la comunidad Adomi. Beneficios especiales por ser de los primeros.
      </p>

      <div class="plan-card__limits">
        <div class="limit">
          <span class="label">Servicios</span>
          <span class="value">{{ founderServicesLimitLabel }}</span>
        </div>
        <div class="limit">
          <span class="label">Reservas</span>
          <span class="value">{{ founderBookingsLimitLabel }}</span>
        </div>
      </div>

      <ul class="plan-card__features">
        <li
          *ngFor="let feature of getPlanFeatureRows(promoPlan || null)"
          [class.plan-card__feature--disabled]="!feature.enabled"
        >
          <span
            class="plan-card__feature-icon"
            [class.plan-card__feature-icon--check]="feature.enabled"
            [class.plan-card__feature-icon--x]="!feature.enabled"
          ></span>
          <div>
            <span>{{ feature.label }}</span>
            <small *ngIf="feature.note">{{ feature.note }}</small>
          </div>
        </li>
      </ul>

      <div class="promo-input-group" [class.active]="isPromoActive()">
        <input
          type="text"
          placeholder="Ingresa tu código Fundador"
          [(ngModel)]="promoCode"
          [disabled]="promoDisabled || isPromoActive()"
        />
        <button
          class="btn-apply"
          type="button"
          (click)="applyPromoCode()"
          [disabled]="promoDisabled || !promoCode.trim() || isPromoActive()"
        >
          {{ promoLoading ? 'Validando…' : 'Validar y seleccionar' }}
        </button>
        <button
          class="btn-clear"
          type="button"
          *ngIf="isPromoActive()"
          (click)="clearPromo()"
        >
          Quitar código
        </button>
      </div>

      <div class="promo-status" *ngIf="promoSuccess">
        <span class="success">{{ promoSuccess }}</span>
      </div>
      <div class="promo-status" *ngIf="promoError">
        <span class="error">{{ promoError }}</span>
      </div>
      <div class="promo-meta" *ngIf="isPromoActive() && promoMeta">
        <span *ngIf="promoMeta.max_duration_months">
          Incluye {{ promoMeta.max_duration_months }} meses gratuitos.
        </span>
      </div>
    </div>

    <div
      *ngFor="let plan of getCurrentPlans()"
      class="plan-card"
      [class.plan-card--selected]="selectedPlan?.id === plan.id"
      [class.plan-card--recommended]="isPlanRecommended(plan)"
      [class.plan-card--disabled]="isPromoActive()"
      (click)="selectPlan(plan)"
    >
      <div class="plan-card__badge plan-card__badge--recommended" *ngIf="isPlanRecommended(plan)">
        Recomendado
      </div>
      <div class="plan-card__header">
        <div>
          <h3>{{ plan.name }}</h3>
          <p>{{ getPlanSubtitle(plan) }}</p>
        </div>
      </div>
      <div class="plan-card__price">
        <span class="plan-card__price-value">{{ formatPrice(plan.price) }}</span>
        <span class="plan-card__price-interval">/{{ plan.interval === 'month' ? 'mes' : 'año' }}</span>
      </div>
      <p class="plan-card__description">{{ plan.description }}</p>

      <div class="plan-card__limits">
        <div class="limit">
          <span class="label">Servicios</span>
          <span class="value">{{ plan.max_services >= 999 ? 'Ilimitados' : plan.max_services }}</span>
        </div>
        <div class="limit">
          <span class="label">Reservas</span>
          <span class="value">
            {{ plan.max_bookings >= 9999 ? 'Ilimitadas' : plan.max_bookings + '/mes' }}
          </span>
        </div>
      </div>

      <ul class="plan-card__features">
        <li
          *ngFor="let feature of getPlanFeatureRows(plan)"
          [class.plan-card__feature--disabled]="!feature.enabled"
        >
          <span
            class="plan-card__feature-icon"
            [class.plan-card__feature-icon--check]="feature.enabled"
            [class.plan-card__feature-icon--x]="!feature.enabled"
          ></span>
          <div>
            <span>{{ feature.label }}</span>
            <small *ngIf="feature.note">{{ feature.note }}</small>
          </div>
        </li>
      </ul>

      <button
        type="button"
        class="plan-card__select"
        (click)="selectPlan(plan); $event.stopPropagation()"
      >
        Seleccionar {{ plan.name }}
      </button>
    </div>
  </div>

  <div *ngIf="!loading && !error && requiresPaymentSelection()" class="payment-methods">
    <h3>Selecciona cómo quieres pagar</h3>
    <p>Elige la pasarela de pago que prefieras para completar tu suscripción.</p>

    <div class="payment-options">
      <label
        class="payment-option"
        *ngFor="let method of paymentMethods"
        [class.selected]="paymentMethod === method.id"
      >
        <input
          type="radio"
          name="paymentMethod"
          [value]="method.id"
          [checked]="paymentMethod === method.id"
          (change)="onPaymentMethodChange(method.id)"
        />
        <div class="payment-option__body">
          <div class="payment-option__header">
            <span class="payment-option__title">{{ method.label }}</span>
            <span *ngIf="method.badge" class="payment-option__badge">{{ method.badge }}</span>
          </div>
          <p class="payment-option__description">{{ method.description }}</p>
        </div>
      </label>
    </div>
  </div>

  <div *ngIf="!loading && !error" class="actions">
    <button class="btn-secondary" type="button" (click)="goBack()" [disabled]="promoActivating">
      Volver
    </button>
    <button
      class="btn-primary"
      type="button"
      *ngIf="!isPromoActive()"
      [disabled]="!selectedPlan"
      (click)="continueToPayment()"
    >
      {{ paymentMethod === 'tbk' && requiresPaymentSelection() ? 'Pagar con Webpay Plus' : 'Pagar con Stripe' }}
    </button>
  </div>
</div>
