<div class="plan-selection-container">
  <div class="account-switch-banner" *ngIf="accountSwitchInProgress">
    <div class="banner-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.73-.626 1.18-.734l.54-1.636c.26-1.004-.322-2.016-1.34-2.28zM11.42 15.17L5.877 21m6.46-6.46l-1.127-1.127a4.5 4.5 0 00-6.364-6.364l-1.127 1.127" />
      </svg>
    </div>
    <div>
      <h4>Estás convirtiendo tu cuenta en proveedor</h4>
      <p>Completa tu plan para habilitar el dashboard profesional y empezar a recibir clientes.</p>
    </div>
  </div>

  <div class="pricing-v2">
    <div class="pricing-v2__header">
      <h1 class="pricing-v2__title">Elige cómo quieres crecer</h1>
      <p class="pricing-v2__subtitle">Reduce tus comisiones pagando una suscripción mensual o empieza gratis.</p>

      <div class="billing-toggle-wrapper" role="group" aria-label="Seleccionar periodicidad">
        <button
          type="button"
          class="billing-label"
          [class.active]="!isAnnualBilling"
          [disabled]="monthlyPlans.length === 0 || isPromoActive()"
          (click)="isAnnualBilling && !isPromoActive() ? toggleBilling() : null"
        >
          Mensual
        </button>

        <button
          type="button"
          class="toggle-switch"
          role="switch"
          [attr.aria-checked]="isAnnualBilling"
          [class.checked]="isAnnualBilling"
          (click)="toggleBilling()"
          aria-label="Cambiar entre mensual y anual"
        >
          <span class="toggle-slider"></span>
        </button>

        <button
          type="button"
          class="billing-label"
          [class.active]="isAnnualBilling"
          [disabled]="annualPlans.length === 0 || isPromoActive()"
          (click)="!isAnnualBilling && !isPromoActive() ? toggleBilling() : null"
        >
          Anual
        </button>

        <span class="savings-badge" *ngIf="getSavingsPercentage() > 0">AHORRA {{ getSavingsPercentage() }}%</span>
      </div>
    </div>

    <div *ngIf="loading" class="loading">
      <div class="spinner"></div>
      <p>Cargando planes...</p>
    </div>

    <div *ngIf="error" class="error">
      <p>{{ error }}</p>
      <button class="btn-primary" (click)="loadPlans()">Reintentar</button>
    </div>

    <div *ngIf="!loading && !error" class="plans-grid pricing-v2__grid">
      <!-- NO TOCAR: Card Fundador (funcionalidad de validación ya implementada) -->
      <div class="plan-card plan-card--founder" data-plan="fundador" [class.plan-card--selected]="isPromoActive()">
        <div class="plan-card__badge">¡LIMITADO!</div>
        <div class="plan-card__header">
          <div>
            <h3>Fundador</h3>
            <p>Acceso exclusivo “Pioneros”</p>
          </div>
          <span class="plan-card__tag">Acceso exclusivo</span>
        </div>
        <div class="plan-card__price">
          <span class="plan-card__price-value">{{ formatDisplayPrice(0) }}</span>
          <span class="plan-card__price-interval">/ {{ founderDurationMonths }} meses</span>
        </div>
        <p class="plan-card__description">
          Lanzamiento preferente con la comunidad Adomi. Beneficios especiales por ser de los primeros.
        </p>

        <div class="plan-card__limits">
          <div class="limit">
            <span class="label">Servicios</span>
            <span class="value">{{ founderServicesLimitLabel }}</span>
          </div>
          <div class="limit">
            <span class="label">Reservas</span>
            <span class="value">{{ founderBookingsLimitLabel }}</span>
          </div>
        </div>

        <ul class="plan-card__features">
          <li
            *ngFor="let feature of founderFeatureRows"
            [class.plan-card__feature--disabled]="!feature.enabled"
          >
            <span
              class="plan-card__feature-icon"
              [class.plan-card__feature-icon--check]="feature.enabled"
              [class.plan-card__feature-icon--x]="!feature.enabled"
            ></span>
            <div>
              <span>{{ feature.label }}</span>
              <small *ngIf="feature.note">{{ feature.note }}</small>
            </div>
          </li>
        </ul>

        <div class="promo-input-group" [class.active]="isPromoActive()">
          <input
            type="text"
            placeholder="Ingresa tu código Fundador"
            [(ngModel)]="promoCode"
            [disabled]="promoDisabled || isPromoActive()"
          />
          <button
            class="btn-apply"
            type="button"
            (click)="applyPromoCode()"
            [disabled]="promoDisabled || !promoCode.trim() || isPromoActive()"
          >
            {{ promoLoading ? 'Validando…' : 'Validar y seleccionar' }}
          </button>
          <button
            class="btn-clear"
            type="button"
            *ngIf="isPromoActive()"
            (click)="clearPromo()"
          >
            Quitar código
          </button>
        </div>

        <div class="promo-status" *ngIf="promoSuccess">
          <span class="success">{{ promoSuccess }}</span>
        </div>
        <div class="promo-status" *ngIf="promoError">
          <span class="error">{{ promoError }}</span>
        </div>
        <div class="promo-meta" *ngIf="isPromoActive() && promoMeta">
          <span *ngIf="promoMeta.max_duration_months">
            Incluye {{ promoMeta.max_duration_months }} meses gratuitos.
          </span>
          <span *ngIf="promoMeta.remaining_spots !== null">
            Cupos disponibles: {{ promoMeta.remaining_spots }}.
          </span>
          <span *ngIf="promoMeta.metadata?.['founder_commune'] as founderCommune">
            Bienvenido/a Fundador en {{ founderCommune }}.
          </span>
          <span
            *ngIf="promoMeta.metadata?.['founder_region'] && promoMeta.metadata?.['founder_commune']"
            class="promo-meta__badge"
          >
            Campaña RM
          </span>
        </div>
      </div>

      <!-- Planes normales (nuevo look del Home) -->
      <div
        *ngFor="let plan of getCurrentPlans()"
        class="plan-card"
        [attr.data-plan]="getPlanGroupKey(plan)"
        [class.is-selected]="selectedPlan?.id === plan.id"
        [class.recommended]="isPlanRecommended(plan)"
        [class.is-disabled]="isPromoActive()"
        (click)="selectPlan(plan)"
      >
        <div class="badge-recommended" *ngIf="isPlanRecommended(plan)">Recomendado</div>

        <div class="card-header">
          <h3 class="plan-name">{{ getDisplayPlanName(plan) }}</h3>
          <p class="plan-desc">{{ plan.description || getPlanSubtitle(plan) }}</p>
        </div>

        <div class="card-pricing">
          <div class="price-value">
            <span class="amount" *ngIf="plan.price === 0">Gratis</span>
            <ng-container *ngIf="plan.price !== 0">
              <span class="currency">$</span>
              <span class="amount">{{ formatAmount(plan.price) }}</span>
              <span class="period">{{ getPlanIntervalLabel(plan) }}</span>
            </ng-container>
          </div>

          <div class="commission-box" [ngClass]="getCommissionBoxClass(plan)">
            <span class="comm-label">Tu Comisión</span>
            <span class="comm-value">{{ getCommissionLabel(plan) }}</span>
            <small class="comm-note" *ngFor="let n of getCommissionNotes(plan)">{{ n }}</small>
          </div>
        </div>

        <ul class="features-list">
          <li
            *ngFor="let feature of getPlanFeatureRows(plan)"
            [class.enabled]="feature.enabled"
            [class.disabled]="!feature.enabled"
          >
            <span class="material-icon icon">{{ feature.enabled ? 'check_circle' : 'cancel' }}</span>
            <span>
              {{ feature.label }}
              <span class="tooltip-hint" *ngIf="feature.note">{{ feature.note }}</span>
            </span>
          </li>
        </ul>

        <button
          type="button"
          class="btn-select"
          [class.btn-primary]="isPlanRecommended(plan)"
          [class.btn-outline]="!isPlanRecommended(plan)"
          (click)="selectPlan(plan); $event.stopPropagation()"
        >
          Seleccionar {{ getDisplayPlanName(plan) }}
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="!loading && !error && requiresPaymentSelection()" class="payment-methods">
    <h3>Selecciona cómo quieres pagar</h3>
    <p>Elige la pasarela de pago que prefieras para completar tu suscripción.</p>

    <div class="payment-options">
      <label
        class="payment-option"
        *ngFor="let method of paymentMethods"
        [class.selected]="paymentMethod === method.id"
      >
        <input
          type="radio"
          name="paymentMethod"
          [value]="method.id"
          [checked]="paymentMethod === method.id"
          (change)="onPaymentMethodChange(method.id)"
        />
        <div class="payment-option__body">
          <div class="payment-option__header">
            <span class="payment-option__title">{{ method.label }}</span>
            <span *ngIf="method.badge" class="payment-option__badge">{{ method.badge }}</span>
          </div>
          <p class="payment-option__description">{{ method.description }}</p>
        </div>
      </label>
    </div>
  </div>

  <div *ngIf="!loading && !error" class="actions">
    <button class="btn-secondary" type="button" (click)="goBack()" [disabled]="promoActivating">
      Volver
    </button>
    <button
      class="btn-primary"
      type="button"
      *ngIf="!isPromoActive()"
      [disabled]="!selectedPlan"
      (click)="continueToPayment()"
    >
      {{
        selectedPlan
          ? (paymentMethod === 'tbk' && requiresPaymentSelection()
            ? 'Pagar con Webpay Plus'
            : 'Pagar con Stripe')
          : 'Selecciona un plan'
      }}
    </button>
  </div>
</div>
