<div class="agenda-container">
  <!-- Navegaci√≥n de la agenda -->
  <nav class="agenda-nav">
    <button 
      class="agenda-nav__button"
      [class.agenda-nav__button--active]="currentView === 'dashboard'"
      (click)="setView('dashboard')">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z" />
      </svg>
      Panel de Control
    </button>
    
    <button 
      class="agenda-nav__button"
      [class.agenda-nav__button--active]="currentView === 'calendar'"
      (click)="setView('calendar')"
      style="position: relative;">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      <span>Agenda (Citas)</span>
      <!-- üîî Badge rojo de citas pendientes -->
      <span *ngIf="scheduledAppointmentsCount > 0" class="agenda-nav__badge">
        {{ scheduledAppointmentsCount }}
      </span>
    </button>
    
    <button 
      class="agenda-nav__button"
      [class.agenda-nav__button--active]="currentView === 'config'"
      (click)="setView('config')">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      Configuraci√≥n
    </button>
    
    <button 
      class="agenda-nav__button"
      [class.agenda-nav__button--active]="currentView === 'cash'"
      (click)="setView('cash')">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="w-5 h-5">
        <rect x="3" y="6" width="18" height="12" rx="2"></rect>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
      Pagos en Efectivo
    </button>
  </nav>

  <!-- Contenido del dashboard -->
  <div *ngIf="currentView === 'dashboard'" class="agenda-content">
    <div class="agenda-content__main">
      <!-- Dashboard Resumen -->
      <app-dashboard-resumen 
        [metrics]="dashboardMetrics"
        [loading]="loading">
      </app-dashboard-resumen>

      <!-- Panel: Citas por pagar (esperan c√≥digo) -->
      <div *ngIf="showPaidAwaitingPanel" class="paid-awaiting">
        <h3 class="paid-awaiting__title">Citas por pagar (esperan verificaci√≥n de c√≥digo)</h3>
        <div *ngIf="paidAwaitingAppointments.length === 0" class="paid-awaiting__empty">
          No tienes citas pagadas esperando verificaci√≥n.
        </div>
        <div *ngFor="let ap of paidAwaitingAppointments" class="paid-awaiting__card" [class.paid-awaiting__card--cash]="ap.payment_method==='cash'">
          <div class="paid-awaiting__row">
            <div class="paid-awaiting__col">
              <p class="paid-awaiting__service">
                <span *ngIf="ap.payment_method==='cash'" class="cash-badge">
                  <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="12" cy="12" r="3" fill="#ffffff"/></svg>
                  Efectivo
                </span>
                {{ ap.service_name || 'Servicio' }}
              </p>
              <p class="paid-awaiting__meta">Cliente: {{ ap.client_name || '‚Äî' }}</p>
              <p class="paid-awaiting__meta">Fecha: {{ formatDate(ap.date) }} ¬∑ {{ formatTime(ap.start_time) }}</p>
              <p *ngIf="ap.payment_method==='cash'" class="paid-awaiting__meta" style="color:#065f46;font-weight:600;">Cita de pago actual: Efectivo</p>
            </div>
            <div class="paid-awaiting__actions">
              <button class="paid-awaiting__btn" (click)="openVerifyModal(ap)">Verificar C√≥digo</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Gr√°fico -->
      <app-dashboard-grafico 
        [loading]="loading"
        [data]="chartData">
      </app-dashboard-grafico>
    </div>
  </div>

  <!-- Contenido del calendario -->
  <div *ngIf="currentView === 'calendar'" class="agenda-content agenda-content--calendar">
    <div class="agenda-content__calendar">
      <!-- Calendario Mensual -->
      <app-calendar-mensual 
        [events]="calendarEvents"
        [loading]="loading"
        (dateSelected)="onDateSelected($event)"
        (newAppointment)="onNewAppointment()"
        (previousMonth)="onPreviousMonth()"
        (nextMonth)="onNextMonth()">
      </app-calendar-mensual>
    </div>

    <div class="agenda-content__sidebar">
      <!-- Detalle del D√≠a -->
      <app-day-detail 
        [selectedDate]="selectedDate"
        [appointments]="dayAppointments"
        [loading]="loading"
        (appointmentClick)="onAppointmentClick($event)"
        (newAppointment)="onNewAppointmentForDay($event)"
        (citaCreated)="onDayCitaCreated($event)"
        (espacioBloqueado)="onEspacioBloqueado($event)"
        (confirmAppointment)="onConfirmAppointment(+$any($event))"
        (deleteAppointment)="onDeleteAppointment(+$any($event))"
        (cobrarEnEfectivo)="onCobrarEnEfectivo($event)"
        (closureAction)="onClosureAction($event)"
        (verifyClosure)="onVerifyClosure($event)">
        <ng-template #appointmentActionsTemplate let-appointment="appointment">
          <button *ngIf="appointment.status === 'scheduled'"
                  class="day-detail__action-btn day-detail__action-btn--confirm"
                  (click)="onConfirmAppointment(+appointment.id)">
            Confirmar
          </button>
        </ng-template>
      </app-day-detail>
    </div>
  </div>

  <!-- Contenido de configuraci√≥n -->
  <div *ngIf="currentView === 'config'" class="agenda-content">
    <div class="agenda-content__main">
      <!-- Configuraci√≥n de Horarios -->
      <app-horarios-config 
        [timeBlocks]="timeBlocks"
        [loading]="loading"
        (addTimeBlock)="onAddTimeBlock($event)"
        (removeTimeBlock)="onRemoveTimeBlock($event)"
        (updateTimeBlock)="onUpdateTimeBlock($event)">
      </app-horarios-config>

      <div class="flex justify-end mt-4">
        <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg"
                [disabled]="loading"
                (click)="onSaveSchedule()">
          {{ loading ? 'Guardando...' : 'Guardar Horario' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Contenido: Pagos en efectivo -->
  <div *ngIf="currentView === 'cash'" class="agenda-content">
    <div class="agenda-content__main">
      <h2 class="cash-title">Mis Comisiones Pendientes</h2>
      <p class="cash-sub">Aqu√≠ puedes ver las comisiones que debes a la plataforma por los cobros en efectivo.</p>

      <div class="cash-summary">
        <div class="cash-summary__amount">
          <div class="cash-summary__label">Total Adeudado</div>
          <div class="cash-summary__value">
            <ng-container *ngIf="!cashSummaryLoading; else summaryLoading">
              {{ cashTotal | currency:'CLP':'symbol':'1.0-0':'es-CL' }}
            </ng-container>
          </div>
          <div class="cash-summary__overdue" *ngIf="!cashSummaryLoading && cashOverdueTotal>0">Vencido: {{ cashOverdueTotal | currency:'CLP':'symbol':'1.0-0':'es-CL' }}</div>
        </div>
        <div class="cash-summary__actions">
          <button class="cash-summary__refresh" type="button" (click)="refreshCash()" [disabled]="cashSummaryLoading || cashLoading">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 19a9 9 0 0014.1-2.1M19 5a9 9 0 00-14.1 2.1" />
            </svg>
            Actualizar
          </button>
          <button class="cash-summary__pay" type="button" [disabled]="cashTotal===0 || cashSummaryLoading">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M21 7H3V5h18v2zm0 4H3V9h18v2zm0 6H3v-2h18v2z"/></svg>
            Pagar Total Adeudado
          </button>
        </div>
      </div>

      <ng-template #summaryLoading>
        <span class="cash-summary__loading">Cargando‚Ä¶</span>
      </ng-template>

      <div class="cash-controls">
        <div class="cash-filters">
          <button type="button" class="cash-filters__button" [class.cash-filters__button--active]="cashTableFilter==='pending'" (click)="setCashFilter('pending')">
            Pendientes
          </button>
          <button type="button" class="cash-filters__button" [class.cash-filters__button--active]="cashTableFilter==='overdue'" (click)="setCashFilter('overdue')">
            Vencidas
          </button>
          <button type="button" class="cash-filters__button" [class.cash-filters__button--active]="cashTableFilter==='paid'" (click)="setCashFilter('paid')">
            Pagadas
          </button>
          <button type="button" class="cash-filters__button" [class.cash-filters__button--active]="cashTableFilter==='all'" (click)="setCashFilter('all')">
            Todas
          </button>
        </div>
      </div>

      <table class="cash-table">
        <thead>
          <tr>
            <th>Cita (Cliente)</th>
            <th>Monto Comisi√≥n</th>
            <th>Fecha Vencimiento</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngIf="cashLoading">
            <tr>
              <td colspan="4" class="cash-table__loading">
                <span class="cash-spinner"></span>
                Cargando comisiones‚Ä¶
              </td>
            </tr>
          </ng-container>
          <ng-container *ngIf="!cashLoading && cashDebts.length === 0">
            <tr>
              <td colspan="4" class="cash-table__empty">
                No tienes comisiones en este estado.
              </td>
            </tr>
          </ng-container>
          <ng-container *ngIf="!cashLoading && cashDebts.length > 0">
            <tr *ngFor="let d of cashDebts">
              <td>
                <div class="cash-table__slot">{{ d.time }} ‚Äì {{ d.client }}</div>
                <div class="cash-table__date">{{ d.date | date:'dd/MM/yyyy' }}</div>
              </td>
              <td>{{ d.commission | currency:'CLP':'symbol':'1.0-0':'es-CL' }}</td>
              <td>{{ d.dueDate | date:'dd/MM/yyyy' }}</td>
              <td>
                <span class="badge" [ngClass]="{
                  'badge--pending': d.status==='pending',
                  'badge--overdue': d.status==='overdue',
                  'badge--paid': d.status==='paid'
                }">
                  {{ d.status==='pending' ? 'Pendiente' : (d.status==='overdue' ? 'Vencida' : 'Pagada') }}
                </span>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal de verificaci√≥n de servicio -->
<ui-modal-verificar-servicio
  *ngIf="isVerificationModalOpen"
  [isOpen]="isVerificationModalOpen"
  [appointment]="selectedPaidAppointment"
  [verifying]="verifying"
  [errorMessage]="verificationError"
  [remainingAttempts]="remainingAttempts"
  (verified)="onVerificationSubmit($event)"
  (cancel)="onVerificationCancel()"
></ui-modal-verificar-servicio>




