<!-- P√°gina de Ingresos del Dashboard -->
<div class="ingresos-container">
  <!-- Encabezado -->
  <ui-finances-header></ui-finances-header>
  
  <!-- Filtro de Tiempo -->
  <ui-time-filter 
    [selectedPeriod]="selectedTimeFilter"
    (filterChanged)="onTimeFilterChanged($event)">
  </ui-time-filter>
  
  <!-- Navegaci√≥n de pesta√±as -->
  <ui-tab-navigation 
    [tabs]="tabsConfig"
    (tabChanged)="onTabChanged($event)">
  </ui-tab-navigation>
  
  <!-- Contenido de pesta√±as -->
  <div class="tab-content">
    
    <!-- Pesta√±a: Resumen de Ingresos -->
    <div *ngIf="activeTab === 'resumen'" class="tab-panel">
      <!-- Mercado Pago Split (Checkout Pro) -->
      <section class="tbk-card">
        <div class="tbk-card__header">
          <div class="tbk-card__title">
            <h3>Mercado Pago (Split)</h3>
            <p>Conecta tu cuenta para recibir pagos con tarjeta v√≠a Mercado Pago.</p>
          </div>
          <div class="tbk-card__chips">
            <span class="chip chip--neutral">Estado: {{ mpStatusLabel }}</span>
            <span *ngIf="mpUserId" class="chip chip--neutral">Usuario MP: {{ mpUserId }}</span>
          </div>
        </div>

        <div class="tbk-card__body">
          <div class="tbk-card__info">
            <p *ngIf="!mpConnected">
              Mercado Pago puede activarse m√°s r√°pido que otros gateways. Conecta tu cuenta y empieza a cobrar por tus citas.
            </p>
            <p *ngIf="mpConnected && mpExpiresAt">
              Conexi√≥n activa. Expira: <strong>{{ mpExpiresAt | date:'shortDate' }}</strong>
            </p>
            <div class="tbk-inline-form__actions">
              <button type="button" class="tbk-btn tbk-btn--primary" (click)="connectMercadoPago()" [disabled]="mpActionLoading">
                {{ mpActionLoading ? 'Abriendo‚Ä¶' : (mpConnected ? 'Reconectar' : (mpStatusLabel === 'Requiere reinscripci√≥n' ? 'Reinscribir cuenta MP' : 'Conectar Mercado Pago')) }}
              </button>
              <button
                *ngIf="mpConnected"
                type="button"
                class="tbk-btn tbk-btn--secondary"
                (click)="disconnectMercadoPago()"
                [disabled]="mpActionLoading"
              >
                {{ mpActionLoading ? 'Procesando‚Ä¶' : 'Desconectar cuenta MP' }}
              </button>
            </div>
          </div>
        </div>
      </section>

      <section *ngIf="showTbkSection" class="tbk-card">
        <div class="tbk-card__header">
          <div class="tbk-card__title">
            <h3>Transbank Webpay Mall</h3>
            <p>Crea y administra tus comercios secundarios directamente desde Adomi.</p>
          </div>
          <div class="tbk-card__chips" *ngIf="!tbkSectionLoading">
            <span class="chip" [ngClass]="chipClass(tbkStatus)">Estado: {{ tbkStatusLabel }}</span>
            <span *ngIf="tbkMallCode" class="chip chip--neutral">C√≥digo Mall: {{ tbkMallCode }}</span>
            <span *ngIf="tbkSecondaryCode" class="chip chip--neutral">C√≥digo hijo: {{ tbkSecondaryCode }}</span>
          </div>
        </div>

        <div *ngIf="tbkSectionLoading" class="tbk-card__loader">
          <span class="spinner"></span>
          <span>Consultando estado en Transbank‚Ä¶</span>
        </div>

        <div *ngIf="!tbkSectionLoading" class="tbk-card__body">
          <!-- tbk-card__meta oculto por ahora -->
          <!--
          <div class="tbk-card__meta">
            <div>
              <span class="meta-label">√öltima actualizaci√≥n</span>
              <span class="meta-value">{{ tbkLastUpdated ? (tbkLastUpdated | date:'short') : '‚Äî' }}</span>
            </div>
            <div *ngIf="tbkRemoteStatusLabel">
              <span class="meta-label">Estado TBK</span>
              <span class="meta-value">{{ tbkRemoteStatusLabel }}</span>
            </div>
          </div>
          -->

          <div *ngIf="tbkError" class="tbk-card__error">{{ tbkError }}</div>

          <!-- tbk-card__alert oculto por ahora -->
          <!--
          <div *ngIf="!tbkKycReady && !tbkSecondaryCode" class="tbk-card__alert">
            <h4>Completa estos datos antes de solicitar el alta:</h4>
            <ul>
              <li *ngFor="let item of tbkKycMissing">{{ item }}</li>
            </ul>
            <button type="button" class="link-as-button" (click)="goToPaymentsTab()">
              Ir a completar mi ficha bancaria
            </button>
          </div>
          -->

          <hr class="tbk-card__divider" />

          <div class="tbk-card__info" *ngIf="!tbkSecondaryCode">
            <p>
              Para activar Webpay Mall llama a Transbank al
              <a href="tel:6006386380">600 638 6380</a> y solicita tu c√≥digo de comercio hijo
              asociado al mall <strong>{{ tbkMallCode || '‚Äî' }}</strong>.
            </p>
            <p>Ingresa abajo ese c√≥digo junto a tu correo para validarlo y guardarlo en Adomi.</p>

            <!-- Trigger de ayuda integrado (UI) -->
            <div
              class="help-inline-trigger"
              role="button"
              tabindex="0"
              (click)="toggleTbkHelp()"
              (keydown.enter)="toggleTbkHelp()"
              (keydown.space)="toggleTbkHelp()"
            >
              <div class="help-inline-icon">?</div>
              <div class="help-inline-text">
                ¬øPor qu√© debo pedir este c√≥digo?
                <span>Haz clic aqu√≠ si tienes dudas o problemas con Transbank</span>
              </div>
            </div>

            <form [formGroup]="tbkManualForm" (ngSubmit)="submitManualCode()" class="tbk-inline-form">
              <label>
                C√≥digo de comercio hijo
                <input type="text" formControlName="code" placeholder="Ej. 5970XXXXXXXX" />
                <small>Debe ser el c√≥digo que Transbank te entreg√≥.</small>
                <div class="error" *ngIf="tbkManualForm.get('code')?.touched && tbkManualForm.get('code')?.invalid">
                  Ingresa un c√≥digo v√°lido.
                </div>
              </label>
              <label>
                Correo de contacto
                <input type="email" formControlName="email" placeholder="tu-correo@ejemplo.com" />
                <small>Validaremos que coincida con tu cuenta en Adomi.</small>
                <div class="error" *ngIf="tbkManualForm.get('email')?.touched && tbkManualForm.get('email')?.invalid">
                  Ingresa un correo v√°lido.
                </div>
              </label>
              <div class="tbk-inline-form__actions">
                <button type="submit" class="tbk-btn tbk-btn--primary" [disabled]="tbkActionLoading">
                  <span *ngIf="tbkActionLoading && tbkCurrentAction === 'create'; else saveCodeLabel">Guardando‚Ä¶</span>
                  <ng-template #saveCodeLabel>Guardar c√≥digo</ng-template>
                </button>
              </div>
            </form>
          </div>

          <div class="tbk-card__section-header">
            <h4>Mis Comercios Secundarios</h4>
          </div>

          <div class="tbk-table-wrapper" *ngIf="tbkSecondaryShops.length; else tbkEmptyState">
            <table class="tbk-table">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>C√≥digo</th>
                  <th>Estado</th>
                  <th class="text-right">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let shop of tbkSecondaryShops">
                  <td>{{ shop.name }}</td>
                  <td>{{ shop.code }}</td>
                  <td>
                    <span class="chip" [ngClass]="chipClass(shop.status)">{{ shop.status | titlecase }}</span>
                  </td>
                  <td class="actions">
                    <button type="button" class="link" (click)="onRefreshTbkStatus()" [disabled]="tbkActionLoading">
                      <span *ngIf="tbkActionLoading && tbkCurrentAction === 'refresh'; else refreshLabel">Actualizando‚Ä¶</span>
                      <ng-template #refreshLabel>Actualizar</ng-template>
                    </button>
                    <button type="button" class="link link--danger" (click)="onRevokeTbkSecondary()" [disabled]="tbkActionLoading">
                      <span *ngIf="tbkActionLoading && tbkCurrentAction === 'revoke'; else revokeLabel">Procesando‚Ä¶</span>
                      <ng-template #revokeLabel>Dar de baja</ng-template>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <ng-template #tbkEmptyState>
            <div class="tbk-empty">
              <div class="tbk-empty__icon">üè¨</div>
              <h5>Sin comercios secundarios</h5>
              <p>Crea tu primer comercio para comenzar a procesar pagos con Webpay Mall.</p>
            </div>
          </ng-template>
        </div>
      </section>

      <ui-financial-kpis 
        [kpis]="financialKPIs"
        (viewDetailsClicked)="onViewDetailsClicked()">
      </ui-financial-kpis>

      <ng-container *ngIf="!incomeGoalLoading; else incomeGoalLoaderTpl">
        <ui-income-goals
          [currentGoal]="currentGoal"
          [currentIncome]="currentIncome"
          [savingGoal]="savingIncomeGoal"
          [goalError]="goalSaveError"
          (goalSet)="onGoalSet($event)"
          (goToSummary)="onGoToSummary()">
        </ui-income-goals>
      </ng-container>

      <ng-template #incomeGoalLoaderTpl>
        <div class="goal-loader metric-card">
          <div class="goal-loader__spinner"></div>
          <p>Cargando metas de ingresos...</p>
        </div>
      </ng-template>

      <ui-transactions-table 
        [transactions]="transactions"
        (viewAllClicked)="onViewAllTransactions()"
        (transactionSelected)="onTransactionSelected($event)">
      </ui-transactions-table>
    </div>
    
    <!-- Pesta√±a: Billetera -->
    <div *ngIf="activeTab === 'wallet'" class="tab-panel">
      <div class="wallet-grid">
        <section class="metric-card wallet-balance-card">
          <div class="wallet-balance-card__header">
            <div>
              <h2>Billetera Adomi</h2>
              <p>Saldo disponible para retiros y reintegros autom√°ticos.</p>
            </div>
            <span class="wallet-last-updated" *ngIf="walletSummary.lastUpdated as updated">
              Actualizado {{ updated | date:'short' }}
            </span>
          </div>
          <div class="wallet-balance-card__amount">
            {{ formatCurrency(walletSummary.availableBalance) }}
          </div>
          <p class="wallet-balance-card__caption">Saldo disponible</p>
          <div class="wallet-balance-card__meta">
            <div class="wallet-meta-item">
              <span class="label">Pendiente de liberaci√≥n</span>
              <span class="value">{{ formatCurrency(walletSummary.pendingBalance) }}</span>
            </div>
            <div class="wallet-meta-item">
              <span class="label">Saldo retenido</span>
              <span class="value">{{ formatCurrency(walletSummary.holdBalance) }}</span>
            </div>
            <div class="wallet-meta-item">
              <span class="label">Total retirado</span>
              <span class="value">{{ formatCurrency(walletSummary.totalWithdrawn) }}</span>
            </div>
            <div class="wallet-meta-item">
              <span class="label">Cr√©ditos generados</span>
              <span class="value">{{ walletSummary.creditsEarned }}</span>
            </div>
          </div>
          <div class="wallet-next-release" *ngIf="walletSummary.nextReleaseAmount">
            <ui-icon name="calendar-clock" class="wallet-next-release__icon"></ui-icon>
            <div>
              <p class="wallet-next-release__title">Pr√≥xima liberaci√≥n</p>
              <p class="wallet-next-release__value">
                {{ formatCurrency(walletSummary.nextReleaseAmount || 0) }}
                <span *ngIf="walletSummary.nextReleaseDate">‚Ä¢ {{ walletSummary.nextReleaseDate | date:'dd/MM/yy' }}</span>
              </p>
            </div>
          </div>
          <div class="wallet-actions">
            <button class="wallet-btn wallet-btn--primary" (click)="onRequestWithdrawal()">
              Solicitar retiro
            </button>
            <button class="wallet-btn wallet-btn--ghost" (click)="onViewWithdrawalHistory()">
              Historial de retiros
            </button>
          </div>
        </section>

        <section class="metric-card wallet-overview-card">
          <h3>Resumen del periodo</h3>
          <div class="wallet-stat-grid">
            <div class="wallet-stat-card wallet-stat-card--credit">
              <p class="wallet-stat-card__label">Ingresos creditados</p>
              <p class="wallet-stat-card__value">
                {{ formatCurrency(walletCreditTotal) }}
              </p>
              <span class="wallet-stat-card__detail">{{ walletCreditCount }} movimientos</span>
            </div>
            <div class="wallet-stat-card wallet-stat-card--debit">
              <p class="wallet-stat-card__label">Retiros y comisiones</p>
              <p class="wallet-stat-card__value">
                {{ formatCurrency(walletDebitTotal) }}
              </p>
              <span class="wallet-stat-card__detail">{{ walletDebitCount }} movimientos</span>
            </div>
            <div class="wallet-stat-card wallet-stat-card--hold">
              <p class="wallet-stat-card__label">Montos en retenci√≥n</p>
              <p class="wallet-stat-card__value">
                {{ formatCurrency(walletSummary.holdBalance) }}
              </p>
              <span class="wallet-stat-card__detail">{{ walletHoldCount }} en espera</span>
            </div>
            <div class="wallet-stat-card wallet-stat-card--neutral">
              <p class="wallet-stat-card__label">Total hist√≥rico retirado</p>
              <p class="wallet-stat-card__value">
                {{ formatCurrency(walletSummary.totalWithdrawn) }}
              </p>
              <span class="wallet-stat-card__detail">Incluye retiros manuales y autom√°ticos</span>
            </div>
          </div>
        </section>
      </div>

      <section class="metric-card wallet-movements-card">
        <div class="wallet-movements-card__header">
          <div>
            <h3>Movimientos recientes</h3>
            <p>Detalle de ingresos, retiros y retenciones de la billetera.</p>
          </div>
          <div class="wallet-filters">
            <button 
              class="wallet-filter-btn" 
              [class.wallet-filter-btn--active]="walletFilter === 'all'"
              (click)="setWalletFilter('all')">
              Todos
            </button>
            <button 
              class="wallet-filter-btn" 
              [class.wallet-filter-btn--active]="walletFilter === 'credits'"
              (click)="setWalletFilter('credits')">
              Ingresos
            </button>
            <button 
              class="wallet-filter-btn" 
              [class.wallet-filter-btn--active]="walletFilter === 'debits'"
              (click)="setWalletFilter('debits')">
              Retiros
            </button>
            <button 
              class="wallet-filter-btn" 
              [class.wallet-filter-btn--active]="walletFilter === 'holds'"
              (click)="setWalletFilter('holds')">
              Retenciones
            </button>
          </div>
        </div>

        <div *ngIf="walletLoading" class="wallet-loader">
          <span class="spinner"></span>
          <span>Cargando movimientos...</span>
        </div>
        <div *ngIf="walletError" class="tbk-card__error">{{ walletError }}</div>

        <ng-container *ngIf="!walletLoading && !walletError">
          <div *ngIf="filteredWalletMovements.length; else walletEmptyState">
            <table class="wallet-movements-table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Movimiento</th>
                  <th>Monto</th>
                  <th>Estado</th>
                  <th>Referencia</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let movement of filteredWalletMovements">
                  <td>{{ movement.date | date:'dd/MM/yy' }}</td>
                  <td>
                    <span class="wallet-tag" [class]="walletTypeClass(movement.type)">
                      {{ walletTypeLabel(movement.type) }}
                    </span>
                    <div class="wallet-movement__title">{{ movement.title }}</div>
                    <div class="wallet-movement__description" *ngIf="movement.description">{{ movement.description }}</div>
                  </td>
                  <td class="wallet-movement__amount" [class.wallet-movement__amount--credit]="movement.type === 'credit'" [class.wallet-movement__amount--debit]="movement.type === 'debit'">
                    {{ formatCurrency(movement.amount) }}
                  </td>
                  <td>
                    <span class="chip" [ngClass]="walletStatusClass(movement.status)">
                      {{ walletStatusLabel(movement.status) }}
                    </span>
                  </td>
                  <td>
                    <span class="wallet-reference">{{ movement.reference || '‚Äî' }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="wallet-table-footer">
              <button class="wallet-btn wallet-btn--ghost" (click)="showToast('Pronto podr√°s ver el historial completo de la billetera.')">
                Ver historial completo
              </button>
            </div>
          </div>
        </ng-container>

        <ng-template #walletEmptyState>
          <div class="wallet-empty">
            <h4>A√∫n no registramos movimientos</h4>
            <p>Cuando recibas pagos o realices retiros, aparecer√°n en este listado.</p>
          </div>
        </ng-template>
      </section>
    </div>
    
    <!-- Pesta√±a: Configuraci√≥n de Pagos -->
    <div *ngIf="activeTab === 'pagos'" class="tab-panel">
      <ui-payment-settings-form 
        [paymentSettings]="paymentSettings"
        (settingsSaved)="onPaymentSettingsSaved($event)"
        (settingsChanged)="onPaymentSettingsChanged($event)">
      </ui-payment-settings-form>
    </div>
    
    <!-- Pesta√±a: Metas de Ingreso -->
    <div *ngIf="activeTab === 'metas'" class="tab-panel">
      <ng-container *ngIf="!incomeGoalLoading; else incomeGoalLoaderMetas">
        <ui-income-goals 
          [currentGoal]="currentGoal"
          [currentIncome]="currentIncome"
          [savingGoal]="savingIncomeGoal"
          [goalError]="goalSaveError"
          (goalSet)="onGoalSet($event)"
          (goToSummary)="onGoToSummary()">
        </ui-income-goals>
      </ng-container>
      <ng-template #incomeGoalLoaderMetas>
        <div class="goal-loader metric-card">
          <div class="goal-loader__spinner"></div>
          <p>Cargando metas de ingresos...</p>
        </div>
      </ng-template>
    </div>
    
  </div>
</div>

<!-- Modal de ayuda (UI) -->
<div
  class="help-modal-overlay"
  [class.active]="tbkHelpOpen"
  (click)="onTbkHelpOverlayClick($event)"
  aria-hidden="true"
>
  <div class="help-modal" role="dialog" aria-modal="true" aria-label="Ayuda Transbank">
    <button type="button" class="help-close" (click)="closeTbkHelp()" aria-label="Cerrar">&times;</button>

    <div class="help-content">
      <h2>¬øPor qu√© necesito el C√≥digo Mall?</h2>

      <p>El <strong>C√≥digo Mall</strong> es un identificador √∫nico que Transbank asigna a tu tienda.</p>

      <div class="highlight-box">
        <strong>¬øPara qu√© sirve?</strong><br />
        Permite que Adomi sepa exactamente a qu√© cuenta bancaria debe dirigir el dinero cuando un cliente te compra. Sin este c√≥digo, no puedes recibir pagos.
      </div>

      <p>
        Debes pedirlo llamando a Transbank e indicando que perteneces al Mall Adomi (c√≥digo padre
        <strong>{{ tbkMallCode || '‚Äî' }}</strong>).
      </p>

      <div class="contact-support">
        <p>¬øTransbank no te da respuesta?</p>
        <p style="margin-bottom: 5px; font-size: 0.9rem; color: #666;">Escr√≠benos directamente:</p>
        <a href="mailto:soporte@adomipp.cl" class="btn-email">soporte@adomipp.cl</a>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Creaci√≥n de Comercio Secundario -->
<div *ngIf="tbkModalOpen" class="tbk-modal" role="dialog" aria-modal="true">
  <div class="tbk-modal__backdrop" (click)="closeTbkModal()"></div>
  <div class="tbk-modal__content">
    <form [formGroup]="tbkForm" (ngSubmit)="submitTbkForm()">
      <div class="tbk-modal__header">
        <div class="tbk-modal__icon">üè¶</div>
        <div>
          <h3>Registrar tu comercio en Transbank</h3>
          <p>Ser√°s redirigido al portal seguro de Transbank para ingresar tu informaci√≥n legal y bancaria.</p>
        </div>
      </div>

      <div class="tbk-modal__body">
        <label>
          Nombre de tu Comercio o Servicio
          <input type="text" formControlName="commerceName" placeholder="Ej. Juan P√©rez Plomer√≠a" />
          <small>Este es el nombre que ver√°n tus clientes.</small>
        </label>
        <div class="error" *ngIf="tbkForm.get('commerceName')?.touched && tbkForm.get('commerceName')?.invalid">
          Ingresa un nombre v√°lido (m√≠nimo 3 caracteres).
        </div>

        <label>
          Email de contacto
          <input type="email" formControlName="commerceEmail" placeholder="juan.perez@email.com" />
          <small>Aqu√≠ recibir√°s las notificaciones de Transbank.</small>
        </label>
        <div class="error" *ngIf="tbkForm.get('commerceEmail')?.touched && tbkForm.get('commerceEmail')?.invalid">
          Ingresa un correo v√°lido.
        </div>
      </div>

      <div class="tbk-modal__footer">
        <button type="button" class="tbk-btn tbk-btn--secondary" (click)="closeTbkModal()">Cancelar</button>
        <button type="submit" class="tbk-btn tbk-btn--primary" [disabled]="tbkActionLoading">
          <span *ngIf="tbkActionLoading && tbkCurrentAction === 'create'; else modalSubmitLabel">Conectando‚Ä¶</span>
          <ng-template #modalSubmitLabel>Continuar a Transbank</ng-template>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Toast de notificaciones -->
<div *ngIf="tbkToastVisible && tbkToastMessage" class="tbk-toast tbk-toast--visible">
  {{ tbkToastMessage }}
</div>
