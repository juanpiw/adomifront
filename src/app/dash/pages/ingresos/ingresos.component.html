<!-- P√°gina de Ingresos del Dashboard -->
<div class="ingresos-container">
  <!-- Encabezado -->
  <ui-finances-header></ui-finances-header>
  
  <!-- Filtro de Tiempo -->
  <ui-time-filter 
    [selectedPeriod]="selectedTimeFilter"
    (filterChanged)="onTimeFilterChanged($event)">
  </ui-time-filter>
  
  <!-- Navegaci√≥n de pesta√±as -->
  <ui-tab-navigation 
    (tabChanged)="onTabChanged($event)">
  </ui-tab-navigation>
  
  <!-- Contenido de pesta√±as -->
  <div class="tab-content">
    
    <!-- Pesta√±a: Resumen de Ingresos -->
    <div *ngIf="activeTab === 'resumen'" class="tab-panel">
      <section class="tbk-card">
        <div class="tbk-card__header">
          <div class="tbk-card__title">
            <h3>Transbank Webpay Mall</h3>
            <p>Crea y administra tus comercios secundarios directamente desde Adomi.</p>
          </div>
          <div class="tbk-card__chips" *ngIf="!tbkSectionLoading">
            <span class="chip" [ngClass]="chipClass(tbkStatus)">Estado: {{ tbkStatusLabel }}</span>
            <span *ngIf="tbkSecondaryCode" class="chip chip--neutral">C√≥digo Mall: {{ tbkSecondaryCode }}</span>
          </div>
        </div>

        <div *ngIf="tbkSectionLoading" class="tbk-card__loader">
          <span class="spinner"></span>
          <span>Consultando estado en Transbank‚Ä¶</span>
        </div>

        <div *ngIf="!tbkSectionLoading" class="tbk-card__body">
          <div class="tbk-card__meta">
            <div>
              <span class="meta-label">√öltima actualizaci√≥n</span>
              <span class="meta-value">{{ tbkLastUpdated ? (tbkLastUpdated | date:'short') : '‚Äî' }}</span>
            </div>
            <div *ngIf="tbkRemoteStatusLabel">
              <span class="meta-label">Estado TBK</span>
              <span class="meta-value">{{ tbkRemoteStatusLabel }}</span>
            </div>
          </div>

          <div *ngIf="tbkError" class="tbk-card__error">{{ tbkError }}</div>

          <div *ngIf="!tbkKycReady" class="tbk-card__alert">
            <h4>Completa estos datos antes de solicitar el alta:</h4>
            <ul>
              <li *ngFor="let item of tbkKycMissing">{{ item }}</li>
            </ul>
            <a routerLink="/dash/perfil">Ir a completar mi perfil</a>
          </div>

          <hr class="tbk-card__divider" />

          <div class="tbk-card__section-header">
            <h4>Mis Comercios Secundarios</h4>
            <button type="button" class="tbk-btn tbk-btn--primary" (click)="openTbkModal()" [disabled]="!tbkCanCreate || !tbkKycReady || tbkActionLoading">
              <span *ngIf="tbkActionLoading && tbkCurrentAction === 'create'; else createBtnLabel">Crear Comercio Secundario</span>
              <ng-template #createBtnLabel>Crear Comercio Secundario</ng-template>
            </button>
          </div>

          <div class="tbk-table-wrapper" *ngIf="tbkSecondaryShops.length; else tbkEmptyState">
            <table class="tbk-table">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>C√≥digo</th>
                  <th>Estado</th>
                  <th class="text-right">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let shop of tbkSecondaryShops">
                  <td>{{ shop.name }}</td>
                  <td>{{ shop.code }}</td>
                  <td>
                    <span class="chip" [ngClass]="chipClass(shop.status)">{{ shop.status | titlecase }}</span>
                  </td>
                  <td class="actions">
                    <button type="button" class="link" (click)="onRefreshTbkStatus()" [disabled]="tbkActionLoading">
                      <span *ngIf="tbkActionLoading && tbkCurrentAction === 'refresh'; else refreshLabel">Actualizando‚Ä¶</span>
                      <ng-template #refreshLabel>Actualizar</ng-template>
                    </button>
                    <button type="button" class="link link--danger" (click)="onRevokeTbkSecondary()" [disabled]="tbkActionLoading">
                      <span *ngIf="tbkActionLoading && tbkCurrentAction === 'revoke'; else revokeLabel">Procesando‚Ä¶</span>
                      <ng-template #revokeLabel>Dar de baja</ng-template>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <ng-template #tbkEmptyState>
            <div class="tbk-empty">
              <div class="tbk-empty__icon">üè¨</div>
              <h5>Sin comercios secundarios</h5>
              <p>Crea tu primer comercio para comenzar a procesar pagos con Webpay Mall.</p>
            </div>
          </ng-template>
        </div>
      </section>

      <ui-financial-kpis 
        [kpis]="financialKPIs"
        (viewDetailsClicked)="onViewDetailsClicked()">
      </ui-financial-kpis>

      <ng-container *ngIf="!incomeGoalLoading; else incomeGoalLoaderTpl">
        <ui-income-goals
          [currentGoal]="currentGoal"
          [currentIncome]="currentIncome"
          [savingGoal]="savingIncomeGoal"
          [goalError]="goalSaveError"
          (goalSet)="onGoalSet($event)"
          (goToSummary)="onGoToSummary()">
        </ui-income-goals>
      </ng-container>

      <ng-template #incomeGoalLoaderTpl>
        <div class="goal-loader metric-card">
          <div class="goal-loader__spinner"></div>
          <p>Cargando metas de ingresos...</p>
        </div>
      </ng-template>

      <ui-transactions-table 
        [transactions]="transactions"
        (viewAllClicked)="onViewAllTransactions()"
        (transactionSelected)="onTransactionSelected($event)">
      </ui-transactions-table>
    </div>
    
    <!-- Pesta√±a: Configuraci√≥n de Pagos -->
    <div *ngIf="activeTab === 'pagos'" class="tab-panel">
      <ui-payment-settings-form 
        [paymentSettings]="paymentSettings"
        (settingsSaved)="onPaymentSettingsSaved($event)"
        (settingsChanged)="onPaymentSettingsChanged($event)">
      </ui-payment-settings-form>
    </div>
    
    <!-- Pesta√±a: Metas de Ingreso -->
    <div *ngIf="activeTab === 'metas'" class="tab-panel">
      <ng-container *ngIf="!incomeGoalLoading; else incomeGoalLoaderMetas">
        <ui-income-goals 
          [currentGoal]="currentGoal"
          [currentIncome]="currentIncome"
          [savingGoal]="savingIncomeGoal"
          [goalError]="goalSaveError"
          (goalSet)="onGoalSet($event)"
          (goToSummary)="onGoToSummary()">
        </ui-income-goals>
      </ng-container>
      <ng-template #incomeGoalLoaderMetas>
        <div class="goal-loader metric-card">
          <div class="goal-loader__spinner"></div>
          <p>Cargando metas de ingresos...</p>
        </div>
      </ng-template>
    </div>
    
  </div>
</div>

<!-- Modal de Creaci√≥n de Comercio Secundario -->
<div *ngIf="tbkModalOpen" class="tbk-modal" role="dialog" aria-modal="true">
  <div class="tbk-modal__backdrop" (click)="closeTbkModal()"></div>
  <div class="tbk-modal__content">
    <form [formGroup]="tbkForm" (ngSubmit)="submitTbkForm()">
      <div class="tbk-modal__header">
        <div class="tbk-modal__icon">üè¶</div>
        <div>
          <h3>Registrar tu comercio en Transbank</h3>
          <p>Ser√°s redirigido al portal seguro de Transbank para ingresar tu informaci√≥n legal y bancaria.</p>
        </div>
      </div>

      <div class="tbk-modal__body">
        <label>
          Nombre de tu Comercio o Servicio
          <input type="text" formControlName="commerceName" placeholder="Ej. Juan P√©rez Plomer√≠a" />
          <small>Este es el nombre que ver√°n tus clientes.</small>
        </label>
        <div class="error" *ngIf="tbkForm.get('commerceName')?.touched && tbkForm.get('commerceName')?.invalid">
          Ingresa un nombre v√°lido (m√≠nimo 3 caracteres).
        </div>

        <label>
          Email de contacto
          <input type="email" formControlName="commerceEmail" placeholder="juan.perez@email.com" />
          <small>Aqu√≠ recibir√°s las notificaciones de Transbank.</small>
        </label>
        <div class="error" *ngIf="tbkForm.get('commerceEmail')?.touched && tbkForm.get('commerceEmail')?.invalid">
          Ingresa un correo v√°lido.
        </div>
      </div>

      <div class="tbk-modal__footer">
        <button type="button" class="tbk-btn tbk-btn--secondary" (click)="closeTbkModal()">Cancelar</button>
        <button type="submit" class="tbk-btn tbk-btn--primary" [disabled]="tbkActionLoading">
          <span *ngIf="tbkActionLoading && tbkCurrentAction === 'create'; else modalSubmitLabel">Conectando‚Ä¶</span>
          <ng-template #modalSubmitLabel>Continuar a Transbank</ng-template>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Toast de notificaciones -->
<div class="tbk-toast" [class.tbk-toast--visible]="tbkToastVisible">
  {{ tbkToastMessage }}
</div>
