<div class="perfil-trabajador">
  <!-- Tabs de navegación -->
  <app-tabs-perfil 
    [activeTab]="activeTab"
    (tabChange)="onTabChange($event)">
  </app-tabs-perfil>

  <!-- Contenido del tab activo -->
  <div class="perfil-trabajador__content">
    
    <!-- Tab: Perfil Público -->
    <div *ngIf="activeTab === 'perfil-publico'" class="perfil-trabajador__tab-content">
      <!-- Progreso del perfil -->
      <app-progress-perfil>
      </app-progress-perfil>

      <!-- Información básica -->
      <app-info-basica 
        [info]="basicInfo"
        [saving]="savingBasicInfo"
        [hasChanges]="basicInfoHasChanges"
        (infoChange)="onBasicInfoChange($event)"
        (saveInfo)="onSaveBasicInfo($event)">
      </app-info-basica>

      <!-- Fotos de perfil -->
      <app-seccion-fotos 
        [profilePhoto]="profilePhoto"
        [coverPhoto]="coverPhoto"
        [saving]="savingPhotos"
        [hasChanges]="photosHasChanges"
        (changeProfilePhoto)="onPhotosChange()"
        (changeCoverPhoto)="onPhotosChange()"
        (savePhotos)="onSavePhotos($event)">
      </app-seccion-fotos>

      <!-- Sobre mí -->
      <app-sobre-mi 
        [bio]="bio"
        (bioChange)="onBioChange($event)">
      </app-sobre-mi>

      <!-- Mis servicios -->
      <app-mis-servicios 
        #misServiciosComponent
        [services]="services"
        (editService)="onEditService($event)"
        (deleteService)="onDeleteService($event)"
        (addService)="onSaveService($event)">
      </app-mis-servicios>

      <!-- Portafolio -->
      <app-portafolio 
        [images]="portfolioImages"
        [maxImages]="10"
        (addImage)="onAddPortfolioImage()"
        (addVideo)="onAddPortfolioVideo()"
        (deleteImage)="onDeletePortfolioImage($event)">
      </app-portafolio>

      <!-- Ubicación y Disponibilidad -->
      <app-ubicacion-disponibilidad 
        [settings]="locationSettings"
        (settingsChange)="onLocationSettingsChange($event)"
        (addCoverageZone)="onAddCoverageZone($event)"
        (removeCoverageZone)="onRemoveCoverageZone($event)"
        (requestCurrentLocation)="onRequestCurrentLocation()"
        (setZoneLocation)="onSetZoneLocation($event)"
        (setZonePrimary)="onSetZonePrimary($event)">
      </app-ubicacion-disponibilidad>

      <!-- Botón para guardar cambios del perfil público -->
      <div class="perfil-publico__actions">
        <ui-button variant="primary" (click)="savePublicProfile()" [loading]="savingPublicProfile">
          Guardar cambios del perfil
        </ui-button>
      </div>
    </div>

    <!-- Tab: Verificación -->
    <div *ngIf="activeTab === 'verificacion'" class="perfil-trabajador__tab-content">
      <app-verificacion-perfil></app-verificacion-perfil>
    </div>

    <!-- Tab: Configuración -->
    <div *ngIf="activeTab === 'configuracion'" class="perfil-trabajador__tab-content">
      <!-- Configuración del Perfil de la Aplicación -->
      <section class="configuracion-app">
        <h2 class="configuracion-app__title">Configuración del Perfil de la Aplicación</h2>
        <p class="configuracion-app__subtitle">Estas configuraciones son privadas y solo las ves tú. No afectan tu perfil público.</p>
        
        <div class="configuracion-app__content">
          <div class="configuracion-app__avatar">
            <avatar-uploader [(src)]="avatar"></avatar-uploader>
          </div>
          
          <div class="configuracion-app__fields">
            <ui-input label="Nombre" placeholder="Tu nombre" [(value)]="name"></ui-input>
            <ui-input label="Teléfono" placeholder="Ej: +56 9 1234 5678" [(value)]="phone"></ui-input>
            
            <div class="configuracion-app__field">
              <label class="configuracion-app__label">Idioma</label>
              <language-select [(value)]="lang"></language-select>
            </div>
            
            <div class="configuracion-app__field">
              <label class="configuracion-app__label">Notificaciones</label>
              <notification-toggle [(email)]="emailNoti" [(push)]="pushNoti"></notification-toggle>
            </div>
          </div>
          
          <div class="configuracion-app__actions">
            <ui-button variant="primary" (click)="save()">Guardar cambios</ui-button>
          </div>
        </div>
      </section>

      <!-- Horario y Disponibilidad -->
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
        <app-online-status-switch [isOnline]="locationSettings.availableForNewBookings" (statusChange)="onOnlineToggle($event)"></app-online-status-switch>
        <span style="font-size:12px; color:#6b7280;">Si estás Online, podrás aparecer en búsquedas “Ahora” cuando tu horario lo permita.</span>
      </div>
      <app-horario-disponibilidad 
        [schedule]="weeklySchedule"
        (scheduleChange)="onScheduleChange($event)"
        (addTimeBlock)="onAddTimeBlock($event)"
        (removeTimeBlock)="onRemoveTimeBlock($event)"
        (toggleDay)="onToggleDay($event)">
      </app-horario-disponibilidad>

      <div class="perfil-publico__actions" style="margin-top: 16px; display: flex; justify-content: flex-end;">
        <ui-button variant="primary" (click)="saveWeeklySchedule()" [loading]="savingWeeklySchedule">
          Guardar Horario
        </ui-button>
      </div>

      <!-- Excepciones y Feriados -->
      <app-excepciones-feriados 
        [exceptions]="exceptions"
        (exceptionsChange)="onExceptionsChange($event)"
        (addException)="onAddException($event)"
        (removeException)="onRemoveException($event)">
      </app-excepciones-feriados>
    </div>

    <!-- Tab: Ver Perfil Público -->
    <div *ngIf="activeTab === 'ver-perfil-publico'" class="perfil-trabajador__tab-content">
      <div class="ver-perfil-publico">
        <div class="ver-perfil-publico__header">
          <h2 class="ver-perfil-publico__title">Vista Previa del Perfil Público</h2>
          <p class="ver-perfil-publico__subtitle">Así es como los clientes verán tu perfil</p>
        </div>
        
        <div class="ver-perfil-publico__preview">
          <div class="profile-preview">
            <!-- Header del perfil -->
            <div class="profile-preview__header">
              <div class="profile-preview__avatar">
                <img [src]="profilePhoto || avatar || 'https://placehold.co/120x120/C7D2FE/4338CA?text=ET'" alt="Avatar">
              </div>
              <div class="profile-preview__info">
                <h1 class="profile-preview__name">{{ basicInfo.fullName }}</h1>
                <p class="profile-preview__title">{{ basicInfo.professionalTitle || 'Profesional independiente' }}</p>
                <p class="profile-preview__location">{{ basicInfo.mainCommune || 'Comuna no especificada' }}</p>
                <div class="profile-preview__rating">
                  <span class="rating-stars">{{ ratingStars }}</span>
                  <span class="rating-text">{{ ratingSummary }}</span>
                </div>
              </div>
            </div>

            <!-- Información básica -->
            <div class="profile-preview__section">
              <h3>Sobre mí</h3>
              <p>{{ bio }}</p>
            </div>

            <!-- Servicios -->
            <div class="profile-preview__section">
              <h3>Mis Servicios</h3>
              <div class="services-preview">
                <div *ngFor="let service of services" class="service-preview">
                  <div class="service-preview__info">
                    <h4>{{ service.name }}</h4>
                    <p>{{ service.duration_minutes }} min</p>
                  </div>
                  <div class="service-preview__price">
                    ${{ service.price | number }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Portafolio -->
            <div class="profile-preview__section portfolio-preview" *ngIf="portfolioImages.length > 0">
              <div class="portfolio-preview__header">
                <h3>Portafolio</h3>
                <button 
                  *ngIf="portfolioImages.length > portfolioPreviewLimit"
                  type="button"
                  class="portfolio-preview__see-all"
                  (click)="openPortfolioLightbox(0)">
                  Ver todo el portafolio
                </button>
              </div>

              <div class="portfolio-gallery">
                <button
                  type="button"
                  class="portfolio-gallery__card"
                  *ngFor="let item of portfolioImages | slice:0:portfolioPreviewLimit; let i = index"
                  (click)="openPortfolioLightbox(i)">
                  <span class="portfolio-gallery__badge" [class.portfolio-gallery__badge--video]="item.type === 'video'">
                    {{ item.type === 'video' ? 'Video' : 'Foto' }}
                  </span>
                  <ng-container [ngSwitch]="item.type">
                    <img
                      *ngSwitchCase="'image'"
                      [src]="item.url"
                      [alt]="item.alt"
                      loading="lazy">
                    <img
                      *ngSwitchCase="'video'"
                      [src]="item.thumbnailUrl || item.url"
                      [alt]="item.alt"
                      loading="lazy"
                      class="portfolio-gallery__thumb">
                  </ng-container>
                  <div class="portfolio-gallery__overlay">
                    <span>Ver detalle</span>
                  </div>
                </button>
              </div>

              <button
                *ngIf="portfolioImages.length > portfolioPreviewLimit"
                type="button"
                class="portfolio-preview__cta"
                (click)="openPortfolioLightbox(0)">
                Mostrar las {{ portfolioImages.length }} piezas
              </button>
            </div>

            <!-- Botón de reserva -->
            <div class="profile-preview__actions">
              <button class="btn-reserve">Reservar Cita</button>
            </div>

            <!-- Comentarios de clientes -->
            <app-reviews [data]="publicReviewsData"></app-reviews>
          </div>
        </div>

        <div class="ver-perfil-publico__actions">
          <ui-button variant="primary" (click)="openPublicProfile()">
            Abrir Perfil Público
          </ui-button>
          <ui-button variant="secondary" (click)="shareProfile()">
            Compartir Perfil
          </ui-button>
        </div>
      </div>
    </div>

  </div>

  <div class="portfolio-lightbox" *ngIf="portfolioLightboxOpen" (click)="closePortfolioLightbox()">
    <div class="portfolio-lightbox__dialog" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
      <button type="button" class="portfolio-lightbox__close" aria-label="Cerrar" (click)="closePortfolioLightbox()">×</button>

      <button
        type="button"
        class="portfolio-lightbox__nav portfolio-lightbox__nav--prev"
        (click)="previousPortfolioItem()"
        [disabled]="portfolioImages.length <= 1"
        aria-label="Anterior">
        ‹
      </button>

      <div class="portfolio-lightbox__media" *ngIf="activePortfolioItem as activeItem">
        <ng-container [ngSwitch]="activeItem.type">
          <img *ngSwitchCase="'image'" [src]="activeItem.url" [alt]="activeItem.alt">
          <video *ngSwitchCase="'video'" [src]="activeItem.url" controls autoplay playsinline>
            Tu navegador no soporta la reproducción de video.
          </video>
        </ng-container>

        <div class="portfolio-lightbox__meta">
          <div class="portfolio-lightbox__meta-primary">
            <span class="portfolio-lightbox__chip">{{ activeItem.type === 'video' ? 'Video' : 'Fotografía' }}</span>
            <span class="portfolio-lightbox__index">{{ portfolioLightboxIndex + 1 }} / {{ portfolioImages.length }}</span>
          </div>
          <h4>{{ activeItem.alt }}</h4>
        </div>
      </div>

      <button
        type="button"
        class="portfolio-lightbox__nav portfolio-lightbox__nav--next"
        (click)="nextPortfolioItem()"
        [disabled]="portfolioImages.length <= 1"
        aria-label="Siguiente">
        ›
      </button>

      <div class="portfolio-lightbox__thumbs" *ngIf="portfolioImages.length > 1">
        <button
          type="button"
          class="portfolio-lightbox__thumb"
          *ngFor="let item of portfolioImages; let i = index"
          [class.portfolio-lightbox__thumb--active]="i === portfolioLightboxIndex"
          (click)="goToPortfolioItem(i)">
          <img [src]="item.thumbnailUrl || item.url" [alt]="item.alt">
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de crear/editar servicio -->
  <app-modal-crear-servicio
    [isOpen]="showServiceModal"
    [editingService]="editingService"
    [saving]="savingService"
    (close)="onCloseServiceModal()"
    (save)="onSaveService($event)">
  </app-modal-crear-servicio>
</div>
