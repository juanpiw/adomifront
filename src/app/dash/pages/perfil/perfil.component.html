<div class="perfil-trabajador">
  <!-- Tabs de navegación -->
  <app-tabs-perfil
    *ngIf="!showDatosView"
    [activeTab]="activeTab"
    (tabChange)="onTabChange($event)">
  </app-tabs-perfil>

  <!-- Contenido del tab activo -->
  <div class="perfil-trabajador__content">
    <div *ngIf="showDatosView" class="perfil-trabajador__tab-content perfil-trabajador__datos-view">
      <header class="perfil-trabajador__datos-header">
        <div>
          <h2>Datos Publicados</h2>
          <p>Mostrando los datos del feed con la misma fuente usada en exploración.</p>
        </div>
        <button type="button" class="perfil-trabajador__datos-back" (click)="showDatosView = false; activeTab = 'perfil-publico'">
          Volver al perfil
        </button>
      </header>

      <div *ngIf="misDatosLoading" class="perfil-trabajador__datos-loading">
        Cargando datos...
      </div>

      <ui-mis-datos-panel *ngIf="!misDatosLoading" [datos]="misDatos"></ui-mis-datos-panel>
    </div>
    
    <!-- Tab: Perfil Público -->
    <div *ngIf="!showDatosView && activeTab === 'perfil-publico'" class="perfil-trabajador__tab-content">
      <!-- Progreso del perfil -->
      <app-progress-perfil>
      </app-progress-perfil>

      <!-- Información básica -->
      <app-info-basica 
        [info]="basicInfo"
        [saving]="savingBasicInfo"
        [hasChanges]="basicInfoHasChanges"
        (infoChange)="onBasicInfoChange($event)"
        (saveInfo)="onSaveBasicInfo($event)">
      </app-info-basica>

      <!-- Fotos de perfil -->
      <app-seccion-fotos 
        [profilePhoto]="profilePhoto"
        [coverPhoto]="coverPhoto"
        [saving]="savingPhotos"
        [hasChanges]="photosHasChanges"
        (changeProfilePhoto)="onPhotosChange()"
        (changeCoverPhoto)="onPhotosChange()"
        (savePhotos)="onSavePhotos($event)">
      </app-seccion-fotos>

      <!-- Sobre mí -->
      <app-sobre-mi 
        [bio]="bio"
        (bioChange)="onBioChange($event)">
      </app-sobre-mi>

      <!-- Mis servicios -->
      <app-mis-servicios 
        #misServiciosComponent
        [services]="services"
        (editService)="onEditService($event)"
        (deleteService)="onDeleteService($event)"
        (addService)="onSaveService($event)">
      </app-mis-servicios>

      <!-- Portafolio -->
      <app-portafolio 
        [images]="portfolioImages"
        [maxImages]="10"
        (addImage)="onAddPortfolioImage()"
        (addVideo)="onAddPortfolioVideo()"
        (deleteImage)="onDeletePortfolioImage($event)">
      </app-portafolio>

      <!-- Ubicación y Disponibilidad -->
      <app-ubicacion-disponibilidad 
        [settings]="locationSettings"
        (settingsChange)="onLocationSettingsChange($event)"
        (addCoverageZone)="onAddCoverageZone($event)"
        (removeCoverageZone)="onRemoveCoverageZone($event)"
        (requestCurrentLocation)="onRequestCurrentLocation()"
        (setZoneLocation)="onSetZoneLocation($event)"
        (setZonePrimary)="onSetZonePrimary($event)">
      </app-ubicacion-disponibilidad>

      <div class="live-location-status"
           [attr.data-state]="liveLocationStatus">
        <span class="live-location-status__dot"></span>
        <div class="live-location-status__body">
          <p class="live-location-status__title">{{ liveLocationStatusLabel }}</p>
          <p *ngIf="liveLocationMessage" class="live-location-status__message">{{ liveLocationMessage }}</p>
        </div>
        <button type="button"
                class="live-location-status__action"
                (click)="onRequestCurrentLocation()"
                [disabled]="liveLocationStatus === 'requesting' || liveLocationSending">
          {{ liveLocationSending ? 'Enviando...' : 'Actualizar ahora' }}
        </button>
      </div>

      <!-- Preguntas frecuentes -->
      <section class="faq-manager">
        <div class="faq-manager__header">
          <h3 class="faq-manager__title">Preguntas frecuentes</h3>
          <p class="faq-manager__subtitle">Comparte hasta {{ faqMax }} respuestas a las dudas más comunes de tus clientes.</p>
        </div>

        <div *ngIf="faqError" class="faq-alert faq-alert--error">{{ faqError }}</div>
        <div *ngIf="faqSuccess" class="faq-alert faq-alert--success">{{ faqSuccess }}</div>
        <div *ngIf="faqInfo" class="faq-alert faq-alert--info">{{ faqInfo }}</div>

        <div class="faq-manager__list">
          <div class="faq-item" *ngFor="let faq of faqs; let i = index">
            <div class="faq-item__order">
              <button type="button" class="faq-item__order-btn" (click)="moveFaq(i, -1)" [disabled]="i === 0">↑</button>
              <button type="button" class="faq-item__order-btn" (click)="moveFaq(i, 1)" [disabled]="i === faqs.length - 1">↓</button>
            </div>
            <div class="faq-item__fields">
              <label>Pregunta</label>
              <input type="text" [(ngModel)]="faq.question" (ngModelChange)="onFaqChange(i)" placeholder="¿Cuál es la pregunta más común?" />
              <label>Respuesta</label>
              <textarea rows="3" [(ngModel)]="faq.answer" (ngModelChange)="onFaqChange(i)" placeholder="Escribe la respuesta que compartes con tus clientes"></textarea>
            </div>
            <button type="button" class="faq-item__delete" (click)="onRemoveFaq(i)">Eliminar</button>
          </div>

          <p *ngIf="!faqs.length" class="faq-manager__empty">Aún no tienes preguntas frecuentes. Añade las dudas que más recibes para ayudar a tus clientes a decidir.</p>
        </div>

        <div class="faq-manager__actions">
          <button type="button" class="faq-manager__btn" (click)="onAddFaq()" [disabled]="faqLoading || faqs.length >= faqMax">
            Añadir pregunta
          </button>
          <button type="button" class="faq-manager__btn faq-manager__btn--primary" (click)="onSaveFaqs()" [disabled]="faqLoading">
            {{ faqLoading ? 'Guardando…' : 'Guardar preguntas frecuentes' }}
          </button>
        </div>
      </section>

      <!-- Botón para guardar cambios del perfil público -->
      <div class="perfil-publico__actions">
        <ui-button variant="primary" (click)="savePublicProfile()" [loading]="savingPublicProfile">
          Guardar cambios del perfil
        </ui-button>
      </div>
    </div>

    <!-- Tab: Verificación -->
    <div *ngIf="!showDatosView && activeTab === 'verificacion'" class="perfil-trabajador__tab-content">
      <app-verificacion-perfil></app-verificacion-perfil>
    </div>

    <!-- Tab: Configuración -->
    <div *ngIf="!showDatosView && activeTab === 'configuracion'" class="perfil-trabajador__tab-content">
      <!-- Configuración del Perfil de la Aplicación -->
      <section class="configuracion-app">
        <h2 class="configuracion-app__title">Configuración del Perfil de la Aplicación</h2>
        <p class="configuracion-app__subtitle">Estas configuraciones son privadas y solo las ves tú. No afectan tu perfil público.</p>
        
        <div class="configuracion-app__content">
          <div class="configuracion-app__avatar">
            <avatar-uploader [(src)]="avatar"></avatar-uploader>
          </div>
          
          <div class="configuracion-app__fields">
            <ui-input label="Nombre" placeholder="Tu nombre" [(value)]="name"></ui-input>
            <ui-input label="Teléfono" placeholder="Ej: +56 9 1234 5678" [(value)]="phone"></ui-input>
            
            <div class="configuracion-app__field">
              <label class="configuracion-app__label">Idioma</label>
              <language-select [(value)]="lang"></language-select>
            </div>
            
            <div class="configuracion-app__field">
              <label class="configuracion-app__label">Notificaciones</label>
              <notification-toggle [(email)]="emailNoti" [(push)]="pushNoti"></notification-toggle>
            </div>
          </div>
          
          <div class="configuracion-app__actions">
            <ui-button variant="primary" (click)="save()">Guardar cambios</ui-button>
          </div>
        </div>
      </section>

      <!-- Seguridad y Contraseña (proveedor) -->
      <section class="security-card" *ngIf="showSecurityPanel">
        <header class="security-card__header">
          <div>
            <h3>Seguridad y Contraseña</h3>
            <p>Actualiza tu contraseña para mantener tu cuenta protegida.</p>
          </div>
          <button type="button" class="security-card__close" (click)="toggleSecurityPanel(false)">×</button>
        </header>

        <form class="security-form" (ngSubmit)="submitSecurityForm()">
          <div class="security-form__grid">
            <label class="security-field">
              <span class="security-field__label">Contraseña actual (opcional)</span>
              <div class="security-field__input-wrapper">
                <input
                  [type]="passwordInputType('current')"
                  autocomplete="current-password"
                  [(ngModel)]="securityForm.currentPassword"
                  name="currentPassword"
                  placeholder="Ingresa tu contraseña actual" />
                <button
                  type="button"
                  class="security-field__toggle"
                  (click)="togglePasswordVisibility('current')"
                  [attr.aria-pressed]="isPasswordVisible('current')"
                  aria-label="Mostrar u ocultar contraseña actual">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path *ngIf="!isPasswordVisible('current')" d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                    <path *ngIf="!isPasswordVisible('current')" d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
                    <path *ngIf="isPasswordVisible('current')" d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.76 21.76 0 0 1 5.06-6.88"></path>
                    <path *ngIf="isPasswordVisible('current')" d="M1 1l22 22"></path>
                  </svg>
                </button>
              </div>
            </label>

            <label class="security-field">
              <span class="security-field__label">Nueva contraseña</span>
              <div class="security-field__input-wrapper">
                <input
                  [type]="passwordInputType('new')"
                  autocomplete="new-password"
                  [(ngModel)]="securityForm.newPassword"
                  name="newPassword"
                  required
                  minlength="6"
                  placeholder="Mínimo 6 caracteres" />
                <button
                  type="button"
                  class="security-field__toggle"
                  (click)="togglePasswordVisibility('new')"
                  [attr.aria-pressed]="isPasswordVisible('new')"
                  aria-label="Mostrar u ocultar nueva contraseña">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path *ngIf="!isPasswordVisible('new')" d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                    <path *ngIf="!isPasswordVisible('new')" d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
                    <path *ngIf="isPasswordVisible('new')" d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.76 21.76 0 0 1 5.06-6.88"></path>
                    <path *ngIf="isPasswordVisible('new')" d="M1 1l22 22"></path>
                  </svg>
                </button>
              </div>
            </label>

            <label class="security-field">
              <span class="security-field__label">Confirmar nueva contraseña</span>
              <div class="security-field__input-wrapper">
                <input
                  [type]="passwordInputType('confirm')"
                  autocomplete="new-password"
                  [(ngModel)]="securityForm.confirmPassword"
                  name="confirmPassword"
                  required
                  minlength="6"
                  placeholder="Repítela para confirmar" />
                <button
                  type="button"
                  class="security-field__toggle"
                  (click)="togglePasswordVisibility('confirm')"
                  [attr.aria-pressed]="isPasswordVisible('confirm')"
                  aria-label="Mostrar u ocultar confirmación de contraseña">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path *ngIf="!isPasswordVisible('confirm')" d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                    <path *ngIf="!isPasswordVisible('confirm')" d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
                    <path *ngIf="isPasswordVisible('confirm')" d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.76 21.76 0 0 1 5.06-6.88"></path>
                    <path *ngIf="isPasswordVisible('confirm')" d="M1 1l22 22"></path>
                  </svg>
                </button>
              </div>
            </label>
          </div>

          <div
            class="security-feedback"
            [class.security-feedback--success]="securityMessageType === 'success'"
            [class.security-feedback--error]="securityMessageType === 'error'"
            *ngIf="securityMessage">
            {{ securityMessage }}
          </div>

          <div class="security-actions">
            <button
              type="submit"
              class="security-actions__save"
              [disabled]="securitySubmitting">
              {{ securitySubmitting ? 'Guardando...' : 'Guardar contraseña' }}
            </button>
            <button
              type="button"
              class="security-actions__cancel"
              (click)="toggleSecurityPanel(false)"
              [disabled]="securitySubmitting">
              Cancelar
            </button>
          </div>
        </form>
      </section>

      <button
        *ngIf="!showSecurityPanel"
        type="button"
        class="security-actions__save"
        style="margin-bottom: 1rem;"
        (click)="toggleSecurityPanel(true)">
        Configurar contraseña
      </button>

      <!-- Horario y Disponibilidad -->
      <div class="online-status-hint">
        <app-online-status-switch [isOnline]="locationSettings.availableForNewBookings" (statusChange)="onOnlineToggle($event)"></app-online-status-switch>
        <span class="online-status-hint__text">Si estás Online, podrás aparecer en búsquedas “Ahora” cuando tu horario lo permita.</span>
      </div>
      <app-horario-disponibilidad 
        [schedule]="weeklySchedule"
        [loading]="availabilityLoading || savingWeeklySchedule"
        (scheduleChange)="onScheduleChange($event)"
        (addTimeBlock)="onAddTimeBlock($event)"
        (removeTimeBlock)="onRemoveTimeBlock($event)"
        (toggleDay)="onToggleDay($event)">
      </app-horario-disponibilidad>

      <div class="perfil-publico__actions" style="margin-top: 16px; display: flex; justify-content: flex-end;">
        <ui-button variant="primary" (click)="saveWeeklySchedule()" [loading]="savingWeeklySchedule">
          Guardar Horario
        </ui-button>
      </div>

      <!-- Excepciones y Feriados -->
      <app-excepciones-feriados 
        [exceptions]="exceptions"
        [loading]="exceptionsLoading"
        (exceptionsChange)="onExceptionsChange($event)"
        (addException)="onAddException($event)"
        (removeException)="onRemoveException($event)">
      </app-excepciones-feriados>
    </div>

    <!-- Tab: Ver Perfil Público -->
    <div *ngIf="!showDatosView && activeTab === 'ver-perfil-publico'" class="perfil-trabajador__tab-content">
      <div class="ver-perfil-publico">
        <div class="ver-perfil-publico__header">
          <h2 class="ver-perfil-publico__title">Vista Previa del Perfil Público</h2>
          <p class="ver-perfil-publico__subtitle">Así es como los clientes verán tu perfil</p>
        </div>
        
        <div class="ver-perfil-publico__preview">
          <div class="profile-preview">
            <!-- Header del perfil -->
            <div class="profile-preview__header">
              <div class="profile-preview__avatar">
                <img [src]="profilePhoto || avatar || 'https://placehold.co/120x120/C7D2FE/4338CA?text=ET'" alt="Avatar">
              </div>
              <div class="profile-preview__info">
                <h1 class="profile-preview__name">{{ basicInfo.fullName }}</h1>
                <p class="profile-preview__title">{{ basicInfo.professionalTitle || 'Profesional independiente' }}</p>
                <p class="profile-preview__location">{{ basicInfo.mainCommune || 'Comuna no especificada' }}</p>
                <div class="profile-preview__rating">
                  <span class="rating-stars">{{ ratingStars }}</span>
                  <span class="rating-text">{{ ratingSummary }}</span>
                </div>
              </div>
            </div>

            <!-- Información básica -->
            <div class="profile-preview__section">
              <h3>Sobre mí</h3>
              <p>{{ bio }}</p>
            </div>

            <!-- Servicios -->
            <div class="profile-preview__section">
              <h3>Mis Servicios</h3>
              <div class="services-preview">
                <div *ngFor="let service of services" class="service-preview">
                  <div class="service-preview__info">
                    <h4>{{ service.name }}</h4>
                    <p>{{ service.duration_minutes }} min</p>
                  </div>
                  <div class="service-preview__price">
                    ${{ service.price | number }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Portafolio -->
            <div class="profile-preview__section portfolio-preview" *ngIf="portfolioImages.length > 0">
              <div class="portfolio-preview__header">
                <h3>Portafolio</h3>
                <button 
                  *ngIf="portfolioImages.length > portfolioPreviewLimit"
                  type="button"
                  class="portfolio-preview__see-all"
                  (click)="openPortfolioLightbox(0)">
                  Ver todo el portafolio
                </button>
              </div>

              <div class="portfolio-gallery">
                <button
                  type="button"
                  class="portfolio-gallery__card"
                  *ngFor="let item of portfolioImages | slice:0:portfolioPreviewLimit; let i = index"
                  (click)="openPortfolioLightbox(i)">
                  <span class="portfolio-gallery__badge" [class.portfolio-gallery__badge--video]="item.type === 'video'">
                    {{ item.type === 'video' ? 'Video' : 'Foto' }}
                  </span>
                  <ng-container [ngSwitch]="item.type">
                    <img
                      *ngSwitchCase="'image'"
                      [src]="item.url"
                      [alt]="item.alt"
                      loading="lazy">
                    <img
                      *ngSwitchCase="'video'"
                      [src]="item.thumbnailUrl || item.url"
                      [alt]="item.alt"
                      loading="lazy"
                      class="portfolio-gallery__thumb">
                  </ng-container>
                  <div class="portfolio-gallery__overlay">
                    <span>Ver detalle</span>
                  </div>
                </button>
              </div>

              <button
                *ngIf="portfolioImages.length > portfolioPreviewLimit"
                type="button"
                class="portfolio-preview__cta"
                (click)="openPortfolioLightbox(0)">
                Mostrar las {{ portfolioImages.length }} piezas
              </button>
            </div>

            <!-- Botón de reserva -->
            <div class="profile-preview__actions">
              <button class="btn-reserve">Reservar Cita</button>
            </div>

            <!-- Preguntas frecuentes -->
            <div class="profile-preview__section" *ngIf="faqs.length > 0">
              <h3>Preguntas frecuentes</h3>
              <div class="profile-preview__faq">
                <div class="profile-preview__faq-item" *ngFor="let faq of faqs">
                  <p class="profile-preview__faq-question">{{ faq.question }}</p>
                  <p class="profile-preview__faq-answer">{{ faq.answer }}</p>
                </div>
              </div>
            </div>

            <!-- Comentarios de clientes -->
            <app-reviews [data]="publicReviewsData"></app-reviews>
          </div>
        </div>

        <div class="ver-perfil-publico__actions">
          <ui-button variant="primary" (click)="openPublicProfile()">
            Abrir Perfil Público
          </ui-button>
          <ui-button variant="secondary" (click)="shareProfile()">
            Compartir Perfil
          </ui-button>
        </div>
      </div>
    </div>

  </div>

  <div class="portfolio-lightbox" *ngIf="portfolioLightboxOpen" (click)="closePortfolioLightbox()">
    <div class="portfolio-lightbox__dialog" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
      <button type="button" class="portfolio-lightbox__close" aria-label="Cerrar" (click)="closePortfolioLightbox()">×</button>

      <button
        type="button"
        class="portfolio-lightbox__nav portfolio-lightbox__nav--prev"
        (click)="previousPortfolioItem()"
        [disabled]="portfolioImages.length <= 1"
        aria-label="Anterior">
        ‹
      </button>

      <div class="portfolio-lightbox__media" *ngIf="activePortfolioItem as activeItem">
        <ng-container [ngSwitch]="activeItem.type">
          <img *ngSwitchCase="'image'" [src]="activeItem.url" [alt]="activeItem.alt">
          <video *ngSwitchCase="'video'" [src]="activeItem.url" controls autoplay playsinline>
            Tu navegador no soporta la reproducción de video.
          </video>
        </ng-container>

        <div class="portfolio-lightbox__meta">
          <div class="portfolio-lightbox__meta-primary">
            <span class="portfolio-lightbox__chip">{{ activeItem.type === 'video' ? 'Video' : 'Fotografía' }}</span>
            <span class="portfolio-lightbox__index">{{ portfolioLightboxIndex + 1 }} / {{ portfolioImages.length }}</span>
          </div>
          <h4>{{ activeItem.alt }}</h4>
        </div>
      </div>

      <button
        type="button"
        class="portfolio-lightbox__nav portfolio-lightbox__nav--next"
        (click)="nextPortfolioItem()"
        [disabled]="portfolioImages.length <= 1"
        aria-label="Siguiente">
        ›
      </button>

      <div class="portfolio-lightbox__thumbs" *ngIf="portfolioImages.length > 1">
        <button
          type="button"
          class="portfolio-lightbox__thumb"
          *ngFor="let item of portfolioImages; let i = index"
          [class.portfolio-lightbox__thumb--active]="i === portfolioLightboxIndex"
          (click)="goToPortfolioItem(i)">
          <img [src]="item.thumbnailUrl || item.url" [alt]="item.alt">
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de crear/editar servicio -->
  <app-modal-crear-servicio
    [isOpen]="showServiceModal"
    [editingService]="editingService"
    [saving]="savingService"
    (close)="onCloseServiceModal()"
    (save)="onSaveService($event)">
  </app-modal-crear-servicio>
</div>
