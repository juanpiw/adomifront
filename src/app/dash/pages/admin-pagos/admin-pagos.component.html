<div class="admin-pagos">
  <h2>Administración de Pagos</h2>

  <div class="filters">
    <label>Rango:</label>
    <select #rangeSel (change)="0">
      <option value="day">Hoy</option>
      <option value="week">Esta semana</option>
      <option value="month">Este mes</option>
      <option value="all">Todo</option>
    </select>
    <button (click)="applyRange(rangeSel.value)">Aplicar</button>
    <label style="margin-left:12px;">Gateway:</label>
    <select #gwSel (change)="setGateway(gwSel.value)">
      <option value="">Todos</option>
      <option value="tbk">TBK</option>
      <option value="stripe">Stripe</option>
      <option value="cash">Efectivo</option>
    </select>
    <button (click)="exportCsv()">Export CSV</button>
  </div>

  <app-admin-summary-cards [summary]="summary"></app-admin-summary-cards>

  <section *ngIf="gateway === 'cash' && adminSecret" class="admin-cash">
    <div class="admin-cash__header">
      <div>
        <h3>Comisiones de Pagos en Efectivo</h3>
        <p>Monitorea el total adeudado por los proveedores y filtra por estado.</p>
      </div>
      <button type="button" class="admin-cash__refresh" (click)="refreshAdminCash()" [disabled]="cashSummaryLoading || cashLoading">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 19a9 9 0 0014.1-2.1M19 5a9 9 0 00-14.1 2.1" />
        </svg>
        Actualizar
      </button>
    </div>

    <div class="admin-cash__summary">
      <div class="admin-cash__metric">
        <span>Total adeudado</span>
        <strong>
          <ng-container *ngIf="!cashSummaryLoading; else cashSummarySkeleton">
            {{ cashSummary?.total_due | currency:'CLP':'symbol':'1.0-0':'es-CL' }}
          </ng-container>
        </strong>
      </div>
      <div class="admin-cash__metric">
        <span>Vencido</span>
        <strong>
          <ng-container *ngIf="!cashSummaryLoading; else cashSummarySkeleton">
            {{ cashSummary?.overdue_due | currency:'CLP':'symbol':'1.0-0':'es-CL' }}
          </ng-container>
        </strong>
      </div>
      <div class="admin-cash__metric">
        <span>Pendientes</span>
        <strong>{{ cashSummary?.pending_count || 0 }}</strong>
      </div>
      <div class="admin-cash__metric">
        <span>Vencidas</span>
        <strong>{{ cashSummary?.overdue_count || 0 }}</strong>
      </div>
      <div class="admin-cash__metric">
        <span>Pagadas</span>
        <strong>{{ cashSummary?.paid_count || 0 }}</strong>
      </div>
    </div>

    <ng-template #cashSummarySkeleton>
      <span class="admin-cash__loading-bar"></span>
    </ng-template>

    <div class="admin-cash__filters">
      <button type="button" class="admin-cash__filter" [class.admin-cash__filter--active]="cashFilter==='pending'" (click)="setCashFilterAdmin('pending')">Pendientes</button>
      <button type="button" class="admin-cash__filter" [class.admin-cash__filter--active]="cashFilter==='overdue'" (click)="setCashFilterAdmin('overdue')">Vencidas</button>
      <button type="button" class="admin-cash__filter" [class.admin-cash__filter--active]="cashFilter==='paid'" (click)="setCashFilterAdmin('paid')">Pagadas</button>
      <button type="button" class="admin-cash__filter" [class.admin-cash__filter--active]="cashFilter==='all'" (click)="setCashFilterAdmin('all')">Todas</button>
    </div>

    <table class="admin-cash__table">
      <thead>
        <tr>
          <th>Proveedor</th>
          <th>Cliente</th>
          <th>Servicio / Cita</th>
          <th>Monto Comisión</th>
          <th>Vencimiento</th>
          <th>Estado</th>
          <th>Referencia</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="cashLoading">
          <td colspan="7" class="admin-cash__table-loading"><span class="cash-spinner"></span> Cargando deudas...</td>
        </tr>
        <tr *ngIf="!cashLoading && cashDebts.length === 0">
          <td colspan="7" class="admin-cash__table-empty">No hay comisiones para este estado.</td>
        </tr>
        <tr *ngFor="let c of cashDebts">
          <td>
            <div class="admin-cash__provider">{{ c.provider_name || c.provider_email }}</div>
            <div class="admin-cash__muted">ID #{{ c.provider_id }}</div>
          </td>
          <td>{{ c.client_name || c.client_email || '—' }}</td>
          <td>
            <div class="admin-cash__muted">Cita #{{ c.appointment_id || '—' }}</div>
            <div class="admin-cash__muted">{{ c.date ? (c.date | date:'dd/MM/yyyy') : '—' }} · {{ c.start_time ? (c.start_time | date:'HH:mm') : '' }}</div>
          </td>
          <td>{{ c.commission_amount | currency:'CLP':'symbol':'1.0-0':'es-CL' }}</td>
          <td>{{ c.due_date ? (c.due_date | date:'dd/MM/yyyy') : '—' }}</td>
          <td>
            <span class="badge" [ngClass]="{
              'badge--pending': c.status==='pending',
              'badge--overdue': c.status==='overdue',
              'badge--paid': c.status==='paid'
            }">{{ c.status }}</span>
          </td>
          <td>
            <div *ngIf="c.settlement_reference; else noRef">{{ c.settlement_reference }}</div>
            <ng-template #noRef>—</ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </section>

  <div *ngIf="!adminSecret" style="margin:12px 0;">
    <label>Admin Secret</label>
    <input type="password" [(ngModel)]="adminSecret" placeholder="Pega el ADMIN_PANEL_SECRET" />
    <button class="btn-primary" (click)="setSecretAndLoad()">Acceder</button>
  </div>

  <section *ngIf="adminSecret" class="founder-card">
    <div class="founder-card__header">
      <div>
        <h3>Plan Fundador · Generador de códigos</h3>
        <p>Emite un código exclusivo y envíalo por correo al profesional invitado.</p>
      </div>
      <button type="button" class="founder-card__reset" (click)="resetFounderForm()" *ngIf="founderCode">Limpiar</button>
    </div>

    <div class="founder-card__content">
      <div class="founder-card__column">
        <h4>1. Configura la promoción</h4>
        <div class="founder-card__field">
          <label>Duración promocional (meses)</label>
          <input type="number" min="1" [(ngModel)]="founderDurationMonths" placeholder="Usar valor del plan" />
        </div>
        <div class="founder-card__field">
          <label>Vigencia del código (meses)</label>
          <input type="number" min="1" [(ngModel)]="founderExpiryMonths" placeholder="6" />
        </div>
        <div class="founder-card__field">
          <label>Notas internas (opcional)</label>
          <textarea rows="3" [(ngModel)]="founderNotes" placeholder="Contexto de la invitación, campaña, cupo, etc."></textarea>
        </div>
        <div class="founder-card__actions">
          <button type="button" class="btn-primary" (click)="generateFounderCode()" [disabled]="founderGenerating">
            {{ founderGenerating ? 'Generando…' : 'Generar código' }}
          </button>
        </div>
      </div>

      <div class="founder-card__column" [class.founder-card__column--disabled]="!founderCode">
        <h4>2. Comparte el código</h4>

        <div class="founder-card__code" *ngIf="founderCode; else codePlaceholder">
          <span>{{ founderCode }}</span>
          <button type="button" (click)="copyFounderCode()">Copiar</button>
        </div>
        <ng-template #codePlaceholder>
          <div class="founder-card__code founder-card__code--empty">Genera un código para continuar.</div>
        </ng-template>

        <div class="founder-card__field">
          <label>Nombre de la persona</label>
          <input type="text" [(ngModel)]="founderRecipientName" [disabled]="!founderCode" placeholder="Ej: Carla Pérez" />
        </div>
        <div class="founder-card__field">
          <label>Correo electrónico</label>
          <input type="email" [(ngModel)]="founderRecipientEmail" [disabled]="!founderCode" placeholder="fundador@correo.com" />
        </div>
        <div class="founder-card__field">
          <label>Mensaje personal (opcional)</label>
          <textarea rows="3" [(ngModel)]="founderCustomMessage" [disabled]="!founderCode" placeholder="Mensaje breve para acompañar la invitación."></textarea>
        </div>
        <div class="founder-card__actions">
          <button type="button" class="btn-primary" (click)="sendFounderCode()" [disabled]="!founderCode || founderSending">
            {{ founderSending ? 'Enviando…' : 'Enviar correo' }}
          </button>
        </div>

        <div class="founder-card__meta" *ngIf="founderPromoInfo">
          <p><strong>Duración:</strong> {{ founderPromoInfo?.duration_months || '—' }} meses · <strong>Cupos:</strong> {{ founderPromoInfo?.max_redemptions || 1 }}</p>
          <p *ngIf="founderPromoInfo?.expires_at">
            <strong>Vence el:</strong> {{ founderPromoInfo?.expires_at | date:'dd/MM/yyyy' }}
          </p>
          <p *ngIf="founderEmailStatus === 'sent'" class="founder-card__status founder-card__status--success">
            Correo enviado a {{ founderRecipientEmail }}.
          </p>
          <p *ngIf="founderEmailStatus === 'error'" class="founder-card__status founder-card__status--error">
            {{ founderEmailErrorDetail }}
          </p>
        </div>
      </div>
    </div>

    <div *ngIf="founderSuccess" class="founder-card__message founder-card__message--success">{{ founderSuccess }}</div>
    <div *ngIf="founderErrorMsg" class="founder-card__message founder-card__message--error">{{ founderErrorMsg }}</div>
  </section>

  <div *ngIf="error" class="error-message">{{ error }}</div>
  <div *ngIf="loading">Cargando...</div>

  <app-admin-payments-table [rows]="rows" (action)="onTableAction($event)"></app-admin-payments-table>

  <!-- Tabla de Devoluciones -->
  <div style="margin-top:16px;">
    <h3>Devoluciones</h3>
    <table class="table" *ngIf="refunds?.length; else noRefunds">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Servicio</th>
          <th>Cliente</th>
          <th>Teléfono</th>
          <th>Proveedor</th>
          <th>Método</th>
          <th>Monto pagado</th>
          <th>Monto a devolver (65%)</th>
          <th>Estado</th>
          <th>Motivo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of refunds">
          <td>{{ r.id }}</td>
          <td>{{ r.requested_at | date:'short' }}</td>
          <td>{{ r.service_name || '-' }}</td>
          <td>{{ r.client_email }}</td>
          <td>{{ r.client_phone || '-' }}</td>
          <td>{{ r.provider_email }}</td>
          <td>{{ r.payment_method || '-' }}</td>
          <td>{{ (r.original_amount || r.amount || 0) | number:'1.0-0' }} {{ r.currency || 'CLP' }}</td>
          <td><strong>{{ (r.refund_proposed_amount || 0) | number:'1.0-0' }} {{ r.currency || 'CLP' }}</strong></td>
          <td>{{ r.status }}</td>
          <td>{{ r.reason }}</td>
          <td>
            <ng-container *ngIf="refundPayRow?.id !== r.id; else refundPayForm">
              <button (click)="decideRefund(r, 'approved')" [disabled]="r.status!=='requested' && r.status!=='in_review'">Aprobar</button>
              <button (click)="decideRefund(r, 'denied')" [disabled]="r.status!=='requested' && r.status!=='in_review'">Denegar</button>
              <button *ngIf="r.status==='approved'" (click)="openRefundPay(r)">Pagar</button>
            </ng-container>
            <ng-template #refundPayForm>
              <div class="pay-drawer">
                <h4>Pagar devolución a {{ r.client_email }}</h4>
                <div class="grid">
                  <div><strong>Método:</strong> {{ r.payment_method || '-' }}</div>
                  <div><strong>Monto a devolver:</strong> {{ (r.refund_proposed_amount || 0) | number:'1.0-0' }} {{ r.currency || 'CLP' }}</div>
                </div>
                <div class="row">
                  <label>Referencia</label>
                  <input type="text" [(ngModel)]="refundPayRef" placeholder="Número/Texto de referencia" />
                </div>
                <div class="row">
                  <label>Voucher</label>
                  <input type="file" (change)="onRefundVoucherSelected($event)" accept="image/*,application/pdf" />
                </div>
                <div class="actions">
                  <button class="btn-primary" (click)="confirmRefundPay(r)">Confirmar pago</button>
                  <button (click)="refundPayRow=null">Cancelar</button>
                </div>
              </div>
            </ng-template>
          </td>
        </tr>
      </tbody>
    </table>
    <ng-template #noRefunds>
      <p style="color:#64748b;margin:8px 0 0 4px;">No hay solicitudes de devolución.</p>
    </ng-template>
  </div>
  <!-- Drawer simple de pago -->
  <div *ngIf="payRow" class="pay-drawer">
    <h3>Pagar a {{ payRow.provider_name || payRow.provider_email }}</h3>
    <div class="grid">
      <div><strong>Banco:</strong> {{ payRow.bank_name || '-' }}</div>
      <div><strong>Cuenta:</strong> {{ payRow.bank_account || (payRow.bank_last4 ? ('•••• ' + payRow.bank_last4) : '-') }} ({{ payRow.account_type || '—' }})</div>
      <div><strong>Titular:</strong> {{ payRow.account_holder || '-' }}</div>
      <div><strong>Monto a transferir:</strong> {{ payRow.provider_amount | number:'1.0-0' }} {{ payRow.currency }}</div>
    </div>
    <div class="row">
      <label>Referencia</label>
      <input type="text" [(ngModel)]="payRef" placeholder="Número/Texto de referencia" />
    </div>
    <div class="row">
      <label>Voucher</label>
      <input type="file" (change)="onVoucherSelected($event)" accept="image/*,application/pdf" />
    </div>
    <div class="actions">
      <button class="btn-primary" (click)="confirmPay()">Confirmar pago</button>
      <button (click)="payRow=null">Cancelar</button>
    </div>
  </div>
</div>


