<div class="admin-pagos">
  <h2>Administración de Pagos</h2>

  <div class="filters">
    <label>Rango:</label>
    <select #rangeSel (change)="applyRange(rangeSel.value)">
      <option value="day">Hoy</option>
      <option value="week">Esta semana</option>
      <option value="month">Este mes</option>
      <option value="all">Todo</option>
    </select>
    <button (click)="applyRange(rangeSel.value)">Aplicar</button>
    <label style="margin-left:12px;">Gateway:</label>
    <select #gwSel (change)="setGateway(gwSel.value)">
      <option value="">Todos</option>
      <option value="tbk">TBK</option>
      <option value="stripe">Stripe</option>
      <option value="cash">Efectivo</option>
    </select>
    <button (click)="exportCsv()">Export CSV</button>
  </div>

  <app-admin-summary-cards [summary]="summary"></app-admin-summary-cards>

  <section *ngIf="adminSecret" class="analytics-panel">
    <div class="analytics-panel__header">
      <h3>Métricas de búsqueda y perfiles</h3>
      <button type="button" class="btn-secondary" (click)="loadAnalytics()" [disabled]="analyticsLoading">Refrescar métricas</button>
    </div>
    <p class="analytics-panel__subtitle">Fuente oficial: backend analytics events.</p>
    <div *ngIf="analyticsError" class="error-message">{{ analyticsError }}</div>
    <div *ngIf="analyticsLoading" class="analytics-panel__loading">Cargando métricas...</div>

    <div class="analytics-panel__kpis" *ngIf="!analyticsLoading">
      <div class="analytics-panel__kpi">
        <span>Top términos</span>
        <strong>{{ analyticsTopTerms.length }}</strong>
      </div>
      <div class="analytics-panel__kpi">
        <span>Top términos externos</span>
        <strong>{{ analyticsExternalTopTerms.length }}</strong>
      </div>
      <div class="analytics-panel__kpi">
        <span>Perfiles incompletos</span>
        <strong>{{ analyticsIncompleteProfiles.length }}</strong>
      </div>
      <div class="analytics-panel__kpi">
        <span>Perfiles visitados</span>
        <strong>{{ analyticsMostVisited.length }}</strong>
      </div>
      <div class="analytics-panel__kpi">
        <span>Puntos de tendencia</span>
        <strong>{{ analyticsTrends.length }}</strong>
      </div>
      <div class="analytics-panel__kpi">
        <span>Relaciones cliente->proveedor</span>
        <strong>{{ analyticsWhoSearchesWhom.length }}</strong>
      </div>
      <div class="analytics-panel__kpi">
        <span>Bookings (funnel)</span>
        <strong>{{ analyticsConversionTotals?.bookings || 0 }}</strong>
      </div>
      <div class="analytics-panel__kpi">
        <span>Tasa búsqueda->cita</span>
        <strong>{{ ((analyticsConversionTotals?.search_to_booking_rate || 0) * 100).toFixed(1) }}%</strong>
      </div>
      <div class="analytics-panel__kpi">
        <span>Calidad de atribución</span>
        <strong>{{ ((analyticsAttributionQuality?.attributed_rate || 0) * 100).toFixed(1) }}%</strong>
      </div>
    </div>

    <div class="analytics-panel__grid" *ngIf="!analyticsLoading">
      <div class="analytics-panel__card">
        <h4>Top palabras buscadas</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Término</th>
              <th>Búsquedas</th>
              <th>Clientes únicos</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of analyticsTopTerms">
              <td>{{ row.term }}</td>
              <td>{{ row.total }}</td>
              <td>{{ row.unique_clients || 0 }}</td>
            </tr>
            <tr *ngIf="analyticsTopTerms.length === 0">
              <td colspan="3">Sin datos para el rango seleccionado.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="analytics-panel__card">
        <h4>Top palabras externas (Landing)</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Término</th>
              <th>Búsquedas</th>
              <th>Sesiones únicas</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of analyticsExternalTopTerms">
              <td>{{ row.term }}</td>
              <td>{{ row.total }}</td>
              <td>{{ row.unique_sessions || 0 }}</td>
            </tr>
            <tr *ngIf="analyticsExternalTopTerms.length === 0">
              <td colspan="3">Sin datos para el rango seleccionado.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="analytics-panel__card">
        <h4>Perfiles más visitados</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Proveedor</th>
              <th>Visitas</th>
              <th>Clientes únicos</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of analyticsMostVisited">
              <td>{{ row.provider_name }} <span class="muted">#{{ row.provider_id }}</span></td>
              <td>{{ row.visits }}</td>
              <td>{{ row.unique_clients || 0 }}</td>
            </tr>
            <tr *ngIf="analyticsMostVisited.length === 0">
              <td colspan="3">Sin datos para el rango seleccionado.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="analytics-panel__card">
        <h4>Tendencia de búsquedas</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Periodo</th>
              <th>Búsquedas</th>
              <th>Clientes únicos</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of analyticsTrends">
              <td>{{ row.period }}</td>
              <td>{{ row.total_searches }}</td>
              <td>{{ row.unique_clients || 0 }}</td>
            </tr>
            <tr *ngIf="analyticsTrends.length === 0">
              <td colspan="3">Sin datos para el rango seleccionado.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="analytics-panel__card">
        <h4>Quién busca a quién</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Término</th>
              <th>Proveedor</th>
              <th>Visitas</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of analyticsWhoSearchesWhom">
              <td>{{ row.client_name || 'Cliente anónimo' }}</td>
              <td>{{ row.search_term || 'Sin término enlazado' }}</td>
              <td>{{ row.provider_name }}</td>
              <td>{{ row.visits }}</td>
            </tr>
            <tr *ngIf="analyticsWhoSearchesWhom.length === 0">
              <td colspan="4">Sin datos para el rango seleccionado.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="analytics-panel__card">
        <h4>Funnel búsqueda -> perfil -> booking</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Periodo</th>
              <th>Búsquedas</th>
              <th>Visitas perfil</th>
              <th>Bookings</th>
              <th>Conv. búsqueda->cita</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of analyticsConversionFunnel">
              <td>{{ row.period }}</td>
              <td>{{ row.searches }}</td>
              <td>{{ row.profile_views }}</td>
              <td>{{ row.bookings }}</td>
              <td>{{ (row.search_to_booking_rate * 100).toFixed(1) }}%</td>
            </tr>
            <tr *ngIf="analyticsConversionFunnel.length === 0">
              <td colspan="5">Sin datos para el rango seleccionado.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="analytics-panel__card">
        <h4>Top términos por conversión</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Término</th>
              <th>Búsquedas</th>
              <th>Bookings</th>
              <th>Conversion rate</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of analyticsConversionByTerm">
              <td>{{ row.term }}</td>
              <td>{{ row.searches }}</td>
              <td>{{ row.bookings }}</td>
              <td>{{ (row.conversion_rate * 100).toFixed(1) }}%</td>
            </tr>
            <tr *ngIf="analyticsConversionByTerm.length === 0">
              <td colspan="4">Sin datos para el rango seleccionado.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="analytics-panel__card">
        <h4>Top proveedores por booking atribuible</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Proveedor</th>
              <th>Visitas perfil</th>
              <th>Bookings</th>
              <th>Conv. perfil->cita</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of analyticsConversionByProvider">
              <td>{{ row.provider_name }} <span class="muted">#{{ row.provider_id }}</span></td>
              <td>{{ row.profile_views }}</td>
              <td>{{ row.bookings }}</td>
              <td>{{ (row.profile_to_booking_rate * 100).toFixed(1) }}%</td>
            </tr>
            <tr *ngIf="analyticsConversionByProvider.length === 0">
              <td colspan="4">Sin datos para el rango seleccionado.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <div
    *ngIf="incompleteEmailDialogOpen && incompleteEmailTarget as target"
    class="incomplete-email-modal"
    (click)="onIncompleteEmailBackdropClick($event)"
  >
    <div class="incomplete-email-modal__card">
      <div class="incomplete-email-modal__header">
        <div>
          <h3>Correo manual · Perfil incompleto</h3>
          <p>{{ target.provider_name || 'Proveedor' }} (#{{ target.provider_id }}) · {{ target.provider_email || 'Sin correo' }}</p>
        </div>
        <button type="button" class="btn-secondary" (click)="closeIncompleteEmailDialog()" [disabled]="incompleteEmailSending">
          Cerrar
        </button>
      </div>

      <div class="incomplete-email-modal__grid">
        <div class="incomplete-email-modal__form">
          <label>Asunto</label>
          <input type="text" [(ngModel)]="incompleteEmailSubject" placeholder="Asunto del correo" />

          <label>Motivos que incluirá el correo</label>
          <label *ngFor="let reason of incompleteEmailReasons" class="incomplete-email-modal__reason">
            <input type="checkbox" [(ngModel)]="reason.selected" />
            <span>{{ reason.label }}</span>
          </label>

          <label>Mensaje adicional (opcional)</label>
          <textarea
            rows="4"
            [(ngModel)]="incompleteEmailMessage"
            placeholder="Ej: Completa estos datos hoy para aparecer nuevamente en las búsquedas."
          ></textarea>
        </div>

        <div class="incomplete-email-modal__preview">
          <h4>Vista previa del correo</h4>
          <p><strong>Asunto:</strong> {{ incompleteEmailSubject || 'Sin asunto' }}</p>
          <p>Hola {{ target.provider_name || 'Proveedor' }},</p>
          <p>Detectamos que tu perfil tiene campos pendientes para aparecer en búsquedas:</p>
          <ul>
            <li *ngFor="let label of getSelectedIncompleteEmailReasons()">{{ label }}</li>
          </ul>
          <p *ngIf="!getSelectedIncompleteEmailReasons().length" class="muted">Selecciona al menos un motivo para armar el correo.</p>
          <p *ngIf="incompleteEmailMessage">{{ incompleteEmailMessage }}</p>
        </div>
      </div>

      <div class="incomplete-email-modal__actions">
        <p *ngIf="incompleteEmailSuccess" class="founder-card__status founder-card__status--success">{{ incompleteEmailSuccess }}</p>
        <p *ngIf="incompleteEmailError" class="founder-card__status founder-card__status--error">{{ incompleteEmailError }}</p>
        <button type="button" class="btn-secondary" (click)="closeIncompleteEmailDialog()" [disabled]="incompleteEmailSending">
          Cancelar
        </button>
        <button type="button" class="btn-primary" (click)="sendIncompleteProfileEmail()" [disabled]="incompleteEmailSending">
          {{ incompleteEmailSending ? 'Enviando…' : 'Enviar correo' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Monitor de transacciones (vista unificada tipo captured_hold/released/disputed/refunded) -->
  <app-admin-transactions-monitor *ngIf="adminSecret" [rows]="rows"></app-admin-transactions-monitor>

  <!-- Disputas/Contracargos (TBK Oneclick) -->
  <app-admin-payment-disputes *ngIf="adminSecret" [adminSecret]="adminSecret"></app-admin-payment-disputes>

  <section *ngIf="gateway === 'cash' && adminSecret" class="admin-cash">
    <div class="admin-cash__header">
      <div>
        <h3>Comisiones de Pagos en Efectivo</h3>
        <p>Monitorea el total adeudado por los proveedores y filtra por estado.</p>
      </div>
      <button type="button" class="admin-cash__refresh" (click)="refreshAdminCash()" [disabled]="cashSummaryLoading || cashLoading">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 19a9 9 0 0014.1-2.1M19 5a9 9 0 00-14.1 2.1" />
        </svg>
        Actualizar
      </button>
    </div>

    <div class="admin-cash__summary">
      <div class="admin-cash__metric">
        <span>Total adeudado</span>
        <strong>
          <ng-container *ngIf="!cashSummaryLoading; else cashSummarySkeleton">
            {{ cashSummary?.total_due | currency:'CLP':'symbol':'1.0-0':'es-CL' }}
          </ng-container>
        </strong>
      </div>
      <div class="admin-cash__metric">
        <span>Vencido</span>
        <strong>
          <ng-container *ngIf="!cashSummaryLoading; else cashSummarySkeleton">
            {{ cashSummary?.overdue_due | currency:'CLP':'symbol':'1.0-0':'es-CL' }}
          </ng-container>
        </strong>
      </div>
      <div class="admin-cash__metric">
        <span>Pendientes</span>
        <strong>{{ cashSummary?.pending_count || 0 }}</strong>
      </div>
      <div class="admin-cash__metric">
        <span>Vencidas</span>
        <strong>{{ cashSummary?.overdue_count || 0 }}</strong>
      </div>
      <div class="admin-cash__metric">
        <span>En revisión</span>
        <strong>{{ cashSummary?.under_review_count || 0 }}</strong>
      </div>
      <div class="admin-cash__metric">
        <span>Rechazadas</span>
        <strong>{{ cashSummary?.rejected_count || 0 }}</strong>
      </div>
      <div class="admin-cash__metric">
        <span>Pagadas</span>
        <strong>{{ cashSummary?.paid_count || 0 }}</strong>
      </div>
    </div>

    <ng-template #cashSummarySkeleton>
      <span class="admin-cash__loading-bar"></span>
    </ng-template>

    <div class="admin-cash__filters">
      <button type="button" class="admin-cash__filter" [class.admin-cash__filter--active]="cashFilter==='pending'" (click)="setCashFilterAdmin('pending')">Pendientes</button>
      <button type="button" class="admin-cash__filter" [class.admin-cash__filter--active]="cashFilter==='overdue'" (click)="setCashFilterAdmin('overdue')">Vencidas</button>
      <button type="button" class="admin-cash__filter" [class.admin-cash__filter--active]="cashFilter==='under_review'" (click)="setCashFilterAdmin('under_review')">En revisión</button>
      <button type="button" class="admin-cash__filter" [class.admin-cash__filter--active]="cashFilter==='rejected'" (click)="setCashFilterAdmin('rejected')">Rechazadas</button>
      <button type="button" class="admin-cash__filter" [class.admin-cash__filter--active]="cashFilter==='paid'" (click)="setCashFilterAdmin('paid')">Pagadas</button>
      <button type="button" class="admin-cash__filter" [class.admin-cash__filter--active]="cashFilter==='all'" (click)="setCashFilterAdmin('all')">Todas</button>
    </div>

    <table class="admin-cash__table">
      <thead>
        <tr>
          <th>Proveedor</th>
          <th>Cliente</th>
          <th>Servicio / Cita</th>
          <th>Monto Comisión</th>
          <th>Vencimiento</th>
          <th>Estado</th>
          <th>Referencia</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="cashLoading">
          <td colspan="7" class="admin-cash__table-loading"><span class="cash-spinner"></span> Cargando deudas...</td>
        </tr>
        <tr *ngIf="!cashLoading && cashDebts.length === 0">
          <td colspan="7" class="admin-cash__table-empty">No hay comisiones para este estado.</td>
        </tr>
        <tr
          *ngFor="let c of cashDebts"
          class="admin-cash__row"
          [class.admin-cash__row--selected]="selectedCashDebtId === c.id"
          (click)="onSelectCashDebt(c)"
        >
          <td>
            <div class="admin-cash__provider">{{ c.provider_name || c.provider_email }}</div>
            <div class="admin-cash__muted">ID #{{ c.provider_id }}</div>
          </td>
          <td>{{ c.client_name || c.client_email || '—' }}</td>
          <td>
            <div class="admin-cash__muted">Cita #{{ c.appointment_id || '—' }}</div>
            <div class="admin-cash__muted">{{ c.date ? (c.date | date:'dd/MM/yyyy') : '—' }} · {{ c.start_time ? (c.start_time | date:'HH:mm') : '' }}</div>
          </td>
          <td>{{ c.commission_amount | currency:'CLP':'symbol':'1.0-0':'es-CL' }}</td>
          <td>{{ c.due_date ? (c.due_date | date:'dd/MM/yyyy') : '—' }}</td>
          <td>
            <span class="badge" [ngClass]="{
              'badge--pending': c.status==='pending',
              'badge--overdue': c.status==='overdue',
              'badge--review': c.status==='under_review',
              'badge--rejected': c.status==='rejected',
              'badge--paid': c.status==='paid'
            }">
              {{
                c.status==='pending' ? 'Pendiente' :
                c.status==='overdue' ? 'Vencida' :
                c.status==='under_review' ? 'En revisión' :
                c.status==='rejected' ? 'Rechazada' : 'Pagada'
              }}
            </span>
          </td>
          <td>
            <div *ngIf="c.settlement_reference; else noRef">{{ c.settlement_reference }}</div>
            <ng-template #noRef>—</ng-template>
          </td>
        </tr>
      </tbody>
    </table>

    <app-admin-cash-review-panel
      [adminSecret]="adminSecret"
      (refreshRequested)="refreshAdminCash()"
    ></app-admin-cash-review-panel>
  </section>

  <form *ngIf="!adminSecret" style="margin:12px 0;" (ngSubmit)="setSecretAndLoad()">
    <input type="text" name="adminUsername" autocomplete="username" tabindex="-1" aria-hidden="true" style="position:absolute;left:-10000px;opacity:0;width:1px;height:1px;pointer-events:none;" />
    <label for="admin-secret-input">Admin Secret</label>
    <input id="admin-secret-input" type="password" [(ngModel)]="adminSecret" name="adminSecret" autocomplete="new-password" placeholder="Pega el ADMIN_PANEL_SECRET" />
    <button class="btn-primary" type="submit">Acceder</button>
  </form>

  <section *ngIf="adminSecret" class="support-admin">
    <div class="support-admin__header">
      <div>
        <h3>Tickets de soporte (Clientes)</h3>
        <p class="support-admin__subtitle">Todo lo que llega por soporte debe revisarse aquí.</p>
      </div>
      <div class="support-admin__stats">
        <div class="support-admin__stat">
          <span>Abiertos</span>
          <strong>{{ supportStats.open }}</strong>
        </div>
        <div class="support-admin__stat">
          <span>Cerrados</span>
          <strong>{{ supportStats.closed }}</strong>
        </div>
      </div>
    </div>

    <div class="support-admin__filters">
      <label>
        Estado:
        <select [(ngModel)]="supportStatusFilter" (change)="loadSupportTickets()">
          <option value="all">Todos</option>
          <option value="abierto">Abierto</option>
          <option value="en_proceso">En proceso</option>
          <option value="cerrado">Cerrado</option>
        </select>
      </label>
      <label>
        Categoría:
        <input type="text" [(ngModel)]="supportCategoryFilter" placeholder="Ej: Pagos" (keyup.enter)="loadSupportTickets()" />
      </label>
      <label class="support-admin__search">
        Buscar:
        <input type="text" [(ngModel)]="supportSearch" placeholder="Asunto, email..." (keyup.enter)="loadSupportTickets()" />
      </label>
      <button type="button" (click)="loadSupportTickets()" [disabled]="supportLoading">Refrescar</button>
    </div>

    <div *ngIf="supportLoading" class="support-admin__loading">Cargando tickets...</div>
    <div *ngIf="supportError" class="support-admin__error">{{ supportError }}</div>

    <div *ngIf="!supportLoading && !supportError" class="support-admin__grid">
      <div class="support-admin__list">
        <div *ngIf="supportTickets.length === 0" class="support-admin__empty">
          No hay tickets de clientes.
        </div>
        <div *ngFor="let t of supportTickets" class="support-admin__item" [class.support-admin__item--selected]="supportSelectedId === t.id" (click)="onSelectSupport(t)">
          <div class="support-admin__item-main">
            <div class="support-admin__item-title">{{ t.subject }}</div>
            <div class="support-admin__item-meta">
              <span class="support-admin__badge" [ngClass]="{
                'support-admin__badge--open': t.status === 'abierto',
                'support-admin__badge--progress': t.status === 'en_proceso',
                'support-admin__badge--closed': t.status === 'cerrado'
              }">
                {{ t.status === 'cerrado' ? 'Cerrado' : (t.status === 'en_proceso' ? 'En proceso' : 'Abierto') }}
              </span>
              <span class="support-admin__chip">{{ t.category }}</span>
              <span class="support-admin__date">{{ t.created_at | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>
          <div class="support-admin__desc">
            {{ t.description || 'Sin descripción' }}
          </div>
          <div class="support-admin__meta-line">
            <span>{{ t.user_email || '—' }}</span>
            <span class="muted">#{{ t.id }}</span>
          </div>
        </div>
      </div>

      <div class="support-admin__detail" *ngIf="supportSelected">
        <div class="support-admin__detail-header">
          <div>
            <p class="support-admin__detail-id">Ticket #{{ supportSelected.id }}</p>
            <h4>{{ supportSelected.subject }}</h4>
            <p class="muted">{{ supportSelected.user_name || supportSelected.user_email || 'Usuario' }} · {{ supportSelected.user_email }}</p>
            <p class="muted">Creado: {{ supportSelected.created_at | date:'dd/MM/yyyy HH:mm' }}</p>
          </div>
          <div class="support-admin__detail-actions">
            <button type="button" (click)="updateSupportStatus('abierto')" [disabled]="supportUpdatingStatus">Marcar abierto</button>
            <button type="button" (click)="updateSupportStatus('en_proceso')" [disabled]="supportUpdatingStatus">En proceso</button>
            <button type="button" (click)="updateSupportStatus('cerrado')" [disabled]="supportUpdatingStatus">Cerrar</button>
          </div>
        </div>

        <div class="support-admin__detail-body">
          <p class="support-admin__detail-desc">{{ supportSelected.description || 'Sin descripción' }}</p>

          <div class="support-admin__messages">
            <h5>Mensajes</h5>
            <div *ngIf="supportMessages.length === 0" class="support-admin__empty">Sin mensajes</div>
            <div *ngFor="let m of supportMessages" class="support-admin__message">
              <div class="support-admin__message-meta">
                <span class="support-admin__chip">{{ m.author_type }}</span>
                <span class="muted">{{ m.created_at | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <p>{{ m.message }}</p>
            </div>
          </div>

          <div class="support-admin__reply">
            <textarea [(ngModel)]="supportReply" rows="3" placeholder="Escribe una respuesta al cliente..."></textarea>
            <div class="support-admin__reply-actions">
              <button type="button" class="btn-primary" (click)="sendSupportReply()" [disabled]="supportReplying || !supportReply.trim()">Enviar respuesta</button>
              <button type="button" (click)="supportReply=''" [disabled]="supportReplying">Limpiar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section *ngIf="adminSecret" class="founder-card">
    <div class="founder-card__header">
      <div>
        <h3>Plan Fundador · Generador de códigos</h3>
        <p>Emite un código exclusivo y envíalo por correo al profesional invitado.</p>
      </div>
      <button type="button" class="founder-card__reset" (click)="resetFounderForm()" *ngIf="founderCode">Limpiar</button>
    </div>

    <div class="founder-card__content">
      <div class="founder-card__column">
        <h4>1. Configura la promoción</h4>
        <div class="founder-card__field">
          <label>Duración promocional (meses)</label>
          <input type="number" min="1" [(ngModel)]="founderDurationMonths" placeholder="Usar valor del plan" />
        </div>
        <div class="founder-card__field">
          <label>Vigencia del código (meses)</label>
          <input type="number" min="1" [(ngModel)]="founderExpiryMonths" placeholder="6" />
        </div>
        <div class="founder-card__field">
          <label>Notas internas (opcional)</label>
          <textarea rows="3" [(ngModel)]="founderNotes" placeholder="Contexto de la invitación, campaña, cupo, etc."></textarea>
        </div>
        <div class="founder-card__actions">
          <button type="button" class="btn-primary" (click)="generateFounderCode()" [disabled]="founderGenerating">
            {{ founderGenerating ? 'Generando…' : 'Generar código' }}
          </button>
        </div>
      </div>

      <div class="founder-card__column" [class.founder-card__column--disabled]="!founderCode">
        <h4>2. Comparte el código</h4>

        <div class="founder-card__code" *ngIf="founderCode; else codePlaceholder">
          <span>{{ founderCode }}</span>
          <button type="button" (click)="copyFounderCode()">Copiar</button>
        </div>
        <ng-template #codePlaceholder>
          <div class="founder-card__code founder-card__code--empty">Genera un código para continuar.</div>
        </ng-template>

        <div class="founder-card__field">
          <label>Nombre de la persona</label>
          <input type="text" [(ngModel)]="founderRecipientName" [disabled]="!founderCode" placeholder="Ej: Carla Pérez" />
        </div>
        <div class="founder-card__field">
          <label>Correo electrónico</label>
          <input type="email" [(ngModel)]="founderRecipientEmail" [disabled]="!founderCode" placeholder="fundador@correo.com" />
        </div>
        <div class="founder-card__field">
          <label>Mensaje personal (opcional)</label>
          <textarea rows="3" [(ngModel)]="founderCustomMessage" [disabled]="!founderCode" placeholder="Mensaje breve para acompañar la invitación."></textarea>
        </div>
        <div class="founder-card__actions">
          <button type="button" class="btn-primary" (click)="sendFounderCode()" [disabled]="!founderCode || founderSending">
            {{ founderSending ? 'Enviando…' : 'Enviar correo' }}
          </button>
        </div>

        <div class="founder-card__meta" *ngIf="founderPromoInfo as promo">
          <p><strong>Duración:</strong> {{ promo.duration_months || '—' }} meses · <strong>Cupos:</strong> {{ promo.max_redemptions || 1 }}</p>
          <p *ngIf="promo.expires_at">
            <strong>Vence el:</strong> {{ promo.expires_at | date:'dd/MM/yyyy' }}
          </p>
          <p *ngIf="founderEmailStatus === 'sent'" class="founder-card__status founder-card__status--success">
            Correo enviado a {{ founderRecipientEmail }}.
          </p>
          <p *ngIf="founderEmailStatus === 'error'" class="founder-card__status founder-card__status--error">
            {{ founderEmailErrorDetail }}
          </p>
        </div>
      </div>
    </div>

    <div *ngIf="founderSuccess" class="founder-card__message founder-card__message--success">{{ founderSuccess }}</div>
    <div *ngIf="founderErrorMsg" class="founder-card__message founder-card__message--error">{{ founderErrorMsg }}</div>
  </section>

  <section *ngIf="adminSecret" class="qr-panel">
    <app-qr-display></app-qr-display>
  </section>

  <section *ngIf="adminSecret" class="founder-codes-panel">
    <div class="founder-codes-panel__header">
      <div>
        <h3>Códigos Fundador por comuna</h3>
        <p>Lista oficial para campañas impresas. Cada código expira a los 90 días o cuando se ocupan los cupos.</p>
      </div>
      <div class="founder-codes-panel__actions">
        <button type="button" class="btn-secondary" (click)="loadFounderCodes()" [disabled]="founderCodesLoading">
          {{ founderCodesLoading ? 'Actualizando…' : 'Refrescar' }}
        </button>
        <button type="button" class="btn-primary" (click)="exportFounderCodesCsv()" [disabled]="founderExporting || !founderCodes.length">
          {{ founderExporting ? 'Generando CSV…' : 'Exportar CSV' }}
        </button>
      </div>
    </div>

    <div *ngIf="founderCodesLoading" class="founder-codes-panel__loading">
      <span class="spinner"></span>
      Cargando comunas…
    </div>

    <div *ngIf="founderCodesError" class="founder-card__message founder-card__message--error">
      {{ founderCodesError }}
    </div>

    <table *ngIf="!founderCodesLoading && founderCodes.length" class="table founder-codes-table">
      <thead>
        <tr>
          <th>Comuna / Región</th>
          <th>Código</th>
          <th>Cupos</th>
          <th>Usos</th>
          <th>Restantes</th>
          <th>Beneficio</th>
          <th>Vigencia</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of founderCodes" [class.founder-codes-table__row--region]="item.category === 'region'">
          <td>
            <strong>{{ item.commune }}</strong>
            <div class="founder-codes-table__muted">{{ item.region }}</div>
          </td>
          <td>{{ item.code }}</td>
          <td>{{ item.max_uses === null ? '∞' : item.max_uses }}</td>
          <td>{{ item.current_uses }}</td>
          <td>
            <span [ngClass]="{
              'founder-codes-table__chip': true,
              'founder-codes-table__chip--low': item.max_uses !== null && (item.max_uses - item.current_uses) <= 5
            }">
              {{ item.max_uses === null ? '∞' : (item.max_uses - item.current_uses) }}
            </span>
          </td>
          <td>{{ item.benefit_months || 3 }} meses</td>
          <td>
            <div class="founder-codes-table__muted">Desde {{ item.valid_from | date:'dd/MM/yyyy' }}</div>
            <div class="founder-codes-table__muted">Hasta {{ item.valid_until | date:'dd/MM/yyyy' }}</div>
          </td>
          <td>
            <span class="founder-codes-table__status" [ngClass]="{
              'founder-codes-table__status--active': item.status === 'active',
              'founder-codes-table__status--expired': item.status === 'expired',
              'founder-codes-table__status--disabled': item.status === 'disabled'
            }">{{ item.status }}</span>
          </td>
        </tr>
      </tbody>
    </table>

    <p *ngIf="!founderCodesLoading && !founderCodes.length" class="founder-codes-panel__empty">
      No hay códigos registrados.
    </p>
  </section>

  <section *ngIf="adminSecret" class="verification-card">
    <div class="verification-card__header">
      <div class="verification-card__header-info">
        <h3>Verificación de identidad</h3>
        <p>{{ verificationType === 'client' ? 'Revisa los documentos de los clientes y garantiza que la comunidad sea segura.' : 'Revisa los documentos de los proveedores y aprueba o rechaza según corresponda.' }}</p>
        <div class="verification-card__type-toggle">
          <button type="button" class="verification-card__type-btn" [class.verification-card__type-btn--active]="verificationType === 'provider'" (click)="setVerificationType('provider')">
            Proveedores
          </button>
          <button type="button" class="verification-card__type-btn" [class.verification-card__type-btn--active]="verificationType === 'client'" (click)="setVerificationType('client')">
            Clientes
          </button>
        </div>
      </div>
      <div class="verification-card__filters">
        <button type="button" class="verification-card__filter" [class.verification-card__filter--active]="verificationFilter==='pending'" (click)="setVerificationFilter('pending')">Pendientes</button>
        <button type="button" class="verification-card__filter" [class.verification-card__filter--active]="verificationFilter==='approved'" (click)="setVerificationFilter('approved')">Aprobadas</button>
        <button type="button" class="verification-card__filter" [class.verification-card__filter--active]="verificationFilter==='rejected'" (click)="setVerificationFilter('rejected')">Rechazadas</button>
        <button type="button" class="verification-card__filter" [class.verification-card__filter--active]="verificationFilter==='all'" (click)="setVerificationFilter('all')">Todas</button>
      </div>
    </div>

    <div class="verification-card__controls">
      <input type="text" class="verification-card__search-input" placeholder="Buscar por nombre, correo o documento" [(ngModel)]="verificationSearch" (keyup.enter)="applyVerificationSearch()">
      <button type="button" class="verification-card__btn" (click)="applyVerificationSearch()">Buscar</button>
      <button type="button" class="verification-card__link" *ngIf="verificationSearch" (click)="clearVerificationSearch()">Limpiar</button>
    </div>

    <div *ngIf="verificationError" class="error-message">{{ verificationError }}</div>
    <div *ngIf="verificationLoading" class="verification-card__loading">
      <span class="spinner"></span>
      Cargando solicitudes...
    </div>

    <table *ngIf="!verificationLoading && verificationRequests.length" class="table verification-table">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Documento</th>
          <th>Archivos</th>
          <th>Estado</th>
          <th>Notas internas</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let req of verificationRequests">
          <td>
            <div class="verification-table__provider">
              <span class="verification-table__chip">{{ getVerificationDisplayType(req) }}</span>
              {{ getVerificationDisplayName(req) }}
            </div>
            <div class="verification-table__muted">ID #{{ getVerificationDisplayId(req) }}</div>
            <div class="verification-table__muted">{{ getVerificationDisplayEmail(req) || '—' }}</div>
          </td>
          <td>
            <div><strong>{{ req.document_type | uppercase }}</strong> · Nº {{ req.document_number || '—' }}</div>
            <div class="verification-table__muted">Enviado: {{ req.submitted_at ? (req.submitted_at | date:'short') : '—' }}</div>
            <div class="verification-table__muted">Actualizado: {{ req.updated_at | date:'short' }}</div>
            <div *ngIf="req.rejection_reason" class="verification-table__badge verification-table__badge--error">Último rechazo: {{ req.rejection_reason }}</div>
          </td>
          <td>
            <div class="verification-table__files">
              <span class="verification-table__badge verification-table__badge--file" *ngFor="let type of (req.file_types || [])">{{ type }}</span>
              <span *ngIf="!req.file_types?.length" class="verification-table__muted">Sin archivos</span>
            </div>
            <button type="button" class="verification-table__link" (click)="viewVerificationDetail(req)">Ver detalle</button>
          </td>
          <td>
            <span class="verification-table__status" [ngClass]="{
              'verification-table__status--pending': req.status==='pending',
              'verification-table__status--approved': req.status==='approved',
              'verification-table__status--rejected': req.status==='rejected'
            }">{{ req.status }}</span>
            <div *ngIf="req.is_verified" class="verification-table__badge verification-table__badge--success">Perfil verificado</div>
          </td>
          <td>
            <textarea rows="3" placeholder="Agregar nota interna" [(ngModel)]="verificationNotes[req.id]"></textarea>
          </td>
          <td>
            <div class="verification-table__actions" *ngIf="req.status === 'pending'; else verificationReadonly">
              <input type="text" class="verification-table__input" placeholder="Motivo de rechazo" [(ngModel)]="verificationRejectReasons[req.id]">
              <div class="verification-table__buttons">
                <button type="button" class="btn-primary" [disabled]="verificationProcessing[req.id]" (click)="approveVerification(req)">
                  {{ verificationProcessing[req.id] ? 'Aprobando…' : 'Aprobar' }}
                </button>
                <button type="button" class="btn-danger" [disabled]="verificationProcessing[req.id]" (click)="rejectVerification(req)">
                  {{ verificationProcessing[req.id] ? 'Rechazando…' : 'Rechazar' }}
                </button>
              </div>
            </div>
            <ng-template #verificationReadonly>
              <div class="verification-table__muted">Revisada</div>
            </ng-template>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="verification-card__pagination" *ngIf="!verificationLoading && verificationRequests.length">
      <button type="button" class="verification-card__btn" (click)="prevVerificationPage()" [disabled]="verificationLoading || verificationOffset === 0">Anterior</button>
      <span>
        Página {{ ((verificationOffset / verificationLimit) + 1) | number:'1.0-0' }} · Mostrando {{ verificationPagination?.returned || verificationRequests.length }} registros
      </span>
      <button type="button" class="verification-card__btn" (click)="nextVerificationPage()" [disabled]="verificationLoading || (verificationPagination?.returned || 0) < verificationLimit">Siguiente</button>
    </div>

    <div class="verification-detail" *ngIf="verificationDetail || verificationDetailLoading || verificationDetailError">
      <div class="verification-detail__header">
        <div>
          <h4>Detalle solicitud #{{ verificationDetail?.id || '...' }}</h4>
          <p *ngIf="verificationDetail" class="verification-table__muted">
            Estado: {{ verificationDetail.status }} · {{ getVerificationDisplayType(verificationDetail) }} #{{ getVerificationDisplayId(verificationDetail) }}
          </p>
        </div>
        <div class="verification-detail__actions">
          <button type="button" class="verification-card__link" (click)="refreshVerificationDetail()" [disabled]="verificationDetailLoading || !verificationDetail">Regenerar enlaces</button>
          <button type="button" class="verification-card__link" (click)="clearVerificationDetail()">Cerrar</button>
        </div>
      </div>
      <div *ngIf="verificationDetailLoading" class="verification-card__loading">
        <span class="spinner"></span>
        Generando enlaces...
      </div>
      <div *ngIf="verificationDetailError" class="error-message">{{ verificationDetailError }}</div>
      <div *ngIf="verificationDetail && !verificationDetailLoading" class="verification-detail__content">
        <div class="verification-detail__meta">
          <div><strong>{{ getVerificationDisplayType(verificationDetail) }}:</strong> {{ getVerificationDisplayName(verificationDetail) }}</div>
          <div class="verification-table__muted">{{ getVerificationDisplayEmail(verificationDetail) || '—' }}</div>
          <div><strong>Documento:</strong> {{ verificationDetail.document_type | uppercase }} · {{ verificationDetail.document_number || '—' }}</div>
          <div><strong>Enviado:</strong> {{ verificationDetail.submitted_at ? (verificationDetail.submitted_at | date:'short') : '—' }}</div>
          <div><strong>Actualizado:</strong> {{ verificationDetail.updated_at | date:'short' }}</div>
          <div *ngIf="verificationDetail.rejection_reason"><strong>Rechazo:</strong> {{ verificationDetail.rejection_reason }}</div>
        </div>
        <div class="verification-detail__files">
          <div class="verification-detail__file" *ngFor="let file of verificationDetail.files">
            <div class="verification-detail__file-header">
              <strong>{{ file.type | uppercase }}</strong>
              <span class="verification-table__muted">{{ file.mimeType || 'N/D' }} · {{ (file.sizeBytes || 0) / 1024 | number:'1.0-0' }} KB</span>
            </div>
            <div class="verification-detail__preview" *ngIf="file.url && file.mimeType?.startsWith('image/')">
              <img [src]="file.url" alt="Documento {{ file.type }}" />
            </div>
            <a *ngIf="file.url" class="verification-detail__link" [href]="file.url" target="_blank" rel="noopener">Abrir en nueva pestaña</a>
            <p *ngIf="!file.url" class="verification-table__muted">URL expirada. Regenera los enlaces.</p>
          </div>
        </div>
      </div>
    </div>

    <p *ngIf="!verificationLoading && verificationRequests.length === 0" class="verification-table__empty">No hay solicitudes en este estado.</p>
  </section>

  <div *ngIf="error" class="error-message">{{ error }}</div>
  <div *ngIf="loading">Cargando...</div>

  <app-admin-payments-table [rows]="rows" (action)="onTableAction($event)"></app-admin-payments-table>

  <!-- Tabla de Devoluciones -->
  <div style="margin-top:16px;">
    <h3>Devoluciones</h3>
    <table class="table" *ngIf="refunds?.length; else noRefunds">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Servicio</th>
          <th>Cliente</th>
          <th>Teléfono</th>
          <th>Proveedor</th>
          <th>Método</th>
          <th>Monto pagado</th>
          <th>Monto a devolver (65%)</th>
          <th>Estado</th>
          <th>Motivo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of refunds">
          <td>{{ r.id }}</td>
          <td>{{ r.requested_at | date:'short' }}</td>
          <td>{{ r.service_name || '-' }}</td>
          <td>{{ r.client_email }}</td>
          <td>{{ r.client_phone || '-' }}</td>
          <td>{{ r.provider_email }}</td>
          <td>{{ r.payment_method || '-' }}</td>
          <td>{{ (r.original_amount || r.amount || 0) | number:'1.0-0' }} {{ r.currency || 'CLP' }}</td>
          <td><strong>{{ (r.refund_proposed_amount || 0) | number:'1.0-0' }} {{ r.currency || 'CLP' }}</strong></td>
          <td>{{ r.status }}</td>
          <td>{{ r.reason }}</td>
          <td>
            <ng-container *ngIf="refundPayRow?.id !== r.id; else refundPayForm">
              <button (click)="decideRefund(r, 'approved')" [disabled]="r.status!=='requested' && r.status!=='in_review'">Aprobar</button>
              <button (click)="decideRefund(r, 'denied')" [disabled]="r.status!=='requested' && r.status!=='in_review'">Denegar</button>
              <button *ngIf="r.status==='approved'" (click)="openRefundPay(r)">Pagar</button>
            </ng-container>
            <ng-template #refundPayForm>
              <div class="pay-drawer">
                <h4>Pagar devolución a {{ r.client_email }}</h4>
                <div class="grid">
                  <div><strong>Método:</strong> {{ r.payment_method || '-' }}</div>
                  <div><strong>Monto a devolver:</strong> {{ (r.refund_proposed_amount || 0) | number:'1.0-0' }} {{ r.currency || 'CLP' }}</div>
                </div>
                <div class="row">
                  <label>Referencia</label>
                  <input type="text" [(ngModel)]="refundPayRef" placeholder="Número/Texto de referencia" />
                </div>
                <div class="row">
                  <label>Voucher</label>
                  <input type="file" (change)="onRefundVoucherSelected($event)" accept="image/*,application/pdf" />
                </div>
                <div class="actions">
                  <button class="btn-primary" (click)="confirmRefundPay(r)">Confirmar pago</button>
                  <button (click)="refundPayRow=null">Cancelar</button>
                </div>
              </div>
            </ng-template>
          </td>
        </tr>
      </tbody>
    </table>
    <ng-template #noRefunds>
      <p style="color:#64748b;margin:8px 0 0 4px;">No hay solicitudes de devolución.</p>
    </ng-template>
  </div>

  <div class="analytics-panel__card" style="margin-top:16px;">
    <h4>Perfiles incompletos (no visibles en búsqueda)</h4>
    <div style="margin: 10px 0 12px 0;">
      <input
        type="text"
        [(ngModel)]="incompleteProfilesSearch"
        placeholder="Buscar proveedor por nombre..."
        style="width: 100%; max-width: 360px;"
      />
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>
            <input
              type="checkbox"
              [checked]="incompleteBulkSelectAll"
              (change)="toggleAllIncompleteProviders($any($event.target).checked)"
              title="Seleccionar todos"
            />
          </th>
          <th>Proveedor</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th>Servicios activos</th>
          <th>Faltantes</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of filteredIncompleteProfiles">
          <td>
            <input
              type="checkbox"
              [checked]="isIncompleteProviderSelected(row.provider_id)"
              (change)="toggleIncompleteProviderSelection(row.provider_id, $any($event.target).checked)"
            />
          </td>
          <td>
            {{ row.provider_name || 'Sin nombre' }}
            <span class="muted">#{{ row.provider_id }}</span>
          </td>
          <td>{{ getRoleLabel(row.user_role) }}</td>
          <td>{{ row.verification_status || 'none' }}</td>
          <td>{{ row.active_services || 0 }}</td>
          <td>{{ getIncompleteReasonsText(row) }}</td>
          <td>
            <button
              type="button"
              class="btn-secondary"
              (click)="openIncompleteEmailDialog(row)"
              [disabled]="!row.provider_email || incompleteEmailStatusByProvider[row.provider_id]?.sending"
            >
              {{ incompleteEmailStatusByProvider[row.provider_id]?.sending ? 'Enviando…' : 'Enviar correo al usuario' }}
            </button>
            <div *ngIf="!row.provider_email" class="muted">Sin email registrado</div>
            <div *ngIf="incompleteEmailStatusByProvider[row.provider_id]?.sentAt" class="muted">
              Correo enviado
            </div>
            <div *ngIf="incompleteEmailStatusByProvider[row.provider_id]?.error" class="muted" style="color:#b91c1c;">
              {{ incompleteEmailStatusByProvider[row.provider_id]?.error }}
            </div>
          </td>
        </tr>
        <tr *ngIf="filteredIncompleteProfiles.length === 0">
          <td colspan="7">No hay perfiles incompletos para mostrar.</td>
        </tr>
      </tbody>
    </table>

    <div class="incomplete-notify" style="margin-top:16px;">
      <h5>Centro de Notificaciones</h5>
      <p class="muted">
        Seleccionados: {{ selectedIncompleteProviderIds.length }} proveedor(es). El mensaje se autocompleta según los faltantes detectados.
      </p>
      <div class="incomplete-notify__form">
        <div class="incomplete-notify__field">
          <label>Título</label>
          <input
            type="text"
            [(ngModel)]="incompleteNotifTitle"
            placeholder="Ej: Completa tu perfil profesional"
          />
        </div>
        <div class="incomplete-notify__field">
          <label>Mensaje</label>
          <textarea
            rows="5"
            [(ngModel)]="incompleteNotifMessage"
            placeholder="Incluye &#123;&#123;faltantes&#125;&#125; y &#123;&#123;link_perfil&#125;&#125; si quieres texto dinámico."
          ></textarea>
          <p class="muted">Tip: puedes usar {{'{{faltantes}}'}} y {{'{{link_perfil}}'}} en el texto.</p>
        </div>
        <div class="incomplete-notify__actions">
          <button
            type="button"
            class="btn-primary"
            (click)="sendIncompleteProfilesNotification()"
            [disabled]="incompleteNotifSending || !selectedIncompleteProviderIds.length"
          >
            {{ incompleteNotifSending ? 'Enviando…' : 'Enviar notificación' }}
          </button>
        </div>
        <p *ngIf="incompleteNotifSuccess" class="founder-card__status founder-card__status--success">{{ incompleteNotifSuccess }}</p>
        <p *ngIf="incompleteNotifError" class="founder-card__status founder-card__status--error">{{ incompleteNotifError }}</p>
      </div>
    </div>
  </div>
  <!-- Drawer simple de pago -->
  <div *ngIf="payRow" class="pay-drawer">
    <h3>Pagar a {{ payRow.provider_name || payRow.provider_email }}</h3>
    <div class="grid">
      <div><strong>Banco:</strong> {{ payRow.bank_name || '-' }}</div>
      <div><strong>Cuenta:</strong> {{ payRow.bank_account || (payRow.bank_last4 ? ('•••• ' + payRow.bank_last4) : '-') }} ({{ payRow.account_type || '—' }})</div>
      <div><strong>Titular:</strong> {{ payRow.account_holder || '-' }}</div>
      <div><strong>Monto a transferir:</strong> {{ payRow.provider_amount | number:'1.0-0' }} {{ payRow.currency }}</div>
    </div>
    <div class="row">
      <label>Referencia</label>
      <input type="text" [(ngModel)]="payRef" placeholder="Número/Texto de referencia" />
    </div>
    <div class="row">
      <label>Voucher</label>
      <input type="file" (change)="onVoucherSelected($event)" accept="image/*,application/pdf" />
    </div>
    <div class="actions">
      <button class="btn-primary" (click)="confirmPay()">Confirmar pago</button>
      <button (click)="payRow=null">Cancelar</button>
    </div>
  </div>
</div>


