<div class="admin-pagos">
  <h2>Administración de Pagos</h2>

  <div class="filters">
    <label>Rango:</label>
    <select #rangeSel (change)="0">
      <option value="day">Hoy</option>
      <option value="week">Esta semana</option>
      <option value="month">Este mes</option>
      <option value="all">Todo</option>
    </select>
    <button (click)="applyRange(rangeSel.value)">Aplicar</button>
    <button (click)="exportCsv()">Export CSV</button>
  </div>

  <app-admin-summary-cards [summary]="summary"></app-admin-summary-cards>

  <div *ngIf="!adminSecret" style="margin:12px 0;">
    <label>Admin Secret</label>
    <input type="password" [(ngModel)]="adminSecret" placeholder="Pega el ADMIN_PANEL_SECRET" />
    <button class="btn-primary" (click)="setSecretAndLoad()">Acceder</button>
  </div>

  <div *ngIf="error" class="error-message">{{ error }}</div>
  <div *ngIf="loading">Cargando...</div>

  <app-admin-payments-table [rows]="rows" (action)="onTableAction($event)"></app-admin-payments-table>

  <!-- Tabla de Devoluciones -->
  <div style="margin-top:16px;">
    <h3>Devoluciones</h3>
    <table class="table" *ngIf="refunds?.length; else noRefunds">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Servicio</th>
          <th>Cliente</th>
          <th>Teléfono</th>
          <th>Proveedor</th>
          <th>Método</th>
          <th>Monto pagado</th>
          <th>Monto a devolver (65%)</th>
          <th>Estado</th>
          <th>Motivo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of refunds">
          <td>{{ r.id }}</td>
          <td>{{ r.requested_at | date:'short' }}</td>
          <td>{{ r.service_name || '-' }}</td>
          <td>{{ r.client_email }}</td>
          <td>{{ r.client_phone || '-' }}</td>
          <td>{{ r.provider_email }}</td>
          <td>{{ r.payment_method || '-' }}</td>
          <td>{{ (r.original_amount || r.amount || 0) | number:'1.0-0' }} {{ r.currency || 'CLP' }}</td>
          <td><strong>{{ (r.refund_proposed_amount || 0) | number:'1.0-0' }} {{ r.currency || 'CLP' }}</strong></td>
          <td>{{ r.status }}</td>
          <td>{{ r.reason }}</td>
          <td>
            <ng-container *ngIf="refundPayRow?.id !== r.id; else refundPayForm">
              <button (click)="decideRefund(r, 'approved')" [disabled]="r.status!=='requested' && r.status!=='in_review'">Aprobar</button>
              <button (click)="decideRefund(r, 'denied')" [disabled]="r.status!=='requested' && r.status!=='in_review'">Denegar</button>
              <button *ngIf="r.status==='approved'" (click)="openRefundPay(r)">Pagar</button>
            </ng-container>
            <ng-template #refundPayForm>
              <div class="pay-drawer">
                <h4>Pagar devolución a {{ r.client_email }}</h4>
                <div class="grid">
                  <div><strong>Método:</strong> {{ r.payment_method || '-' }}</div>
                  <div><strong>Monto a devolver:</strong> {{ (r.refund_proposed_amount || 0) | number:'1.0-0' }} {{ r.currency || 'CLP' }}</div>
                </div>
                <div class="row">
                  <label>Referencia</label>
                  <input type="text" [(ngModel)]="refundPayRef" placeholder="Número/Texto de referencia" />
                </div>
                <div class="row">
                  <label>Voucher</label>
                  <input type="file" (change)="onRefundVoucherSelected($event)" accept="image/*,application/pdf" />
                </div>
                <div class="actions">
                  <button class="btn-primary" (click)="confirmRefundPay(r)">Confirmar pago</button>
                  <button (click)="refundPayRow=null">Cancelar</button>
                </div>
              </div>
            </ng-template>
          </td>
        </tr>
      </tbody>
    </table>
    <ng-template #noRefunds>
      <p style="color:#64748b;margin:8px 0 0 4px;">No hay solicitudes de devolución.</p>
    </ng-template>
  </div>
  <!-- Drawer simple de pago -->
  <div *ngIf="payRow" class="pay-drawer">
    <h3>Pagar a {{ payRow.provider_name || payRow.provider_email }}</h3>
    <div class="grid">
      <div><strong>Banco:</strong> {{ payRow.bank_name || '-' }}</div>
      <div><strong>Cuenta:</strong> {{ payRow.bank_account || (payRow.bank_last4 ? ('•••• ' + payRow.bank_last4) : '-') }} ({{ payRow.account_type || '—' }})</div>
      <div><strong>Titular:</strong> {{ payRow.account_holder || '-' }}</div>
      <div><strong>Monto a transferir:</strong> {{ payRow.provider_amount | number:'1.0-0' }} {{ payRow.currency }}</div>
    </div>
    <div class="row">
      <label>Referencia</label>
      <input type="text" [(ngModel)]="payRef" placeholder="Número/Texto de referencia" />
    </div>
    <div class="row">
      <label>Voucher</label>
      <input type="file" (change)="onVoucherSelected($event)" accept="image/*,application/pdf" />
    </div>
    <div class="actions">
      <button class="btn-primary" (click)="confirmPay()">Confirmar pago</button>
      <button (click)="payRow=null">Cancelar</button>
    </div>
  </div>
</div>


