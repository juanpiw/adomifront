<!-- Alerta de actualización de plan -->
<plan-upgrade-alert 
  [planInfo]="planInfo" 
  [show]="showPlanAlert"
  (upgrade)="onPlanUpgrade()"
  (dismiss)="onPlanAlertDismiss()">
</plan-upgrade-alert>

<app-golden-invite-modal
  [isOpen]="showGoldenInviteModal"
  [summary]="goldenInviteSummary"
  (close)="dismissGoldenInviteModal()"
  (primaryAction)="onGoldenInvitePrimary()">
</app-golden-invite-modal>

<div class="verification-modal-backdrop" *ngIf="showVerificationPrompt">
  <div class="verification-modal">
    <div class="verification-modal__icon">
      <ui-icon name="shield-check"></ui-icon>
    </div>
    <h3>Verifica tu identidad</h3>
    <p>Sube tu cédula para mostrar la insignia de confianza en tu perfil y aumentar tus conversiones.</p>
    <p *ngIf="verificationRejectionReason" class="verification-modal__reason">
      Último intento: {{ verificationRejectionReason }}
    </p>
    <div class="verification-modal__actions">
      <button type="button" class="btn-primary" (click)="goToVerification()">Iniciar verificación</button>
      <button type="button" class="btn-secondary" (click)="dismissVerificationPrompt()">Más tarde</button>
    </div>
  </div>
</div>

<div class="dash-layout" [class.sidebar-collapsed]="isCollapsed">
  <div class="tbk-blocker" *ngIf="tbkBlockingActive">
    <div class="tbk-blocker__backdrop"></div>
    <div class="tbk-blocker__modal">
      <button type="button" class="tbk-blocker__close" (click)="dismissTbkBlocker()" aria-label="Cerrar">×</button>
      <div class="tbk-blocker__icon">⚠️</div>
      <h3 class="tbk-blocker__title">Activa tus pagos con Webpay Mall</h3>
      <p class="tbk-blocker__message">
        Para aceptar reservas pagadas necesitas crear tu comercio secundario en Transbank. Este paso es obligatorio para continuar operando en Adomi.
      </p>
      <button type="button" class="tbk-blocker__cta" (click)="onForceTbkSetup()">Ir a configurar ahora</button>
      <p class="tbk-blocker__helper">Te enviaremos directamente a la sección de ingresos para completar el registro.</p>
    </div>
  </div>
  <aside class="sidebar" [class.collapsed]="isCollapsed">
    <div class="rail">
      <button class="rail-toggle" (click)="isCollapsed = !isCollapsed" title="Contraer/Expandir">
        <ui-icon [name]="isCollapsed ? 'chevron-right' : 'chevron-left'" [size]="18"></ui-icon>
      </button>
      <a class="rail-item" routerLink="/dash/home" routerLinkActive="active" title="Inicio" (click)="onNav()"><ui-icon name="home" [size]="20"></ui-icon></a>
      <a class="rail-item" routerLink="/dash/agenda" routerLinkActive="active" title="Agenda" (click)="onNav()" style="position: relative;">
        <ui-icon name="calendar" [size]="20"></ui-icon>
        <span *ngIf="pendingAppointmentsCount > 0" class="badge-unread badge-appointment">{{ pendingAppointmentsCount }}</span>
      </a>
      <a class="rail-item" routerLink="/dash/ingresos" routerLinkActive="active" title="Ingresos" (click)="onNav()"><ui-icon name="money" [size]="20"></ui-icon></a>
      <a *ngIf="hasQuotesFeature" class="rail-item" routerLink="/dash/cotizaciones" routerLinkActive="active" title="Cotizaciones" (click)="onNav()">
        <ui-icon name="file-text" [size]="20"></ui-icon>
      </a>
      <a *ngIf="isAdmin" class="rail-item" routerLink="/dash/admin-pagos" routerLinkActive="active" title="Admin Pagos" (click)="onNav()" style="position:relative;">
        <ui-icon name="user" [size]="20"></ui-icon>
        <span *ngIf="adminPendingCount > 0" class="badge-unread" style="position:absolute; top:-6px; right:-6px;">{{ adminPendingCount }}</span>
      </a>
      <a class="rail-item" routerLink="/dash/estadisticas" routerLinkActive="active" title="Estadísticas" (click)="onNav()"><ui-icon name="chart" [size]="20"></ui-icon></a>
      <a *ngIf="showPromotionsMenu" class="rail-item" routerLink="/dash/promocion" routerLinkActive="active" title="Promoción" (click)="onNav()"><ui-icon name="star" [size]="20"></ui-icon></a>
      <a class="rail-item" routerLink="/dash/mensajes" routerLinkActive="active" title="Mensajes" (click)="onNav()" style="position: relative;">
        <ui-icon name="message" [size]="20"></ui-icon>
        <span *ngIf="unreadTotal > 0" class="badge-unread">{{ unreadTotal }}</span>
      </a>
      <a class="rail-item" routerLink="/dash/servicios" routerLinkActive="active" title="Servicios" (click)="onNav()"><ui-icon name="briefcase" [size]="20"></ui-icon></a>
      <a class="rail-item" routerLink="/dash/soporte" routerLinkActive="active" title="Soporte" (click)="onNav()"><ui-icon name="help-circle" [size]="20"></ui-icon></a>
      <a class="rail-item" routerLink="/dash/perfil" routerLinkActive="active" title="Perfil" (click)="onNav()"><ui-icon name="user" [size]="20"></ui-icon></a>
      <div class="spacer"></div>
      <a class="rail-item" (click)="logout()" title="Salir" style="cursor: pointer;"><ui-icon name="logout" [size]="20"></ui-icon></a>
    </div>
    <div class="panel elevated">
      <div class="user-summary">
        <div style="position: relative; display: inline-block;">
          <img 
            class="avatar" 
            [class.avatar--new-appointment]="hasNewAppointment"
            [src]="providerAvatarUrl || '/assets/default-avatar.png'" 
            alt="Avatar" 
            (error)="onAvatarError($event)" />
          <span class="status-dot" [class.online]="isOnline === true" [class.offline]="isOnline === false"></span>
          <!-- Badge de alerta sobre el avatar -->
          <span *ngIf="hasNewAppointment" class="avatar-alert-badge">
            <ui-icon name="bell" [size]="12"></ui-icon>
          </span>
        </div>
        <div class="user-info">
          <div class="user-name">{{ providerName || 'Usuario' }}</div>
          <div class="user-sub">Cuenta de profesional</div>
          <div *ngIf="isFounderAccount" class="user-sub-badge founder-badge">Cuenta Fundador</div>
          <div *ngIf="isPioneer" class="user-sub-badge pioneer-badge">Pionero</div>
          <div *ngIf="planTierInfo" class="plan-tier-tag" [ngClass]="'plan-tier-tag--' + planTierInfo.variant">
            <span class="plan-tier-tag__chip">{{ planTierInfo.chip }}</span>
            <span class="plan-tier-tag__detail">{{ planTierInfo.detail }}</span>
            <ng-container *ngIf="planProgress">
              <div class="plan-progress" [attr.title]="planProgress.remainingLabel">
                <div class="plan-progress__remaining">{{ planProgress.remainingLabel }}</div>
                <div class="plan-progress__dates">
                  <span>{{ planProgress.startLabel }}</span>
                  <span>{{ planProgress.endLabel }}</span>
                </div>
                <div class="plan-progress__bar">
                  <div class="plan-progress__fill" [style.width.%]="planProgress.percent"></div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
      <!-- Switch de estado online -->
      <div style="padding: 0 0 12px 0;">
        <app-online-status-switch [isOnline]="!!isOnline" (statusChange)="onOnlineToggle($event)"></app-online-status-switch>
      </div>
      <nav class="menu">
        <a routerLink="/dash/home" routerLinkActive="active" (click)="onNav()"><ui-icon name="home"></ui-icon><span>Inicio</span></a>
        <a routerLink="/dash/agenda" routerLinkActive="active" (click)="onNav()"><ui-icon name="calendar"></ui-icon><span>Agenda</span></a>
        <a routerLink="/dash/ingresos" routerLinkActive="active" (click)="onNav()"><ui-icon name="money"></ui-icon><span>Ingresos</span></a>
        <a routerLink="/auth/select-plan" (click)="goToSelectPlan($event)">
          <ui-icon name="credit-card"></ui-icon><span>Cambiar plan</span>
        </a>
      <a *ngIf="hasQuotesFeature" routerLink="/dash/cotizaciones" routerLinkActive="active" (click)="onNav()">
        <ui-icon name="file-text"></ui-icon>
        <span>Cotizaciones</span>
      </a>
        <a *ngIf="isAdmin" routerLink="/dash/admin-pagos" routerLinkActive="active" (click)="onNav()" style="position:relative;">
          <ui-icon name="user"></ui-icon><span>Admin Pagos</span>
          <span *ngIf="adminPendingCount > 0" class="badge-unread" style="position:absolute; right:12px;">{{ adminPendingCount }}</span>
        </a>
        <a routerLink="/dash/estadisticas" routerLinkActive="active" (click)="onNav()"><ui-icon name="chart"></ui-icon><span>Estadísticas</span></a>
        <a routerLink="/dash/mensajes" routerLinkActive="active" (click)="onNav()"><ui-icon name="message"></ui-icon><span>Mensajes</span></a>
        <a routerLink="/dash/servicios" routerLinkActive="active" (click)="onNav()"><ui-icon name="briefcase"></ui-icon><span>Mis Servicios</span></a>
        <a routerLink="/dash/soporte" routerLinkActive="active" (click)="onNav()"><ui-icon name="help-circle"></ui-icon><span>Soporte</span></a>
        <a *ngIf="showPromotionsMenu" routerLink="/dash/promocion" routerLinkActive="active" (click)="onNav()"><ui-icon name="star"></ui-icon><span>Promoción</span></a>
        <a routerLink="/dash/perfil" routerLinkActive="active" (click)="onNav()"><ui-icon name="user"></ui-icon><span>Mi Perfil</span></a>
      </nav>
      <div class="footer">
        <a routerLink="/dash/terminos" class="footer-link" (click)="onNav()">Términos y Condiciones</a>
        <theme-switch size="sm"></theme-switch>
      </div>
    </div>
  </aside>
  <main class="content">
    <app-topbar 
      [config]="topbarConfig"
      [cashNotice]="cashNotice"
      (hamburgerClick)="isCollapsed = !isCollapsed"
      (helpClick)="onHelpClick($event)"
      (notificationClick)="onNotificationClick($event)"
      (settingsClick)="onSettingsClick()">
    </app-topbar>
    <div class="main-slot">
      <div *ngIf="verificationBanner" class="verification-banner" [ngClass]="{
        'verification-banner--info': verificationBanner.variant === 'info',
        'verification-banner--warning': verificationBanner.variant === 'warning',
        'verification-banner--danger': verificationBanner.variant === 'danger'
      }">
        <div class="verification-banner__message">{{ verificationBanner.message }}</div>
        <button *ngIf="verificationBanner.actionLabel" type="button" (click)="onVerificationBannerAction()">
          {{ verificationBanner.actionLabel }}
        </button>
      </div>
      <router-outlet></router-outlet>
    </div>
  </main>
</div>
